diff --git a/src/filters/mux_isom.c b/src/filters/mux_isom.c
index 57e9e7834..ed768753c 100644
--- a/src/filters/mux_isom.c
+++ b/src/filters/mux_isom.c
@@ -4881,9 +4881,8 @@ static GF_Err mp4_mux_process_sample(GF_MP4MuxCtx *ctx, TrackWriter *tkw, GF_Fil
 					e = gf_isom_fragment_append_data(ctx->file, tkw->track_id, inband_xps, inband_xps_size, 0);
 				}
 				if (!e) {
-					if (gf_filter_pck_is_blocking_ref(pck)) {
-						e = gf_isom_fragment_append_data(ctx->file, tkw->track_id, pck_data, pck_data_len, 0);
-					} else {
+					/* Always use append_data_ex to avoid buffering/copying large sample data in the isom layer */
+					{
 						gf_filter_pck_ref(&pck);
 						GF_FilterPacket *ref = pck;
 						e = gf_isom_fragment_append_data_ex(ctx->file, tkw->track_id, pck_data, pck_data_len, 0, (void**)&ref, au_delim ? au_delim_size : 0);
@@ -4907,17 +4906,14 @@ static GF_Err mp4_mux_process_sample(GF_MP4MuxCtx *ctx, TrackWriter *tkw, GF_Fil
 			insert_subsample_dsi_size = inband_xps_size;
 		} else if (for_fragment) {
 #ifndef GPAC_DISABLE_ISOM_FRAGMENTS
-			if (gf_filter_pck_is_blocking_ref(pck)) {
-				e = gf_isom_fragment_add_sample(ctx->file, tkw->track_id, &tkw->sample, sample_desc_index, duration, 0, 0, 0);
+			/* Always use add_sample_ex to allow reference-based sample data (avoid extra copies / OOM) */
+			gf_filter_pck_ref(&pck);
+			GF_FilterPacket *ref = pck;
+			e = gf_isom_fragment_add_sample_ex(ctx->file, tkw->track_id, &tkw->sample, sample_desc_index, duration, 0, 0, 0, (void**) &ref, 0);
+			if (!ref) {
+				gf_list_add(ctx->ref_pcks, pck);
 			} else {
-				gf_filter_pck_ref(&pck);
-				GF_FilterPacket *ref = pck;
-				e = gf_isom_fragment_add_sample_ex(ctx->file, tkw->track_id, &tkw->sample, sample_desc_index, duration, 0, 0, 0, (void**) &ref, 0);
-				if (!ref) {
-					gf_list_add(ctx->ref_pcks, pck);
-				} else {
-					gf_filter_pck_unref(pck);
-				}
+				gf_filter_pck_unref(pck);
 			}
 #else
 			e = GF_NOT_SUPPORTED;
diff --git a/src/isomedia/movie_fragments.c b/src/isomedia/movie_fragments.c
index b7f7ade32..b14aea044 100644
--- a/src/isomedia/movie_fragments.c
+++ b/src/isomedia/movie_fragments.c
@@ -559,6 +559,8 @@ void update_trun_offsets(GF_ISOFile *movie, s32 offset)
 #endif
 }
 
+static void moof_unregister_trun(GF_ISOFile *movie, GF_TrackFragmentRunBox *trun);
+
 static
 u32 UpdateRuns(GF_ISOFile *movie, GF_TrackFragmentBox *traf)
 {
@@ -591,6 +593,7 @@ u32 UpdateRuns(GF_ISOFile *movie, GF_TrackFragmentBox *traf)
 		while (gf_list_count(traf->TrackRuns)) {
 			trun = (GF_TrackFragmentRunBox *)gf_list_get(traf->TrackRuns, 0);
 			gf_list_rem(traf->TrackRuns, 0);
+			moof_unregister_trun(movie, trun);
 			gf_isom_box_del_parent(&traf->child_boxes, (GF_Box *)trun);
 		}
 		traf->tfhd->flags |= GF_ISOM_TRAF_DUR_EMPTY;
@@ -642,7 +645,9 @@ u32 UpdateRuns(GF_ISOFile *movie, GF_TrackFragmentBox *traf)
 		//empty list
 		if (!first_ent) {
 			i--;
+			moof_unregister_trun(movie, trun);
 			gf_list_rem(traf->TrackRuns, i);
+			gf_isom_box_del_parent(&traf->child_boxes, (GF_Box *)trun);
 			continue;
 		}
 		trun->flags = 0;
@@ -926,25 +931,38 @@ static u64 moof_get_earliest_cts(GF_MovieFragmentBox *moof, GF_ISOTrackID refTra
 
 GF_Err gf_isom_write_compressed_box(GF_ISOFile *mov, GF_Box *root_box, u32 repl_type, GF_BitStream *bs, u32 *box_csize);
 
+static void moof_unregister_trun(GF_ISOFile *movie, GF_TrackFragmentRunBox *trun)
+{
+	if (!movie || !movie->moof || !movie->moof->trun_list || !trun) return;
+	gf_list_del_item(movie->moof->trun_list, trun);
+}
+
 void flush_ref_samples(GF_ISOFile *movie, u64 *out_seg_size, Bool use_seg_marker)
 {
 	u32 i=0;
+	if (!movie || !movie->moof || !movie->moof->trun_list) return;
 	if (movie->in_sidx_write) return;
 	u32 trun_count = gf_list_count(movie->moof->trun_list);
 	for (i=0; i<trun_count; i++) {
 		GF_TrackFragmentRunBox *trun = gf_list_get(movie->moof->trun_list, i);
+		if (!trun || !trun->sample_refs) continue;
 		u32 s_count = gf_list_count(trun->sample_refs);
 		while (s_count) {
 			if (!use_seg_marker && movie->on_last_block_start && (i+1==trun_count) && (s_count==1)) {
 				movie->on_last_block_start(movie->on_block_out_usr_data);
 			}
 			GF_TrafSampleRef *sref = gf_list_pop_front(trun->sample_refs);
+			if (!sref) break;
 			movie->on_block_out(movie->on_block_out_usr_data, sref->data, sref->len, sref->ref, sref->ref_offset);
 			if (out_seg_size) *out_seg_size += sref->len;
 			if (!sref->ref) gf_free(sref->data);
 			gf_free(sref);
 			s_count--;
 		}
+		if (!gf_list_count(trun->sample_refs)) {
+			gf_list_del(trun->sample_refs);
+			trun->sample_refs = NULL;
+		}
 	}
 }
 
@@ -1139,9 +1157,14 @@ static GF_Err StoreFragment(GF_ISOFile *movie, Bool load_mdat_only, s32 data_off
 		s_count = UpdateRuns(movie, traf);
 		//empty fragment destroy it
 		if (!traf->tfhd->EmptyDuration && !s_count) {
-			i--;
-			gf_list_rem(movie->moof->TrackList, i);
-			gf_isom_box_del_parent(&movie->moof->child_boxes, (GF_Box *) traf);
+				u32 k = 0;
+				GF_TrackFragmentRunBox *t;
+				while ((t = (GF_TrackFragmentRunBox*)gf_list_enum(traf->TrackRuns, &k))) {
+					moof_unregister_trun(movie, t);
+				}
+				i--;
+				gf_list_rem(movie->moof->TrackList, i);
+				gf_isom_box_del_parent(&movie->moof->child_boxes, (GF_Box *) traf);
 			continue;
 		}
 	}
@@ -2914,13 +2937,20 @@ GF_Err gf_isom_fragment_add_sample_ex(GF_ISOFile *movie, GF_ISOTrackID TrackID,
 					sref->ref_offset = ref_offset;
 					*ref = NULL;
 				} else {
-					sref->data = gf_malloc(sample->dataLength);
-					if (!sref->data) {
-						gf_free(sref);
-						return GF_OUT_OF_MEM;
-					}
-					memcpy(sref->data, sample->data, sample->dataLength);
-					sref->len = sample->dataLength;
+					if (od_sample) {
+							sref->data = od_sample->data;
+							sref->len = od_sample->dataLength;
+							od_sample->data = NULL;
+							od_sample->dataLength = 0;
+						} else {
+							sref->data = gf_malloc(sample->dataLength);
+							if (!sref->data) {
+								gf_free(sref);
+								return GF_OUT_OF_MEM;
+							}
+							memcpy(sref->data, sample->data, sample->dataLength);
+							sref->len = sample->dataLength;
+						}
 				}
 				res = sref->len;
 				traf->trun_ref_size += res;