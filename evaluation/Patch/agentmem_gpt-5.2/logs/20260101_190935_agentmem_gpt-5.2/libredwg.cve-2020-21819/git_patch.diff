diff --git a/programs/escape.c b/programs/escape.c
index 8a907414..34aac81f 100644
--- a/programs/escape.c
+++ b/programs/escape.c
@@ -23,95 +23,168 @@
 #include "common.h"
 #include "escape.h"
 
+/* Ensure DEST has room for NEED more bytes (+ trailing NUL). Updates DEST/LEN/D.
+   Returns 0 on success, -1 on OOM (and frees DEST). */
+static int
+ensure_room (char **dest, size_t *len, char **d, const size_t need)
+{
+  size_t off = (size_t)(*d - *dest);
+  if (off + need + 1 <= *len)
+    return 0;
+
+  size_t newlen = *len;
+  if (newlen < 16)
+    newlen = 16;
+  while (off + need + 1 > newlen)
+    newlen += 16;
+
+  char *newdest = (char *)realloc (*dest, newlen);
+  if (!newdest)
+    {
+      free (*dest);
+      *dest = NULL;
+      *d = NULL;
+      *len = 0;
+      return -1;
+    }
+  *dest = newdest;
+  *d = newdest + off;
+  *len = newlen;
+  return 0;
+}
+
 char * ATTRIBUTE_MALLOC
 htmlescape (const char *restrict src, const int cp)
 {
-  int len;
+  size_t len;
   char *dest, *d;
-  unsigned char *s;
+  const unsigned char *s;
+
   if (!src)
     return NULL;
-  len = strlen (src) + 10;
-  d = malloc (len);
-  s = (unsigned char *)src;
-  dest = d;
-  while (*s++)
+  (void)cp;
+
+  /* Start with a small slack, then grow as needed. */
+  len = strlen (src) + 16;
+  dest = (char *)malloc (len);
+  if (!dest)
+    return NULL;
+  d = dest;
+  s = (const unsigned char *)src;
+
+  while (*s)
     {
-      const int off = d - dest;
-      if (off >= len - 8)
-        {
-          len += 10;
-          dest = realloc (dest, len);
-          d = dest + off;
-        }
-      switch (*s)
+      const unsigned char c = *s++;
+      const char *rep = NULL;
+      size_t rep_len = 0;
+      char tmp[16];
+
+      switch (c)
         {
-        case '"': strcat (d, "&quot;"); d += 6; break;
-        case '\'': strcat (d, "&#39;"); d += 5; break;
-        case '`': strcat (d, "&#96;"); d += 5; break;
-        case '&': strcat (d, "&amp;"); d += 5; break;
-        case '<': strcat (d, "&lt;"); d += 4; break;
-        case '>': strcat (d, "&gt;"); d += 4; break;
-        case '{': strcat (d, "&#123;"); d += 6; break;
-        case '}': strcat (d, "&#125;"); d += 6; break;
+        case '"': rep = "&quot;"; rep_len = 6; break;
+        case '\'': rep = "&#39;"; rep_len = 5; break;
+        case '`': rep = "&#96;"; rep_len = 5; break;
+        case '&': rep = "&amp;"; rep_len = 5; break;
+        case '<': rep = "&lt;"; rep_len = 4; break;
+        case '>': rep = "&gt;"; rep_len = 4; break;
+        case '{': rep = "&#123;"; rep_len = 6; break;
+        case '}': rep = "&#125;"; rep_len = 6; break;
         default:
-          if (*s >= 127) // maybe encodings, no utf8 (see htmlwescape)
+          if (c >= 127) /* maybe encodings, no utf8 (see htmlwescape) */
+            {
+              int n = snprintf (tmp, sizeof (tmp), "&#x%X;", (unsigned)c);
+              if (n > 0 && (size_t)n < sizeof (tmp))
+                {
+                  rep = tmp;
+                  rep_len = (size_t)n;
+                }
+            }
+          else if (c >= 20)
             {
-              sprintf (d, "&#x%X;", *s); // 4 + 4
-              d += strlen (d);
+              if (ensure_room (&dest, &len, &d, 1) < 0)
+                return NULL;
+              *d++ = (char)c;
             }
-          else if (*s >= 20)
-            *d++ = *s;
+          break;
+        }
+
+      if (rep_len)
+        {
+          if (ensure_room (&dest, &len, &d, rep_len) < 0)
+            return NULL;
+          memcpy (d, rep, rep_len);
+          d += rep_len;
         }
     }
-  *d = 0;
+
+  *d = '\0';
   return dest;
 }
 
 char * ATTRIBUTE_MALLOC
 htmlwescape (BITCODE_TU wstr)
 {
-  int len = 0;
+  size_t len = 0;
   char *dest, *d;
   BITCODE_TU tmp = wstr;
   BITCODE_RS c;
 
   if (!wstr)
     return NULL;
+
   while ((c = *tmp++))
     len++;
   len += 16;
-  d = dest = malloc (len);
 
-  while (*wstr++)
+  dest = (char *)malloc (len);
+  if (!dest)
+    return NULL;
+  d = dest;
+
+  while ((c = *wstr++))
     {
-      const int off = d - dest;
-      if (off >= len - 8)
-        {
-          len += 16;
-          dest = realloc (dest, len);
-          d = dest + off;
-        }
-      switch (*wstr)
+      const char *rep = NULL;
+      size_t rep_len = 0;
+      char tmp2[32];
+
+      switch (c)
         {
-        case 34: strcat (d, "&quot;"); d += 6; break;
-        case 39: strcat (d, "&#39;"); d += 5; break;
-        case 38: strcat (d, "&amp;"); d += 5; break;
-        case 60: strcat (d, "&lt;"); d += 4; break;
-        case 62: strcat (d, "&gt;"); d += 4; break;
-        case 96: strcat (d, "&#96;"); d += 5; break;
-        case 123: strcat (d, "&#123;"); d += 6; break;
-        case 125: strcat (d, "&#125;"); d += 6; break;
+        case 34: rep = "&quot;"; rep_len = 6; break;
+        case 39: rep = "&#39;"; rep_len = 5; break;
+        case 38: rep = "&amp;"; rep_len = 5; break;
+        case 60: rep = "&lt;"; rep_len = 4; break;
+        case 62: rep = "&gt;"; rep_len = 4; break;
+        case 96: rep = "&#96;"; rep_len = 5; break;
+        case 123: rep = "&#123;"; rep_len = 6; break;
+        case 125: rep = "&#125;"; rep_len = 6; break;
         default:
-          if (*wstr >= 127) // utf8 encodings
+          if (c >= 127) /* utf8 encodings */
+            {
+              int n = snprintf (tmp2, sizeof (tmp2), "&#x%X;", (unsigned)c);
+              if (n > 0 && (size_t)n < sizeof (tmp2))
+                {
+                  rep = tmp2;
+                  rep_len = (size_t)n;
+                }
+            }
+          else if (c >= 20)
             {
-              sprintf (d, "&#x%X;", *wstr);
-              d += strlen (d);
+              if (ensure_room (&dest, &len, &d, 1) < 0)
+                return NULL;
+              *d++ = (char)c;
             }
-          else if (*wstr >= 20)
-            *d++ = *wstr;
+          break;
+        }
+
+      if (rep_len)
+        {
+          if (ensure_room (&dest, &len, &d, rep_len) < 0)
+            return NULL;
+          memcpy (d, rep, rep_len);
+          d += rep_len;
         }
     }
-  *d = 0;
+
+  *d = '\0';
   return dest;
 }