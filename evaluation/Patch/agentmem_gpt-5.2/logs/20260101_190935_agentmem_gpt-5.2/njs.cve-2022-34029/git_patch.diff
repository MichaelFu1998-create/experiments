diff --git a/src/njs_scope.h b/src/njs_scope.h
index 4164617..d38cea1 100644
--- a/src/njs_scope.h
+++ b/src/njs_scope.h
@@ -1,4 +1,3 @@
-
 /*
  * Copyright (C) Alexander Borisov
  * Copyright (C) NGINX, Inc.
@@ -12,7 +11,17 @@
 #define NJS_SCOPE_TYPE_OFFSET   (NJS_SCOPE_VAR_SIZE + 4)
 #define NJS_SCOPE_VALUE_OFFSET  (NJS_SCOPE_TYPE_OFFSET + 1)
 #define NJS_SCOPE_VALUE_MAX     ((1 << (32 - NJS_SCOPE_VALUE_OFFSET)) - 1)
-#define NJS_SCOPE_TYPE_MASK     ((NJS_SCOPE_VALUE_MAX) << NJS_SCOPE_VAR_SIZE)
+
+/*
+ * Scope index is a packed integer:
+ *   [ value (high bits) | type | var_type ]
+ *
+ * Use explicit masks (not bitwise negation) to avoid leaking high bits from
+ * malformed indices which could lead to out-of-range vm->levels[] access.
+ */
+#define NJS_SCOPE_VAR_MASK      (((njs_index_t) 1 << NJS_SCOPE_VAR_SIZE) - 1)
+#define NJS_SCOPE_TYPE_SIZE     (NJS_SCOPE_VALUE_OFFSET - NJS_SCOPE_VAR_SIZE)
+#define NJS_SCOPE_TYPE_MASK     (((njs_index_t) 1 << NJS_SCOPE_TYPE_SIZE) - 1)
 
 #define NJS_INDEX_NONE          ((njs_index_t) 0)
 #define NJS_INDEX_ERROR         ((njs_index_t) -1)
@@ -33,6 +42,14 @@ njs_scope_index(njs_scope_t scope, njs_index_t index, njs_level_type_t type,
     njs_assert(type < NJS_LEVEL_MAX);
     njs_assert(scope == NJS_SCOPE_GLOBAL || scope == NJS_SCOPE_FUNCTION);
 
+    if (njs_slow_path(type >= NJS_LEVEL_MAX)) {
+        return NJS_INDEX_ERROR;
+    }
+
+    if (njs_slow_path(scope != NJS_SCOPE_GLOBAL && scope != NJS_SCOPE_FUNCTION)) {
+        return NJS_INDEX_ERROR;
+    }
+
     if (index > NJS_SCOPE_VALUE_MAX) {
         return NJS_INDEX_ERROR;
     }
@@ -49,7 +66,7 @@ njs_scope_index(njs_scope_t scope, njs_index_t index, njs_level_type_t type,
 njs_inline njs_variable_type_t
 njs_scope_index_var(njs_index_t index)
 {
-    return (njs_variable_type_t) (index & ~NJS_SCOPE_TYPE_MASK);
+    return (njs_variable_type_t) (index & NJS_SCOPE_VAR_MASK);
 }
 
 
@@ -57,7 +74,7 @@ njs_inline njs_level_type_t
 njs_scope_index_type(njs_index_t index)
 {
     return (njs_level_type_t) ((index >> NJS_SCOPE_VAR_SIZE)
-                               & ~NJS_SCOPE_TYPE_MASK);
+                               & NJS_SCOPE_TYPE_MASK);
 }
 
 
@@ -71,8 +88,49 @@ njs_scope_index_value(njs_index_t index)
 njs_inline njs_value_t *
 njs_scope_value(njs_vm_t *vm, njs_index_t index)
 {
-    return vm->levels[njs_scope_index_type(index)]
-                     [njs_scope_index_value(index)];
+    njs_value_t      **level;
+    njs_level_type_t type;
+    uint32_t         i;
+
+    /*
+     * Defensive checks: indices are expected to be created by njs_scope_index(),
+     * but malformed bytecode/fuzzing may feed arbitrary values.
+     */
+    if (njs_slow_path(index == NJS_INDEX_NONE || index == NJS_INDEX_ERROR)) {
+        njs_set_invalid(&vm->retval);
+        return &vm->retval;
+    }
+
+    type = njs_scope_index_type(index);
+
+    if (njs_slow_path(type >= NJS_LEVEL_MAX)) {
+        njs_set_invalid(&vm->retval);
+        return &vm->retval;
+    }
+
+    level = vm->levels[type];
+    if (njs_slow_path(level == NULL)) {
+        njs_set_invalid(&vm->retval);
+        return &vm->retval;
+    }
+
+    i = njs_scope_index_value(index);
+
+    /* Best-effort bounds checks for levels whose sizes are tracked in vm. */
+    if (njs_slow_path(type == NJS_LEVEL_GLOBAL && i >= vm->global_items)) {
+        njs_set_invalid(&vm->retval);
+        return &vm->retval;
+    }
+
+    if (njs_slow_path(type == NJS_LEVEL_STATIC
+                      && (vm->scope_absolute == NULL
+                          || i >= vm->scope_absolute->items)))
+    {
+        njs_set_invalid(&vm->retval);
+        return &vm->retval;
+    }
+
+    return level[i];
 }
 
 
@@ -100,8 +158,39 @@ njs_scope_valid_value(njs_vm_t *vm, njs_index_t index)
 njs_inline void
 njs_scope_value_set(njs_vm_t *vm, njs_index_t index, njs_value_t *value)
 {
-    vm->levels[njs_scope_index_type(index)]
-              [njs_scope_index_value(index)] = value;
+    njs_value_t      **level;
+    njs_level_type_t type;
+    uint32_t         i;
+
+    if (njs_slow_path(index == NJS_INDEX_NONE || index == NJS_INDEX_ERROR)) {
+        return;
+    }
+
+    type = njs_scope_index_type(index);
+
+    if (njs_slow_path(type >= NJS_LEVEL_MAX)) {
+        return;
+    }
+
+    level = vm->levels[type];
+    if (njs_slow_path(level == NULL)) {
+        return;
+    }
+
+    i = njs_scope_index_value(index);
+
+    if (njs_slow_path(type == NJS_LEVEL_GLOBAL && i >= vm->global_items)) {
+        return;
+    }
+
+    if (njs_slow_path(type == NJS_LEVEL_STATIC
+                      && (vm->scope_absolute == NULL
+                          || i >= vm->scope_absolute->items)))
+    {
+        return;
+    }
+
+    level[i] = value;
 }
 
 
diff --git a/src/njs_shell.c b/src/njs_shell.c
index 237d6ba..88c47f7 100644
--- a/src/njs_shell.c
+++ b/src/njs_shell.c
@@ -346,7 +346,7 @@ njs_options_parse(njs_opts_t *opts, int argc, char **argv)
     ret = NJS_DONE;
 
     opts->denormals = 1;
-    opts->exit_code = EXIT_FAILURE;
+    opts->exit_code = EXIT_SUCCESS;
     opts->unhandled_rejection = NJS_VM_OPT_UNHANDLED_REJECTION_THROW;
 
     p = getenv("NJS_EXIT_CODE");