diff --git a/source/pdf/pdf-op-run.c b/source/pdf/pdf-op-run.c
index 44464f6e7..e855da48f 100644
--- a/source/pdf/pdf-op-run.c
+++ b/source/pdf/pdf-op-run.c
@@ -160,7 +160,7 @@ struct pdf_run_processor
 
 	int mc_depth;
 	int nest_depth;
-	int nest_mark[256];
+	int nest_mark[4096];
 };
 
 /* Forward definition */
@@ -211,6 +211,14 @@ flush_begin_layer(fz_context *ctx, pdf_run_processor *proc)
 
 static void nest_layer_clip(fz_context *ctx, pdf_run_processor *proc)
 {
+	/* nest_mark is a fixed-size stack. A crafted PDF can drive nesting beyond
+	 * its capacity via repeated clipping/marked-content transitions, which would
+	 * otherwise result in a 4-byte write just past the end of the heap allocated
+	 * pdf_run_processor.
+	 */
+	if (proc->nest_depth == nelem(proc->nest_mark))
+		fz_throw(ctx, FZ_ERROR_LIMIT, "layer/clip nesting too deep");
+
 	proc->nest_mark[proc->nest_depth++] = CLIP_MARK;
 }