diff --git a/src/njs_vmcode.c b/src/njs_vmcode.c
index ec47865..d855e85 100644
--- a/src/njs_vmcode.c
+++ b/src/njs_vmcode.c
@@ -797,8 +797,25 @@ next:
                 pnext = (njs_vmcode_prop_next_t *) pc;
                 retval = njs_scope_value(vm, pnext->retval);
 
+                /*
+                 * The foreach iterator is stored as an internal data value
+                 * holding njs_property_next_t*.  If bytecode/async resume
+                 * corrupts the slot, avoid dereferencing a garbage pointer.
+                 */
+                if (njs_slow_path(value2->type != NJS_DATA
+                                  || value2->data.u.next == NULL))
+                {
+                    njs_internal_error(vm, "invalid property iterator");
+                    goto error;
+                }
+
                 next = value2->data.u.next;
 
+                if (njs_slow_path(next->array == NULL)) {
+                    njs_internal_error(vm, "invalid property iterator array");
+                    goto error;
+                }
+
                 if (next->index < next->array->length) {
                     *retval = next->array->start[next->index++];
 
@@ -808,6 +825,11 @@ next:
 
                 njs_mp_free(vm->mem_pool, next);
 
+
+                /* Prevent accidental reuse of a freed iterator. */
+                value2->data.u.next = NULL;
+                value2->type = NJS_UNDEFINED;
+
                 ret = sizeof(njs_vmcode_prop_next_t);
                 break;
 
@@ -1426,11 +1448,20 @@ njs_vmcode_property_foreach(njs_vm_t *vm, njs_value_t *object,
     next->array = njs_value_enumerate(vm, object, NJS_ENUM_KEYS,
                                       NJS_ENUM_STRING, 0);
     if (njs_slow_path(next->array == NULL)) {
+        njs_mp_free(vm->mem_pool, next);
         njs_memory_error(vm);
         return NJS_ERROR;
     }
 
+    /*
+     * PROPERTY_FOREACH is a vmcode with retval: after this function returns,
+     * the interpreter stores vm->retval into the destination operand
+     * (prop_foreach->next). PROPERTY_NEXT then consumes that slot.
+     */
     vm->retval.data.u.next = next;
+    vm->retval.type = NJS_DATA;
+    vm->retval.data.magic32 = NJS_DATA_TAG_ANY;
+    vm->retval.data.truth = 1;
 
     code = (njs_vmcode_prop_foreach_t *) pc;