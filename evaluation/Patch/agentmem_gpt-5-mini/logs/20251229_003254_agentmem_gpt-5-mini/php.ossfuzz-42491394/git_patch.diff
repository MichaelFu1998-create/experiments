diff --git a/ext/spl/spl_observer.c b/ext/spl/spl_observer.c
index c83e8bf3a9f..e17381b0a8a 100644
--- a/ext/spl/spl_observer.c
+++ b/ext/spl/spl_observer.c
@@ -682,7 +682,7 @@ PHP_METHOD(SplObjectStorage, unserialize)
 	size_t buf_len;
 	const unsigned char *p, *s;
 	php_unserialize_data_t var_hash;
-	zval entry, inf;
+	zval *entry, *inf;
 	zval *pcount, *pmembers;
 	spl_SplObjectStorageElement *element;
 	zend_long count;
@@ -711,12 +711,23 @@ PHP_METHOD(SplObjectStorage, unserialize)
 
 	--p; /* for ';' */
 	count = Z_LVAL_P(pcount);
-	if (count < 0) {
-		goto outexcept;
-	}
+		if (count < 0) {
+			goto outexcept;
+		}
+
+		entry = var_tmp_var(&var_hash);
+		inf = var_tmp_var(&var_hash);
+		ZVAL_UNDEF(entry);
+		ZVAL_UNDEF(inf);
+
+		
+		entry = var_tmp_var(&var_hash);
+		inf = var_tmp_var(&var_hash);
+		ZVAL_UNDEF(entry);
+		ZVAL_UNDEF(inf);
 
-	ZVAL_UNDEF(&entry);
-	ZVAL_UNDEF(&inf);
+		
+	ZVAL_UNDEF(inf);
 
 	while (count-- > 0) {
 		spl_SplObjectStorageElement *pelement;
@@ -731,46 +742,48 @@ PHP_METHOD(SplObjectStorage, unserialize)
 			goto outexcept;
 		}
 		/* store reference to allow cross-references between different elements */
-		if (!php_var_unserialize(&entry, &p, s + buf_len, &var_hash)) {
-			zval_ptr_dtor(&entry);
+		if (!php_var_unserialize(entry, &p, s + buf_len, &var_hash)) {
+			zval_ptr_dtor(entry);
 			goto outexcept;
 		}
 		if (*p == ',') { /* new version has inf */
 			++p;
-			if (!php_var_unserialize(&inf, &p, s + buf_len, &var_hash)) {
-				zval_ptr_dtor(&entry);
-				zval_ptr_dtor(&inf);
+			if (!php_var_unserialize(inf, &p, s + buf_len, &var_hash)) {
+				zval_ptr_dtor(entry);
+				zval_ptr_dtor(inf);
 				goto outexcept;
 			}
 		}
-		if (Z_TYPE(entry) != IS_OBJECT) {
-			zval_ptr_dtor(&entry);
-			zval_ptr_dtor(&inf);
+		if (Z_TYPE_P(entry) != IS_OBJECT) {
+			zval_ptr_dtor(entry);
+			zval_ptr_dtor(inf);
 			goto outexcept;
 		}
 
-		if (spl_object_storage_get_hash(&key, intern, Z_OBJ(entry)) == FAILURE) {
-			zval_ptr_dtor(&entry);
-			zval_ptr_dtor(&inf);
+		if (spl_object_storage_get_hash(&key, intern, Z_OBJ_P(entry)) == FAILURE) {
+			zval_ptr_dtor(entry);
+			zval_ptr_dtor(inf);
 			goto outexcept;
 		}
 		pelement = spl_object_storage_get(intern, &key);
 		spl_object_storage_free_hash(intern, &key);
 		if (pelement) {
 			if (!Z_ISUNDEF(pelement->inf)) {
-				var_push_dtor(&var_hash, &pelement->inf);
+				zval *tmp_inf = var_tmp_var(&var_hash);
+				ZVAL_COPY(tmp_inf, &pelement->inf);
+				var_push_dtor(&var_hash, tmp_inf);
 			}
 			ZVAL_OBJ(&obj, pelement->obj);
 			var_push_dtor(&var_hash, &obj);
 		}
-		element = spl_object_storage_attach(intern, Z_OBJ(entry), Z_ISUNDEF(inf)?NULL:&inf);
+		element = spl_object_storage_attach(intern, Z_OBJ_P(entry), Z_ISUNDEF_P(inf)?NULL:inf);
 		ZVAL_OBJ(&obj, element->obj);
-		var_replace(&var_hash, &entry, &obj);
-		var_replace(&var_hash, &inf, &element->inf);
-		zval_ptr_dtor(&entry);
-		ZVAL_UNDEF(&entry);
-		zval_ptr_dtor(&inf);
-		ZVAL_UNDEF(&inf);
+		/* replaced */
+		var_replace(&var_hash, inf, &element->inf);
+		zval_ptr_dtor(entry);
+		ZVAL_UNDEF(entry);
+		zval_ptr_dtor(inf);
+		ZVAL_UNDEF(inf);
 	}
 
 	if (*p != ';') {