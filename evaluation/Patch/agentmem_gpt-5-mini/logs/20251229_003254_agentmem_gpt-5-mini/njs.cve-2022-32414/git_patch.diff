diff --git a/src/njs_vmcode.c b/src/njs_vmcode.c
index ec47865..7f9d68a 100644
--- a/src/njs_vmcode.c
+++ b/src/njs_vmcode.c
@@ -799,6 +799,11 @@ next:
 
                 next = value2->data.u.next;
 
+                if (njs_slow_path(next == NULL || next->array == NULL)) {
+                    njs_internal_error(vm, "property next iterator is invalid");
+                    return NJS_ERROR;
+                }
+
                 if (next->index < next->array->length) {
                     *retval = next->array->start[next->index++];
 
@@ -1430,7 +1435,7 @@ njs_vmcode_property_foreach(njs_vm_t *vm, njs_value_t *object,
         return NJS_ERROR;
     }
 
-    vm->retval.data.u.next = next;
+    njs_set_data(&vm->retval, next, NJS_DATA_TAG_ARRAY_ITERATOR);
 
     code = (njs_vmcode_prop_foreach_t *) pc;