diff --git a/src/filters/mux_isom.c b/src/filters/mux_isom.c
index 4044ef11f..2e42dc531 100644
--- a/src/filters/mux_isom.c
+++ b/src/filters/mux_isom.c
@@ -409,6 +409,8 @@ typedef struct
 	Bool has_chap_tracks;
 
 	GF_List *ref_pcks;
+    /* delayed free list for TrackWriter removed while processing */
+    GF_List *tkw_delayed_free;
 } GF_MP4MuxCtx;
 
 static void mp4_mux_update_init_edit(GF_MP4MuxCtx *ctx, TrackWriter *tkw, u64 min_ts_service, Bool skip_adjust);
@@ -3990,8 +3992,15 @@ static GF_Err mp4_mux_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool i
 	if (is_remove) {
 		TrackWriter *tkw = gf_filter_pid_get_udta(pid);
 		if (tkw) {
+			/* Do not free TrackWriter here to avoid use-after-free from processing thread. */
 			gf_list_del_item(ctx->tracks, tkw);
-			gf_free(tkw);
+			/* detach from pid and mark aborted so processing will skip it */
+			gf_filter_pid_set_udta(pid, NULL);
+			tkw->ipid = NULL;
+			tkw->aborted = GF_TRUE;
+			/* add to delayed free list so it is freed later on safe point */
+			if (!ctx->tkw_delayed_free) ctx->tkw_delayed_free = gf_list_new();
+			gf_list_add(ctx->tkw_delayed_free, tkw);
 		}
 		//removing last pid
 		if (ctx->opid && !gf_list_count(ctx->tracks)) {
@@ -4011,6 +4020,15 @@ static GF_Err mp4_mux_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool i
 			//delete output pid (to flush destruction of filter chain)
 			gf_filter_pid_remove(ctx->opid);
 			ctx->opid = NULL;
+			/* free any delayed TrackWriter objects now that no processing should be ongoing */
+			if (ctx->tkw_delayed_free) {
+				while (gf_list_count(ctx->tkw_delayed_free)) {
+					TrackWriter *dt = gf_list_pop_back(ctx->tkw_delayed_free);
+					mp4_mux_track_writer_del(dt);
+				}
+				gf_list_del(ctx->tkw_delayed_free);
+				ctx->tkw_delayed_free = NULL;
+			}
 		}
 		return GF_OK;
 	}
@@ -5824,7 +5842,12 @@ static GF_Err mp4_mux_initialize_movie(GF_MP4MuxCtx *ctx)
 
 		//use 1 for the default sample description index. If no multi stsd, this is always the case
 		//otherwise we need to update the stsd idx in the traf headers
-		e = gf_isom_setup_track_fragment(ctx->file, tkw->track_id, tkw->stsd_idx, def_pck_dur, def_samp_size, def_is_rap, 0, 0, ctx->nofragdef ? GF_TRUE : GF_FALSE);
+		if (tkw->track_id) {
+            e = gf_isom_setup_track_fragment(ctx->file, tkw->track_id, tkw->stsd_idx, def_pck_dur, def_samp_size, def_is_rap, 0, 0, ctx->nofragdef ? GF_TRUE : GF_FALSE);
+        } else {
+            GF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, ("[MP4Mux] Skipping fragmentation setup: track has no track_id\n"));
+            e = GF_OK;
+        }
 		if (e) {
 			GF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, ("[MP4Mux] Unable to setup fragmentation for track ID %d: %s\n", tkw->track_id, gf_error_to_string(e) ));
 			return e;