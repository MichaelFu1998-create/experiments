diff --git a/src/media_tools/avilib.c b/src/media_tools/avilib.c
index 27cd81133..8bdcd1797 100644
--- a/src/media_tools/avilib.c
+++ b/src/media_tools/avilib.c
@@ -541,33 +541,44 @@ static int avi_add_odml_index_entry(avi_t *AVI, unsigned char *tag, int flags, u
 
 static int avi_add_index_entry(avi_t *AVI, unsigned char *tag, int flags, u64 pos, u64 len)
 {
-	if(AVI->n_idx>=AVI->max_idx) {
-		void *ptr = gf_realloc((void *)AVI->idx,(AVI->max_idx+4096)*16);
+    /* Ensure idx array is allocated and has capacity */
+    if (!AVI->idx) {
+        AVI->max_idx = 4096;
+        AVI->n_idx = 0;
+        AVI->idx = (unsigned char (*)[16]) gf_malloc((u32)AVI->max_idx * 16);
+        if (!AVI->idx) {
+            AVI_errno = AVI_ERR_NO_MEM;
+            return -1;
+        }
+    }
 
-		if(ptr == 0) {
-			AVI_errno = AVI_ERR_NO_MEM;
-			return -1;
-		}
-		AVI->max_idx += 4096;
-		AVI->idx = (unsigned char((*)[16]) ) ptr;
-	}
+    if (AVI->n_idx >= AVI->max_idx) {
+        void *ptr = gf_realloc((void *)AVI->idx, (AVI->max_idx + 4096) * 16);
 
-	/* Add index entry */
+        if (ptr == 0) {
+            AVI_errno = AVI_ERR_NO_MEM;
+            return -1;
+        }
+        AVI->max_idx += 4096;
+        AVI->idx = (unsigned char (*)[16]) ptr;
+    }
 
-	//   GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, ("[avilib] INDEX %s %ld %lu %lu\n", tag, flags, pos, len));
+    /* Add index entry */
 
-	memcpy(AVI->idx[AVI->n_idx],tag,4);
-	long2str(AVI->idx[AVI->n_idx]+ 4,flags);
-	long2str(AVI->idx[AVI->n_idx]+ 8, (s32) pos);
-	long2str(AVI->idx[AVI->n_idx]+12, (s32) len);
+    //   GF_LOG(GF_LOG_DEBUG, GF_LOG_CONTAINER, ("[avilib] INDEX %s %ld %lu %lu\n", tag, flags, pos, len));
 
-	/* Update counter */
+    memcpy(AVI->idx[AVI->n_idx], tag, 4);
+    long2str(AVI->idx[AVI->n_idx] + 4, flags);
+    long2str(AVI->idx[AVI->n_idx] + 8, (s32) pos);
+    long2str(AVI->idx[AVI->n_idx] + 12, (s32) len);
 
-	AVI->n_idx++;
+    /* Update counter */
 
-	if(len>AVI->max_len) AVI->max_len=(u32) len;
+    AVI->n_idx++;
 
-	return 0;
+    if ((u64)len > AVI->max_len) AVI->max_len = (u32) len;
+
+    return 0;
 }
 
 #if 0
diff --git a/src/media_tools/mpeg2_ps.c b/src/media_tools/mpeg2_ps.c
index 8e33e48d4..d75dafee4 100644
--- a/src/media_tools/mpeg2_ps.c
+++ b/src/media_tools/mpeg2_ps.c
@@ -160,8 +160,14 @@ static Bool file_read_bytes(FILE *fd,
                             u8 *buffer,
                             u32 len)
 {
-	u32 readval = (u32) gf_fread(buffer, len, fd);
-	return readval == len;
+    /* Defensive check: ensure fd is valid before calling gf_fread.
+       This prevents passing a NULL FILE* to fread which causes a crash under ASan. */
+    if (!file_okay(fd)) {
+        return 0;
+    }
+    if (len == 0) return 1;
+    u32 readval = (u32) gf_fread(buffer, len, fd);
+    return readval == len;
 }
 
 // note: len could be negative.