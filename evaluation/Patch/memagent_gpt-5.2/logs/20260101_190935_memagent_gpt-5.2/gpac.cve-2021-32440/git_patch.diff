diff --git a/src/isomedia/media_odf.c b/src/isomedia/media_odf.c
index 33c41a36f..e44f8e0d8 100644
--- a/src/isomedia/media_odf.c
+++ b/src/isomedia/media_odf.c
@@ -131,10 +131,15 @@ GF_Err Media_RewriteODFrame(GF_MediaBox *mdia, GF_ISOSample *sample)
 				//then rewrite the ESDesc
 				j=0;
 				while ((ref = (GF_ES_ID_Ref*)gf_list_enum(isom_od->ES_ID_RefDescriptors, &j))) {
+					GF_ISOTrackID ref_track_id;
+					/* trackRef is a 1-based index in the MPOD track reference list. It comes from
+					 * the bitstream, so we must validate it before doing (trackRef-1) indexing. */
+					if (!ref->trackRef || (ref->trackRef > mpod->trackIDCount)) continue;
+					ref_track_id = mpod->trackIDs[ref->trackRef - 1];
 					//if the ref index is not valid, skip this desc...
-					if (!mpod->trackIDs || gf_isom_get_track_from_id(mdia->mediaTrack->moov, mpod->trackIDs[ref->trackRef - 1]) == NULL) continue;
+					if (gf_isom_get_track_from_id(mdia->mediaTrack->moov, ref_track_id) == NULL) continue;
 					//OK, get the esd
-					e = GetESDForTime(mdia->mediaTrack->moov, mpod->trackIDs[ref->trackRef - 1], sample->DTS, &esd);
+					e = GetESDForTime(mdia->mediaTrack->moov, ref_track_id, sample->DTS, &esd);
 					if (!e) e = gf_odf_desc_add_desc((GF_Descriptor *) od, (GF_Descriptor *) esd);
 					if (e) {
 						gf_odf_desc_del((GF_Descriptor *)od);
@@ -160,10 +165,15 @@ GF_Err Media_RewriteODFrame(GF_MediaBox *mdia, GF_ISOSample *sample)
 			esdU2->ODID = esdU->ODID;
 			i=0;
 			while ((ref = (GF_ES_ID_Ref*)gf_list_enum(esdU->ESDescriptors, &i))) {
+				GF_ISOTrackID ref_track_id;
+				/* trackRef is a 1-based index in the MPOD track reference list. Validate
+				 * before indexing (trackRef-1) into mpod->trackIDs. */
+				if (!ref->trackRef || (ref->trackRef > mpod->trackIDCount)) continue;
+				ref_track_id = mpod->trackIDs[ref->trackRef - 1];
 				//if the ref index is not valid, skip this desc...
-				if (gf_isom_get_track_from_id(mdia->mediaTrack->moov, mpod->trackIDs[ref->trackRef - 1]) == NULL) continue;
+				if (gf_isom_get_track_from_id(mdia->mediaTrack->moov, ref_track_id) == NULL) continue;
 				//OK, get the esd
-				e = GetESDForTime(mdia->mediaTrack->moov, mpod->trackIDs[ref->trackRef - 1], sample->DTS, &esd);
+				e = GetESDForTime(mdia->mediaTrack->moov, ref_track_id, sample->DTS, &esd);
 				if (e) goto err_exit;
 				gf_list_add(esdU2->ESDescriptors, esd);
 			}
@@ -187,12 +197,15 @@ GF_Err Media_RewriteODFrame(GF_MediaBox *mdia, GF_ISOSample *sample)
 			skipped = 0;
 			//get the ES_ID in the mpod indicated in the ES_ID[]
 			for (i = 0; i < esdR->NbESDs; i++) {
+				u32 ref_index = esdR->ES_ID[i];
 				//if the ref index is not valid, remove this desc...
-				if (gf_isom_get_track_from_id(mdia->mediaTrack->moov, mpod->trackIDs[esdR->ES_ID[i] - 1]) == NULL) {
+				if (!ref_index || (ref_index > mpod->trackIDCount)) {
+					skipped ++;
+				} else if (gf_isom_get_track_from_id(mdia->mediaTrack->moov, mpod->trackIDs[ref_index - 1]) == NULL) {
 					skipped ++;
 				} else {
 					//the command in the file has the ref index of the trackID in the mpod
-					esdR2->ES_ID[i - skipped] = mpod->trackIDs[esdR->ES_ID[i] - 1];
+					esdR2->ES_ID[i - skipped] = mpod->trackIDs[ref_index - 1];
 				}
 			}
 			//gf_realloc...