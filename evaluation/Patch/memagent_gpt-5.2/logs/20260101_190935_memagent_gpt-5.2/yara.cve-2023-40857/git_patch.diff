diff --git a/libyara/exec.c b/libyara/exec.c
index c4eeb7ef..f1bde756 100644
--- a/libyara/exec.c
+++ b/libyara/exec.c
@@ -98,6 +98,25 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     }                                                             \
   }
 
+// Ensure that a YR_STRING reference is valid before using its idx to access
+// context->matches. This prevents out-of-bounds access when executing
+// malformed or hostile bytecode.
+#define ensure_valid_string_idx(s)                                         \
+  if ((s) == NULL || (s)->idx < 0 || (uint32_t) (s)->idx >= context->rules->num_strings) \
+  {                                                                        \
+    stop = true;                                                           \
+    result = ERROR_INTERNAL_FATAL_ERROR;                                   \
+    break;                                                                 \
+  }
+
+// Returns true if ptr points somewhere within the rules arena.
+static inline bool _yr_ptr_within_rules_arena(
+    YR_SCAN_CONTEXT* context, const void* ptr)
+{
+  YR_ARENA_REF ref;
+  return yr_arena_ptr_to_ref(context->rules->arena, ptr, &ref) != 0;
+}
+
 #define check_object_canary(o)           \
   if (o->canary != context->canary)      \
   {                                      \
@@ -1423,6 +1442,22 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
     case OP_FOUND:
       pop(r1);
+
+      if (is_undef(r1))
+      {
+        r2.i = YR_UNDEFINED;
+        push(r2);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r1.p) || r1.s->idx < 0 ||
+          (uint32_t) r1.s->idx >= context->rules->num_strings)
+      {
+        r2.i = YR_UNDEFINED;
+        push(r2);
+        break;
+      }
+
       r2.i = context->matches[r1.s->idx].tail != NULL ? 1 : 0;
       YR_DEBUG_FPRINTF(
           2,
@@ -1441,9 +1476,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+
+      if (is_undef(r2))
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r2.p) || r2.s->idx < 0 ||
+          (uint32_t) r2.s->idx >= context->rules->num_strings)
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
 
       match = context->matches[r2.s->idx].head;
       r3.i = false;
@@ -1475,9 +1522,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_defined(r1);
       ensure_defined(r2);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r3.p);
-#endif
+
+      if (is_undef(r3))
+      {
+        r4.i = YR_UNDEFINED;
+        push(r4);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r3.p) || r3.s->idx < 0 ||
+          (uint32_t) r3.s->idx >= context->rules->num_strings)
+      {
+        r4.i = YR_UNDEFINED;
+        push(r4);
+        break;
+      }
 
       match = context->matches[r3.s->idx].head;
       r4.i = false;
@@ -1503,9 +1562,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_COUNT: // %s()\n", __FUNCTION__);
       pop(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r1.p);
-#endif
+
+      if (is_undef(r1))
+      {
+        r2.i = YR_UNDEFINED;
+        push(r2);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r1.p) || r1.s->idx < 0 ||
+          (uint32_t) r1.s->idx >= context->rules->num_strings)
+      {
+        r2.i = YR_UNDEFINED;
+        push(r2);
+        break;
+      }
 
       r2.i = context->matches[r1.s->idx].count;
       push(r2);
@@ -1521,9 +1592,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_defined(r1);
       ensure_defined(r2);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r3.p);
-#endif
+
+      if (is_undef(r3))
+      {
+        r4.i = YR_UNDEFINED;
+        push(r4);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r3.p) || r3.s->idx < 0 ||
+          (uint32_t) r3.s->idx >= context->rules->num_strings)
+      {
+        r4.i = YR_UNDEFINED;
+        push(r4);
+        break;
+      }
 
       match = context->matches[r3.s->idx].head;
       r4.i = 0;
@@ -1552,9 +1635,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+
+      if (is_undef(r2))
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r2.p) || r2.s->idx < 0 ||
+          (uint32_t) r2.s->idx >= context->rules->num_strings)
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
 
       match = context->matches[r2.s->idx].head;
 
@@ -1580,9 +1675,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+
+      if (is_undef(r2))
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
+
+      if (!_yr_ptr_within_rules_arena(context, r2.p) || r2.s->idx < 0 ||
+          (uint32_t) r2.s->idx >= context->rules->num_strings)
+      {
+        r3.i = YR_UNDEFINED;
+        push(r3);
+        break;
+      }
 
       match = context->matches[r2.s->idx].head;
 
@@ -1614,7 +1721,9 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       {
         if (r2.i == OF_STRING_SET)
         {
-          if (context->matches[r1.s->idx].tail != NULL)
+          if (_yr_ptr_within_rules_arena(context, r1.p) && r1.s->idx >= 0 &&
+              (uint32_t) r1.s->idx < context->rules->num_strings &&
+              context->matches[r1.s->idx].tail != NULL)
           {
             found++;
           }
@@ -1696,9 +1805,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       while (!is_undef(r3))
       {
-#if YR_PARANOID_EXEC
-        ensure_within_rules_arena(r3.p);
-#endif
+        if (!_yr_ptr_within_rules_arena(context, r3.p) || r3.s->idx < 0 ||
+            (uint32_t) r3.s->idx >= context->rules->num_strings)
+        {
+          count++;
+          pop(r3);
+          continue;
+        }
+
         match = context->matches[r3.s->idx].head;
 
         while (match != NULL)
@@ -1772,9 +1886,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       while (!is_undef(r1))
       {
-#if YR_PARANOID_EXEC
-        ensure_within_rules_arena(r1.p);
-#endif
+        if (!_yr_ptr_within_rules_arena(context, r1.p) || r1.s->idx < 0 ||
+            (uint32_t) r1.s->idx >= context->rules->num_strings)
+        {
+          count++;
+          pop(r1);
+          continue;
+        }
+
         match = context->matches[r1.s->idx].head;
 
         while (match != NULL)