diff --git a/programs/escape.c b/programs/escape.c
index 1daff81d..6e53fb0d 100644
--- a/programs/escape.c
+++ b/programs/escape.c
@@ -26,40 +26,87 @@
 char * ATTRIBUTE_MALLOC
 htmlescape (const char *restrict src, const int cp)
 {
-  int len = strlen (src) + 10;
-  char *dest, *d = malloc (len);
-  unsigned char *s = (unsigned char *)src;
-  dest = d;
-  while (*s++)
+  int len;
+  char *dest, *d;
+  const unsigned char *s = (const unsigned char *)src;
+
+  (void)cp;
+  /* Callers may pass optional DWG string fields which can be NULL. */
+  if (!src)
+    return NULL;
+
+  len = (int)strlen (src) + 16;
+  d = dest = (char *)malloc (len);
+  if (!dest)
+    return NULL;
+
+  /* Maintain a valid NUL terminator so we can safely append. */
+  *d = 0;
+
+#define ENSURE_SPACE(extra)                                                   \
+  do                                                                          \
+    {                                                                         \
+      const int off = (int)(d - dest);                                        \
+      if (off >= len - ((int)(extra) + 1))                                    \
+        {                                                                     \
+          char *newdest;                                                      \
+          len += 16 + (int)(extra);                                           \
+          newdest = (char *)realloc (dest, len);                              \
+          if (!newdest)                                                       \
+            {                                                                 \
+              free (dest);                                                    \
+              return NULL;                                                    \
+            }                                                                 \
+          dest = newdest;                                                     \
+          d = dest + off;                                                     \
+        }                                                                     \
+    }                                                                         \
+  while (0)
+
+#define APPEND_LIT(lit)                                                       \
+  do                                                                          \
+    {                                                                         \
+      const size_t n__ = sizeof (lit) - 1;                                    \
+      ENSURE_SPACE (n__);                                                     \
+      memcpy (d, (lit), n__);                                                 \
+      d += n__;                                                               \
+      *d = 0;                                                                 \
+    }                                                                         \
+  while (0)
+
+  while (*s)
     {
-      const int off = d - dest;
-      if (off >= len - 8)
-        {
-          len += 10;
-          dest = realloc (dest, len);
-          d = dest + off;
-        }
-      switch (*s)
+      const unsigned char c = *s++;
+      switch (c)
         {
-        case '"': strcat (d, "&quot;"); d += 6; break;
-        case '\'': strcat (d, "&#39;"); d += 5; break;
-        case '`': strcat (d, "&#96;"); d += 5; break;
-        case '&': strcat (d, "&amp;"); d += 5; break;
-        case '<': strcat (d, "&lt;"); d += 4; break;
-        case '>': strcat (d, "&gt;"); d += 4; break;
-        case '{': strcat (d, "&#123;"); d += 6; break;
-        case '}': strcat (d, "&#125;"); d += 6; break;
+        case '"': APPEND_LIT ("&quot;"); break;
+        case '\'': APPEND_LIT ("&#39;"); break;
+        case '`': APPEND_LIT ("&#96;"); break;
+        case '&': APPEND_LIT ("&amp;"); break;
+        case '<': APPEND_LIT ("&lt;"); break;
+        case '>': APPEND_LIT ("&gt;"); break;
+        case '{': APPEND_LIT ("&#123;"); break;
+        case '}': APPEND_LIT ("&#125;"); break;
         default:
-          if (*s >= 127) // maybe encodings, no utf8 (see htmlwescape)
+          if (c >= 127) /* maybe encodings, no utf8 (see htmlwescape) */
             {
-              sprintf (d, "&#x%X;", *s); // 4 + 4
+              /* Maximum expansion: "&#xFF;" is small; keep some slack. */
+              ENSURE_SPACE (8);
+              sprintf (d, "&#x%X;", (unsigned int)c);
               d += strlen (d);
             }
-          else if (*s >= 20)
-            *d++ = *s;
+          else if (c >= 20)
+            {
+              ENSURE_SPACE (1);
+              *d++ = (char)c;
+              *d = 0;
+            }
         }
     }
-  *d = 0;
+
+#undef APPEND_LIT
+#undef ENSURE_SPACE
+
   return dest;
 }
 
@@ -78,35 +125,47 @@ htmlwescape (BITCODE_TU wstr)
   len += 16;
   d = dest = malloc (len);
 
-  while (*wstr++)
+  if (!dest)
+    return NULL;
+  *d = 0;
+
+  while (*wstr)
     {
-      const int off = d - dest;
-      if (off >= len - 8)
+      const BITCODE_RS c0 = *wstr++;
+      const int off = (int)(d - dest);
+      if (off >= len - 16)
         {
-          len += 16;
-          dest = realloc (dest, len);
+          char *newdest;
+          len += 32;
+          newdest = realloc (dest, len);
+          if (!newdest)
+            {
+              free (dest);
+              return NULL;
+            }
+          dest = newdest;
           d = dest + off;
         }
-      switch (*wstr)
+      switch (c0)
         {
-        case 34: strcat (d, "&quot;"); d += 6; break;
-        case 39: strcat (d, "&#39;"); d += 5; break;
-        case 38: strcat (d, "&amp;"); d += 5; break;
-        case 60: strcat (d, "&lt;"); d += 4; break;
-        case 62: strcat (d, "&gt;"); d += 4; break;
-        case 96: strcat (d, "&#96;"); d += 5; break;
-        case 123: strcat (d, "&#123;"); d += 6; break;
-        case 125: strcat (d, "&#125;"); d += 6; break;
+        case 34: memcpy (d, "&quot;", 6); d += 6; break;
+        case 39: memcpy (d, "&#39;", 5); d += 5; break;
+        case 38: memcpy (d, "&amp;", 5); d += 5; break;
+        case 60: memcpy (d, "&lt;", 4); d += 4; break;
+        case 62: memcpy (d, "&gt;", 4); d += 4; break;
+        case 96: memcpy (d, "&#96;", 5); d += 5; break;
+        case 123: memcpy (d, "&#123;", 6); d += 6; break;
+        case 125: memcpy (d, "&#125;", 6); d += 6; break;
         default:
-          if (*wstr >= 127) // utf8 encodings
+          if (c0 >= 127) // utf8 encodings
             {
-              sprintf (d, "&#x%X;", *wstr);
+              sprintf (d, "&#x%X;", (unsigned int)c0);
               d += strlen (d);
             }
-          else if (*wstr >= 20)
-            *d++ = *wstr;
+          else if (c0 >= 20)
+            *d++ = (char)c0;
         }
+      *d = 0;
     }
-  *d = 0;
   return dest;
 }