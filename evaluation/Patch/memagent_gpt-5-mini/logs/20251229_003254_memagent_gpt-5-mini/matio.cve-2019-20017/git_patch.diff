diff --git a/src/mat5.c b/src/mat5.c
index abdb351..d28d0b6 100644
--- a/src/mat5.c
+++ b/src/mat5.c
@@ -4777,13 +4777,14 @@ Mat_VarReadNextInfo5( mat_t *mat )
         case MAT_T_COMPRESSED:
         {
 #if defined(HAVE_ZLIB)
-            mat_uint32_t uncomp_buf[16] = {0,};
+            mat_uint32_t uncomp_buf[512] = {0,};
             int      nbytes;
             long     bytesread = 0;
 
             matvar = Mat_VarCalloc();
             if ( NULL == matvar ) {
                 Mat_Critical("Couldn't allocate memory");
+                if ( heap_uncomp ) { free(heap_uncomp); heap_uncomp = NULL; }
                 break;
             }
 
@@ -4794,6 +4795,7 @@ Mat_VarReadNextInfo5( mat_t *mat )
                 Mat_VarFree(matvar);
                 matvar = NULL;
                 Mat_Critical("inflateInit returned %s",zError(err));
+                if ( heap_uncomp ) { free(heap_uncomp); heap_uncomp = NULL; }
                 break;
             }
 
@@ -4804,11 +4806,38 @@ Mat_VarReadNextInfo5( mat_t *mat )
                 (void)Mat_uint32Swap(uncomp_buf+1);
             }
             nbytes = uncomp_buf[1];
+            if ( nbytes > 0 ) {
+                size_t needed_elems = (size_t)((nbytes + sizeof(mat_uint32_t)-1)/sizeof(mat_uint32_t)) + 8;
+                const size_t MAX_UNCOMP_ELEMS = 65536;
+                if ( needed_elems > uncomp_elems ) {
+                    if ( needed_elems > MAX_UNCOMP_ELEMS ) {
+                        (void)fseek((FILE*)mat->fp,nBytes-bytesread,SEEK_CUR);
+                        Mat_VarFree(matvar);
+                        matvar = NULL;
+                        Mat_Critical("Uncompressed variable size too large");
+                        if ( heap_uncomp ) { free(heap_uncomp); heap_uncomp = NULL; }
+                        break;
+                    }
+                    heap_uncomp = (mat_uint32_t*)calloc(needed_elems, sizeof(mat_uint32_t));
+                    if ( heap_uncomp == NULL ) {
+                        Mat_VarFree(matvar);
+                        matvar = NULL;
+                        Mat_Critical("Couldn't allocate memory");
+                        break;
+                    }
+                    /* copy already read header words */
+                    heap_uncomp[0] = uncomp_buf[0];
+                    heap_uncomp[1] = uncomp_buf[1];
+                    uncomp_buf = heap_uncomp;
+                    uncomp_elems = needed_elems;
+                }
+            }
             if ( uncomp_buf[0] != MAT_T_MATRIX ) {
                 (void)fseek((FILE*)mat->fp,nBytes-bytesread,SEEK_CUR);
                 Mat_VarFree(matvar);
                 matvar = NULL;
                 Mat_Critical("Uncompressed type not MAT_T_MATRIX");
+                if ( heap_uncomp ) { free(heap_uncomp); heap_uncomp = NULL; }
                 break;
             }
             /* Array flags */
@@ -4833,7 +4862,7 @@ Mat_VarReadNextInfo5( mat_t *mat )
             if ( matvar->class_type != MAT_C_OPAQUE ) {
                 mat_uint32_t* dims = NULL;
                 int do_clean = 0;
-                bytesread += InflateRankDims(mat,matvar,uncomp_buf,sizeof(uncomp_buf),&dims);
+                bytesread += InflateRankDims(mat,matvar,uncomp_buf,uncomp_elems*sizeof(mat_uint32_t),&dims);
                 if ( NULL == dims )
                     dims = uncomp_buf + 2;
                 else
@@ -4902,6 +4931,7 @@ Mat_VarReadNextInfo5( mat_t *mat )
                 }
             }
             (void)fseek((FILE*)mat->fp,nBytes+8+fpos,SEEK_SET);
+                if ( heap_uncomp ) { free(heap_uncomp); heap_uncomp = NULL; }
             break;
 #else
             Mat_Critical("Compressed variable found in \"%s\", but matio was "