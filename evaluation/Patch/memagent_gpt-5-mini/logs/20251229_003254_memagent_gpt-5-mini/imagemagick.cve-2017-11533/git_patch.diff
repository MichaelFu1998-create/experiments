diff --git a/coders/uil.c b/coders/uil.c
index beda560aa..609d833fc 100644
--- a/coders/uil.c
+++ b/coders/uil.c
@@ -246,11 +246,11 @@ static MagickBooleanType WriteUILImage(const ImageInfo *image_info,Image *image,
               break;
             for (x=0; x < (ssize_t) image->columns; x++)
             {
-              matte_image[i]=(unsigned char) (GetPixelAlpha(image,p) ==
+              size_t index=(size_t) y*(size_t) image->columns+(size_t) x;
+              matte_image[index]=(unsigned char) (GetPixelAlpha(image,p) ==
                 (Quantum) TransparentAlpha ? 1 : 0);
-              if (matte_image[i] != 0)
+              if (matte_image[index] != 0)
                 transparent=MagickTrue;
-              i++;
               p+=GetPixelChannels(image);
             }
           }
@@ -263,6 +263,7 @@ static MagickBooleanType WriteUILImage(const ImageInfo *image_info,Image *image,
             *q;
 
           colors++;
+          i=0;
           for (y=0; y < (ssize_t) image->rows; y++)
           {
             q=GetAuthenticPixels(image,0,y,image->columns,1,exception);
@@ -270,7 +271,8 @@ static MagickBooleanType WriteUILImage(const ImageInfo *image_info,Image *image,
               break;
             for (x=0; x < (ssize_t) image->columns; x++)
             {
-              if (matte_image[i] != 0)
+              size_t index=(size_t) y*(size_t) image->columns+(size_t) x;
+              if (matte_image[index] != 0)
                 SetPixelIndex(image,(Quantum) image->colors,q);
               q+=GetPixelChannels(image);
             }