diff --git a/libyara/exec.c b/libyara/exec.c
index c4eeb7ef..e9f3a7b1 100644
--- a/libyara/exec.c
+++ b/libyara/exec.c
@@ -1340,6 +1340,13 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       int i = (int) strlen(args_fmt);
       count = 0;
 
+      if (i > YR_MAX_FUNCTION_ARGS)
+      {
+        stop = true;
+        result = ERROR_INTERNAL_FATAL_ERROR;
+        break;
+      }
+
 #if YR_PARANOID_EXEC
       if (i > YR_MAX_FUNCTION_ARGS)
       {
@@ -1423,7 +1430,19 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
     case OP_FOUND:
       pop(r1);
-      r2.i = context->matches[r1.s->idx].tail != NULL ? 1 : 0;
+
+      ensure_defined(r1);
+
+      ensure_within_rules_arena(r1.s);
+
+
+      if ((size_t) r1.s->idx >= (size_t) context->rules->num_strings) {
+      r2.i = YR_UNDEFINED;
+      push(r2);
+      break;
+    }
+
+    r2.i = context->matches[r1.s->idx].tail != NULL ? 1 : 0;
       YR_DEBUG_FPRINTF(
           2,
           stderr,
@@ -1445,7 +1464,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r2.p);
 #endif
 
-      match = context->matches[r2.s->idx].head;
+      ensure_defined(r2);
+
+      ensure_within_rules_arena(r2.s);
+      if ((size_t) r2.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r2.s->idx].head;
+        }
       r3.i = false;
 
       while (match != NULL)
@@ -1479,7 +1505,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r3.p);
 #endif
 
-      match = context->matches[r3.s->idx].head;
+      ensure_defined(r3);
+
+      ensure_within_rules_arena(r3.s);
+      if ((size_t) r3.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r3.s->idx].head;
+        }
       r4.i = false;
 
       while (match != NULL && !r4.i)
@@ -1507,7 +1540,16 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r1.p);
 #endif
 
-      r2.i = context->matches[r1.s->idx].count;
+      ensure_defined(r1);
+
+      ensure_within_rules_arena(r1.s);
+      if ((size_t) r1.s->idx >= (size_t) context->rules->num_strings) {
+      r2.i = YR_UNDEFINED;
+      push(r2);
+      break;
+    }
+
+    r2.i = context->matches[r1.s->idx].count;
       push(r2);
       break;
 
@@ -1525,7 +1567,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r3.p);
 #endif
 
-      match = context->matches[r3.s->idx].head;
+      ensure_defined(r3);
+
+      ensure_within_rules_arena(r3.s);
+      if ((size_t) r3.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r3.s->idx].head;
+        }
       r4.i = 0;
 
       while (match != NULL)
@@ -1556,7 +1605,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r2.p);
 #endif
 
-      match = context->matches[r2.s->idx].head;
+      ensure_defined(r2);
+
+      ensure_within_rules_arena(r2.s);
+      if ((size_t) r2.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r2.s->idx].head;
+        }
 
       i = 1;
       r3.i = YR_UNDEFINED;
@@ -1584,7 +1640,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_within_rules_arena(r2.p);
 #endif
 
-      match = context->matches[r2.s->idx].head;
+      ensure_defined(r2);
+
+      ensure_within_rules_arena(r2.s);
+      if ((size_t) r2.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r2.s->idx].head;
+        }
 
       i = 1;
       r3.i = YR_UNDEFINED;
@@ -1614,7 +1677,10 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       {
         if (r2.i == OF_STRING_SET)
         {
-          if (context->matches[r1.s->idx].tail != NULL)
+      ensure_defined(r1);
+
+      ensure_within_rules_arena(r1.s);
+          if ((size_t) r1.s->idx < (size_t) context->rules->num_strings && context->matches[r1.s->idx].tail != NULL)
           {
             found++;
           }
@@ -1699,7 +1765,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 #if YR_PARANOID_EXEC
         ensure_within_rules_arena(r3.p);
 #endif
-        match = context->matches[r3.s->idx].head;
+      ensure_defined(r3);
+
+      ensure_within_rules_arena(r3.s);
+        if ((size_t) r3.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r3.s->idx].head;
+        }
 
         while (match != NULL)
         {
@@ -1775,7 +1848,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 #if YR_PARANOID_EXEC
         ensure_within_rules_arena(r1.p);
 #endif
-        match = context->matches[r1.s->idx].head;
+      ensure_defined(r1);
+
+      ensure_within_rules_arena(r1.s);
+        if ((size_t) r1.s->idx >= (size_t) context->rules->num_strings) {
+          match = NULL;
+        } else {
+          match = context->matches[r1.s->idx].head;
+        }
 
         while (match != NULL)
         {
@@ -2383,4 +2463,4 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       __FUNCTION__);
 
   return result;
-}
+}
\ No newline at end of file