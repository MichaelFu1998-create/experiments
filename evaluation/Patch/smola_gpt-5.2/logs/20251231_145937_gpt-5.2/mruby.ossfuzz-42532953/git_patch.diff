diff --git a/src/string.c b/src/string.c
index e214ad4c2..ca6bdbbae 100644
--- a/src/string.c
+++ b/src/string.c
@@ -641,9 +641,11 @@ memsearch_swar(const char *xs, long m, const char *ys, long n)
     const char *p = s0;
     const char *e = ys + n;
     for (;p<e;) {
-      size_t len = e-p;
-      p = (const char*)memchr(p, *xs, len);
-      if (p == NULL || len < m) break;
+      p = (const char*)memchr(p, *xs, (size_t)(e - p));
+      if (p == NULL) break;
+      /* Ensure we never compare past the end of the target buffer.
+         (e - p) is the remaining length starting at p. */
+      if (e - p < m) break;
       if (memcmp(p+1, xs+1, m-1) == 0) return (mrb_int)(p - ys);
       p++;
     }