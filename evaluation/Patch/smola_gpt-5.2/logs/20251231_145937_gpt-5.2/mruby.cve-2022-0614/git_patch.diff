diff --git a/src/hash.c b/src/hash.c
index fc6b6fa..2aaa885 100644
--- a/src/hash.c
+++ b/src/hash.c
@@ -449,15 +449,18 @@ ea_dup(mrb_state *mrb, const hash_entry *ea, uint32_t capa)
 }
 
 static hash_entry*
-ea_get_by_key(mrb_state *mrb, hash_entry *ea, uint32_t size, mrb_value key,
+ea_get_by_key(mrb_state *mrb, hash_entry *ea, uint32_t n_used, mrb_value key,
               struct RHash *h)
 {
-  ea_each(ea, size, entry, {
+  if (!ea || n_used == 0) return NULL;
+  ea_each_used(ea, n_used, entry, {
+    if (entry_deleted_p(entry)) continue;
     if (obj_eql(mrb, key, entry->key, h)) return entry;
   });
   return NULL;
 }
 
+
 static hash_entry*
 ea_get(hash_entry *ea, uint32_t index)
 {
@@ -522,7 +525,7 @@ ar_set(mrb_state *mrb, struct RHash *h, mrb_value key, mrb_value val)
 {
   uint32_t size = ar_size(h);
   hash_entry *entry;
-  if ((entry = ea_get_by_key(mrb, ar_ea(h), size, key, h))) {
+  if ((entry = ea_get_by_key(mrb, ar_ea(h), ar_ea_n_used(h), key, h))) {
     entry->val = val;
   }
   else {
@@ -553,7 +556,7 @@ ar_set(mrb_state *mrb, struct RHash *h, mrb_value key, mrb_value val)
 static mrb_bool
 ar_delete(mrb_state *mrb, struct RHash *h, mrb_value key, mrb_value *valp)
 {
-  hash_entry *entry = ea_get_by_key(mrb, ar_ea(h), ar_size(h), key, h);
+  hash_entry *entry = ea_get_by_key(mrb, ar_ea(h), ar_ea_n_used(h), key, h);
   if (!entry) return FALSE;
   *valp = entry->val;
   entry_delete(entry);
@@ -1151,6 +1154,7 @@ static mrb_value mrb_hash_default(mrb_state *mrb, mrb_value hash);
 static void
 hash_modify(mrb_state *mrb, mrb_value hash)
 {
+  mrb_check_type(mrb, hash, MRB_TT_HASH);
   mrb_check_frozen(mrb, mrb_hash_ptr(hash));
 }