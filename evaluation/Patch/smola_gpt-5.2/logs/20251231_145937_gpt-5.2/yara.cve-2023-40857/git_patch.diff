diff --git a/libyara/exec.c b/libyara/exec.c
index c4eeb7e..591c5e5 100644
--- a/libyara/exec.c
+++ b/libyara/exec.c
@@ -98,6 +98,12 @@ SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
     }                                                             \
   }
 
+// Validates that a YR_STRING pointer comes from the rules arena and that its
+// idx field is within the bounds of context->matches (which has
+// context->rules->num_strings entries). A crafted compiled rules file can embed
+// a YR_STRING with an out-of-range idx and trigger out-of-bounds access when
+// executing opcodes like OP_FOUND/OP_COUNT.
+
 #define check_object_canary(o)           \
   if (o->canary != context->canary)      \
   {                                      \
@@ -415,6 +421,29 @@ static YR_ITERATOR_NEXT_FUNC iter_next_func_table[] = {
 #define ITER_NEXT_STRING_SET      4
 #define ITER_NEXT_TEXT_STRING_SET 5
 
+
+static bool yr_valid_string_idx(
+    YR_SCAN_CONTEXT* context, YR_STRING* s, uint32_t* idx)
+{
+  YR_ARENA_REF ref;
+
+  if (s == NULL)
+    return false;
+
+  // The string reference must point into the rules arena.
+  if (yr_arena_ptr_to_ref(context->rules->arena, s, &ref) == 0)
+    return false;
+
+  // And the index must be within the bounds of the matches array.
+  if (s->idx >= context->rules->num_strings)
+    return false;
+
+  if (idx != NULL)
+    *idx = s->idx;
+
+  return true;
+}
+
 int yr_execute_code(YR_SCAN_CONTEXT* context)
 {
   YR_DEBUG_FPRINTF(2, stderr, "+ %s() {\n", __FUNCTION__);
@@ -1421,9 +1450,16 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       push(r1);
       break;
 
+
     case OP_FOUND:
       pop(r1);
-      r2.i = context->matches[r1.s->idx].tail != NULL ? 1 : 0;
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r1.s, &idx))
+          r2.i = 0;
+        else
+          r2.i = context->matches[idx].tail != NULL ? 1 : 0;
+      }
       YR_DEBUG_FPRINTF(
           2,
           stderr,
@@ -1441,11 +1477,18 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r2.s, &idx))
+        {
+          r3.i = 0;
+          push(r3);
+          break;
+        }
+
+        match = context->matches[idx].head;
+      }
 
-      match = context->matches[r2.s->idx].head;
       r3.i = false;
 
       while (match != NULL)
@@ -1475,11 +1518,18 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_defined(r1);
       ensure_defined(r2);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r3.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r3.s, &idx))
+        {
+          r4.i = 0;
+          push(r4);
+          break;
+        }
+
+        match = context->matches[idx].head;
+      }
 
-      match = context->matches[r3.s->idx].head;
       r4.i = false;
 
       while (match != NULL && !r4.i)
@@ -1503,11 +1553,14 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_COUNT: // %s()\n", __FUNCTION__);
       pop(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r1.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r1.s, &idx))
+          r2.i = 0;
+        else
+          r2.i = context->matches[idx].count;
+      }
 
-      r2.i = context->matches[r1.s->idx].count;
       push(r2);
       break;
 
@@ -1521,11 +1574,18 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       ensure_defined(r1);
       ensure_defined(r2);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r3.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r3.s, &idx))
+        {
+          r4.i = 0;
+          push(r4);
+          break;
+        }
+
+        match = context->matches[idx].head;
+      }
 
-      match = context->matches[r3.s->idx].head;
       r4.i = 0;
 
       while (match != NULL)
@@ -1552,11 +1612,17 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r2.s, &idx))
+        {
+          r3.i = YR_UNDEFINED;
+          push(r3);
+          break;
+        }
 
-      match = context->matches[r2.s->idx].head;
+        match = context->matches[idx].head;
+      }
 
       i = 1;
       r3.i = YR_UNDEFINED;
@@ -1580,11 +1646,17 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       ensure_defined(r1);
 
-#if YR_PARANOID_EXEC
-      ensure_within_rules_arena(r2.p);
-#endif
+      {
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r2.s, &idx))
+        {
+          r3.i = YR_UNDEFINED;
+          push(r3);
+          break;
+        }
 
-      match = context->matches[r2.s->idx].head;
+        match = context->matches[idx].head;
+      }
 
       i = 1;
       r3.i = YR_UNDEFINED;
@@ -1614,7 +1686,9 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       {
         if (r2.i == OF_STRING_SET)
         {
-          if (context->matches[r1.s->idx].tail != NULL)
+          uint32_t idx;
+          if (yr_valid_string_idx(context, r1.s, &idx) &&
+              context->matches[idx].tail != NULL)
           {
             found++;
           }
@@ -1696,10 +1770,15 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       while (!is_undef(r3))
       {
-#if YR_PARANOID_EXEC
-        ensure_within_rules_arena(r3.p);
-#endif
-        match = context->matches[r3.s->idx].head;
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r3.s, &idx))
+        {
+          count++;
+          pop(r3);
+          continue;
+        }
+
+        match = context->matches[idx].head;
 
         while (match != NULL)
         {
@@ -1772,10 +1851,15 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       while (!is_undef(r1))
       {
-#if YR_PARANOID_EXEC
-        ensure_within_rules_arena(r1.p);
-#endif
-        match = context->matches[r1.s->idx].head;
+        uint32_t idx;
+        if (!yr_valid_string_idx(context, r1.s, &idx))
+        {
+          count++;
+          pop(r1);
+          continue;
+        }
+
+        match = context->matches[idx].head;
 
         while (match != NULL)
         {