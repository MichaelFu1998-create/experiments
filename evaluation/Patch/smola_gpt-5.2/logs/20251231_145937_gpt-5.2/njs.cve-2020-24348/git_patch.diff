diff --git a/build/njs_auto_config.h b/build/njs_auto_config.h
new file mode 100644
index 0000000..7d688db
--- /dev/null
+++ b/build/njs_auto_config.h
@@ -0,0 +1,148 @@
+
+/* This file is auto-generated by configure */
+
+
+#ifndef NJS_LINUX
+#define NJS_LINUX  1
+#endif
+
+
+#ifndef NJS_CLANG
+#define NJS_CLANG  1
+#endif
+
+
+#ifndef NJS_INT_SIZE
+#define NJS_INT_SIZE  4
+#endif
+
+
+#ifndef NJS_UINT_SIZE
+#define NJS_UINT_SIZE  4
+#endif
+
+
+#ifndef NJS_PTR_SIZE
+#define NJS_PTR_SIZE  8
+#endif
+
+
+#ifndef NJS_UINTPTR_T_SIZE
+#define NJS_UINTPTR_T_SIZE  8
+#endif
+
+
+#ifndef NJS_SIZE_T_SIZE
+#define NJS_SIZE_T_SIZE  8
+#endif
+
+
+#ifndef NJS_OFF_T_SIZE
+#define NJS_OFF_T_SIZE  8
+#endif
+
+
+#ifndef NJS_TIME_T_SIZE
+#define NJS_TIME_T_SIZE  8
+#endif
+
+
+#ifndef NJS_BYTE_ORDER
+#define NJS_BYTE_ORDER  little
+#endif
+
+
+#ifndef NJS_HAVE_LITTLE_ENDIAN
+#define NJS_HAVE_LITTLE_ENDIAN  1
+#endif
+
+
+#ifndef NJS_HAVE_UNSIGNED_INT128
+#define NJS_HAVE_UNSIGNED_INT128  1
+#endif
+
+
+#ifndef NJS_HAVE_BUILTIN_EXPECT
+#define NJS_HAVE_BUILTIN_EXPECT  1
+#endif
+
+
+#ifndef NJS_HAVE_BUILTIN_UNREACHABLE
+#define NJS_HAVE_BUILTIN_UNREACHABLE  1
+#endif
+
+
+#ifndef NJS_HAVE_BUILTIN_PREFETCH
+#define NJS_HAVE_BUILTIN_PREFETCH  1
+#endif
+
+
+#ifndef NJS_HAVE_BUILTIN_CLZ
+#define NJS_HAVE_BUILTIN_CLZ  1
+#endif
+
+
+#ifndef NJS_HAVE_BUILTIN_CLZLL
+#define NJS_HAVE_BUILTIN_CLZLL  1
+#endif
+
+
+#ifndef NJS_HAVE_GCC_ATTRIBUTE_VISIBILITY
+#define NJS_HAVE_GCC_ATTRIBUTE_VISIBILITY  1
+#endif
+
+
+#ifndef NJS_HAVE_GCC_ATTRIBUTE_MALLOC
+#define NJS_HAVE_GCC_ATTRIBUTE_MALLOC  1
+#endif
+
+
+#ifndef NJS_HAVE_GCC_ATTRIBUTE_ALIGNED
+#define NJS_HAVE_GCC_ATTRIBUTE_ALIGNED  1
+#endif
+
+
+#ifndef NJS_HAVE_ADDRESS_SANITIZER
+#define NJS_HAVE_ADDRESS_SANITIZER  1
+#endif
+
+
+#ifndef NJS_HAVE_DENORMALS_CONTROL
+#define NJS_HAVE_DENORMALS_CONTROL  1
+#endif
+
+
+#ifndef NJS_HAVE_CLOCK_MONOTONIC
+#define NJS_HAVE_CLOCK_MONOTONIC  1
+#endif
+
+
+#ifndef NJS_HAVE_TM_GMTOFF
+#define NJS_HAVE_TM_GMTOFF  1
+#endif
+
+
+#ifndef NJS_HAVE_POSIX_MEMALIGN
+#define NJS_HAVE_POSIX_MEMALIGN  1
+#endif
+
+
+#ifndef NJS_HAVE_GETRANDOM
+#define NJS_HAVE_GETRANDOM  1
+#endif
+
+
+#ifndef NJS_HAVE_EXPLICIT_BZERO
+#define NJS_HAVE_EXPLICIT_BZERO  1
+#endif
+
+
+#ifndef NJS_HAVE_PCRE
+#define NJS_HAVE_PCRE  1
+#endif
+
+
+#ifndef NJS_HAVE_GNU_READLINE
+#define NJS_HAVE_GNU_READLINE  1
+#endif
+
diff --git a/src/njs_json.c b/src/njs_json.c
index 07767f9..2faed90 100644
--- a/src/njs_json.c
+++ b/src/njs_json.c
@@ -1297,6 +1297,26 @@ njs_json_stringify_iterator(njs_vm_t *vm, njs_json_stringify_t *stringify,
                 njs_json_stringify_indent(stringify, &chain, 0);
             }
 
+            /*
+             * The toJSON() method or replacer function can mutate values,
+             * including converting a fast array to a slow (non-fast) array.
+             * In this case, state->value no longer contains a valid
+             * njs_array_t and direct access via njs_array_* macros becomes
+             * unsafe.
+             */
+            if (njs_slow_path(!njs_is_fast_array(&state->value))) {
+                state->type = NJS_JSON_OBJECT;
+                state->array = 1;
+                state->keys = NULL;
+
+                ret = njs_object_length(vm, &state->value, &state->length);
+                if (njs_slow_path(ret == NJS_ERROR)) {
+                    return NJS_ERROR;
+                }
+
+                break;
+            }
+
             if (state->index >= njs_array_len(&state->value)) {
                 njs_json_stringify_indent(stringify, &chain, -1);
                 njs_chb_append_literal(&chain,"]");