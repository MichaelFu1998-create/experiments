diff --git a/src/isomedia/movie_fragments.c b/src/isomedia/movie_fragments.c
index b7f7ade..47b6d20 100644
--- a/src/isomedia/movie_fragments.c
+++ b/src/isomedia/movie_fragments.c
@@ -926,13 +926,47 @@ static u64 moof_get_earliest_cts(GF_MovieFragmentBox *moof, GF_ISOTrackID refTra
 
 GF_Err gf_isom_write_compressed_box(GF_ISOFile *mov, GF_Box *root_box, u32 repl_type, GF_BitStream *bs, u32 *box_csize);
 
+static Bool moof_has_trun(GF_MovieFragmentBox *moof, GF_TrackFragmentRunBox *trun)
+{
+	u32 i = 0;
+	GF_TrackFragmentBox *traf;
+	if (!moof || !trun || !moof->TrackList) return GF_FALSE;
+	while ((traf = (GF_TrackFragmentBox*)gf_list_enum(moof->TrackList, &i))) {
+		u32 j;
+		for (j = 0; j < gf_list_count(traf->TrackRuns); j++) {
+			if (gf_list_get(traf->TrackRuns, j) == trun) return GF_TRUE;
+		}
+	}
+	return GF_FALSE;
+}
+
 void flush_ref_samples(GF_ISOFile *movie, u64 *out_seg_size, Bool use_seg_marker)
 {
+	/*
+		When fragment generation prunes empty TRAF/TRUN boxes (eg. during StoreFragment),
+		the internal moof->trun_list may still contain pointers to TRUN boxes that were
+		deleted as part of the MOOF hierarchy cleanup.
+	
+		flush_ref_samples uses moof->trun_list to flush cached sample references in the
+		order TRUN boxes were created. If the list contains stale pointers, we can end up
+		dereferencing freed memory (ASan heap-use-after-free).
+	
+		We therefore validate each TRUN pointer against the current MOOF hierarchy before
+		accessing it, and drop any stale entry from the list.
+	*/
 	u32 i=0;
+	if (!movie || !movie->moof || !movie->moof->trun_list) return;
 	if (movie->in_sidx_write) return;
 	u32 trun_count = gf_list_count(movie->moof->trun_list);
 	for (i=0; i<trun_count; i++) {
 		GF_TrackFragmentRunBox *trun = gf_list_get(movie->moof->trun_list, i);
+		/* Drop stale pointers left in the list after TRAF/TRUN cleanup */
+		if (!trun || !moof_has_trun(movie->moof, trun)) {
+			gf_list_rem(movie->moof->trun_list, i);
+			trun_count--;
+			i--;
+			continue;
+		}
 		u32 s_count = gf_list_count(trun->sample_refs);
 		while (s_count) {
 			if (!use_seg_marker && movie->on_last_block_start && (i+1==trun_count) && (s_count==1)) {