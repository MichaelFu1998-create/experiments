diff --git a/src/njs_string.c b/src/njs_string.c
index d1ae09e..ee1e675 100644
--- a/src/njs_string.c
+++ b/src/njs_string.c
@@ -2522,21 +2522,20 @@ done:
 const u_char *
 njs_string_offset(const u_char *start, const u_char *end, size_t index)
 {
-    uint32_t    *map;
-    njs_uint_t  skip;
-
-    if (index >= NJS_STRING_MAP_STRIDE) {
-        map = njs_string_map_start(end);
-
-        if (map[0] == 0) {
-            njs_string_offset_map_init(start, end - start);
-        }
-
-        start += map[index / NJS_STRING_MAP_STRIDE - 1];
-    }
+    /*
+     * Historically, njs_string_offset() used an in-place UTF-8 offset map
+     * stored right after the string data.  However, not all strings are
+     * guaranteed to have such a map allocated (e.g. some external strings).
+     * Accessing the map unconditionally can therefore read past the end of the
+     * actual allocation and crash.
+     *
+     * To make the function safe for all callers, compute the offset by walking
+     * the UTF-8 sequence.
+     */
 
-    for (skip = index % NJS_STRING_MAP_STRIDE; skip != 0; skip--) {
+    while (index != 0 && start < end) {
         start = njs_utf8_next(start, end);
+        index--;
     }
 
     return start;
@@ -2550,38 +2549,26 @@ njs_string_offset(const u_char *start, const u_char *end, size_t index)
 uint32_t
 njs_string_index(njs_string_prop_t *string, uint32_t offset)
 {
-    uint32_t      *map, last, index;
+    uint32_t      index;
     const u_char  *p, *start, *end;
 
     if (string->size == string->length) {
         return offset;
     }
 
-    last = 0;
-    index = 0;
-
-    if (string->length > NJS_STRING_MAP_STRIDE) {
-
-        end = string->start + string->size;
-        map = njs_string_map_start(end);
-
-        if (map[0] == 0) {
-            njs_string_offset_map_init(string->start, string->size);
-        }
+    /*
+     * Do not rely on the optional in-place offset map (see njs_string_offset()
+     * above).  Calculate the UTF-8 character index by walking from the string
+     * start to the provided byte offset.
+     */
 
-        while (index + NJS_STRING_MAP_STRIDE < string->length
-               && *map <= offset)
-        {
-            last = *map++;
-            index += NJS_STRING_MAP_STRIDE;
-        }
-    }
+    index = 0;
 
-    p = string->start + last;
+    p = string->start;
     start = string->start + offset;
     end = string->start + string->size;
 
-    while (p < start) {
+    while (p < start && p < end) {
         index++;
         p = njs_utf8_next(p, end);
     }