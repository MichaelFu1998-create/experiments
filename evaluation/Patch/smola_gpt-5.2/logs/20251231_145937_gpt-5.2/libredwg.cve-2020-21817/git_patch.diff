diff --git a/programs/escape.c b/programs/escape.c
index 1daff81..c85a396 100644
--- a/programs/escape.c
+++ b/programs/escape.c
@@ -26,20 +26,40 @@
 char * ATTRIBUTE_MALLOC
 htmlescape (const char *restrict src, const int cp)
 {
-  int len = strlen (src) + 10;
-  char *dest, *d = malloc (len);
-  unsigned char *s = (unsigned char *)src;
-  dest = d;
-  while (*s++)
+  int len;
+  char *dest, *d;
+  const unsigned char *s;
+  unsigned char c;
+
+  (void)cp; /* currently unused */
+
+  /* src may be NULL for empty/invalid TEXT values */
+  if (!src)
+    return NULL;
+
+  len = (int)strlen (src) + 10;
+  d = dest = malloc (len);
+  if (!dest)
+    return NULL;
+  *d = 0;
+
+  s = (const unsigned char *)src;
+  while ((c = *s++))
     {
-      const int off = d - dest;
+      const int off = (int)(d - dest);
       if (off >= len - 8)
         {
           len += 10;
-          dest = realloc (dest, len);
+          char *tmp = realloc (dest, len);
+          if (!tmp)
+            {
+              free (dest);
+              return NULL;
+            }
+          dest = tmp;
           d = dest + off;
         }
-      switch (*s)
+      switch (c)
         {
         case '"': strcat (d, "&quot;"); d += 6; break;
         case '\'': strcat (d, "&#39;"); d += 5; break;
@@ -50,13 +70,13 @@ htmlescape (const char *restrict src, const int cp)
         case '{': strcat (d, "&#123;"); d += 6; break;
         case '}': strcat (d, "&#125;"); d += 6; break;
         default:
-          if (*s >= 127) // maybe encodings, no utf8 (see htmlwescape)
+          if (c >= 127) // maybe encodings, no utf8 (see htmlwescape)
             {
-              sprintf (d, "&#x%X;", *s); // 4 + 4
+              sprintf (d, "&#x%X;", c); // 4 + 4
               d += strlen (d);
             }
-          else if (*s >= 20)
-            *d++ = *s;
+          else if (c >= 20)
+            *d++ = (char)c;
         }
     }
   *d = 0;
@@ -77,17 +97,26 @@ htmlwescape (BITCODE_TU wstr)
     len++;
   len += 16;
   d = dest = malloc (len);
+  if (!dest)
+    return NULL;
+  *d = 0;
 
-  while (*wstr++)
+  while ((c = *wstr++))
     {
-      const int off = d - dest;
+      const int off = (int)(d - dest);
       if (off >= len - 8)
         {
           len += 16;
-          dest = realloc (dest, len);
+          char *tmp2 = realloc (dest, len);
+          if (!tmp2)
+            {
+              free (dest);
+              return NULL;
+            }
+          dest = tmp2;
           d = dest + off;
         }
-      switch (*wstr)
+      switch (c)
         {
         case 34: strcat (d, "&quot;"); d += 6; break;
         case 39: strcat (d, "&#39;"); d += 5; break;
@@ -98,13 +127,13 @@ htmlwescape (BITCODE_TU wstr)
         case 123: strcat (d, "&#123;"); d += 6; break;
         case 125: strcat (d, "&#125;"); d += 6; break;
         default:
-          if (*wstr >= 127) // utf8 encodings
+          if (c >= 127) // utf8 encodings
             {
-              sprintf (d, "&#x%X;", *wstr);
+              sprintf (d, "&#x%X;", c);
               d += strlen (d);
             }
-          else if (*wstr >= 20)
-            *d++ = *wstr;
+          else if (c >= 20)
+            *d++ = (char)c;
         }
     }
   *d = 0;