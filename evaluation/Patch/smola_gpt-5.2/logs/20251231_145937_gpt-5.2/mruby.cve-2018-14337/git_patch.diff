diff --git a/mrbgems/mruby-sprintf/src/sprintf.c b/mrbgems/mruby-sprintf/src/sprintf.c
index 7eea1a1..409f742 100644
--- a/mrbgems/mruby-sprintf/src/sprintf.c
+++ b/mrbgems/mruby-sprintf/src/sprintf.c
@@ -120,9 +120,18 @@ mrb_fix2binstr(mrb_state *mrb, mrb_value x, int base)
 
 #define CHECK(l) do {\
 /*  int cr = ENC_CODERANGE(result);*/\
-  while ((l) >= bsiz - blen) {\
-    bsiz*=2;\
-    if (bsiz < 0) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
+  mrb_int need__ = (mrb_int)(l);\
+  mrb_int total__;\
+  /* reject negative values and avoid undefined behavior in size computations */\
+  if (need__ < 0) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
+  /* check blen + need__ overflow */\
+  if (need__ > MRB_INT_MAX - blen) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
+  total__ = blen + need__;\
+  if (total__ < 0 || total__ > MRB_INT_MAX/2) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
+  while (bsiz < total__) {\
+    /* avoid signed integer overflow */\
+    if (bsiz > MRB_INT_MAX/2) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
+    bsiz *= 2;\
   }\
   mrb_str_resize(mrb, result, bsiz);\
 /*  ENC_CODERANGE_SET(result, cr);*/\
diff --git a/src/string.c b/src/string.c
index 8ebd11b..db895a7 100644
--- a/src/string.c
+++ b/src/string.c
@@ -709,6 +709,9 @@ mrb_str_resize(mrb_state *mrb, mrb_value str, mrb_int len)
   struct RString *s = mrb_str_ptr(str);
 
   mrb_str_modify(mrb, s);
+  if (len < 0) {
+    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative string size");
+  }
   slen = RSTR_LEN(s);
   if (len != slen) {
     if (slen < len || slen - len > 256) {