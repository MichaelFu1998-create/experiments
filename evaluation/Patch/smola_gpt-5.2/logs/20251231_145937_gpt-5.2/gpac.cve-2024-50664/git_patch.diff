diff --git a/src/isomedia/sample_descs.c b/src/isomedia/sample_descs.c
index 8c18075..398c923 100644
--- a/src/isomedia/sample_descs.c
+++ b/src/isomedia/sample_descs.c
@@ -1743,6 +1743,7 @@ GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const ch
 	GF_Err e;
 	u32 dataRefIndex;
 	GF_MPEGAudioSampleEntryBox *mpa;
+	Bool mpa_in_list = GF_FALSE;
 
 	e = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);
 	if (e) return e;
@@ -1783,22 +1784,53 @@ GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const ch
 	if (!mpa) return GF_OUT_OF_MEM;
 	mpa->dataReferenceIndex = dataRefIndex;
 	gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);
+	mpa_in_list = GF_TRUE;
 	if (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);
 
 	if (dsi) {
+		u32 cfg_size;
 		mpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);
-		if (!mpa->cfg_mha) return GF_OUT_OF_MEM;
+		if (!mpa->cfg_mha) {
+			e = GF_OUT_OF_MEM;
+			goto exit;
+		}
 		mpa->cfg_mha->configuration_version = dsi[0];
 		mpa->cfg_mha->mha_pl_indication = dsi[1];
 		mpa->cfg_mha->reference_channel_layout = dsi[2];
-		mpa->cfg_mha->mha_config_size = dsi[3];
-		mpa->cfg_mha->mha_config_size <<= 8;
-		mpa->cfg_mha->mha_config_size |= dsi[4];
-		mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);
-		if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;
-		memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);
+		cfg_size = dsi[3];
+		cfg_size <<= 8;
+		cfg_size |= dsi[4];
+		mpa->cfg_mha->mha_config_size = (u16) cfg_size;
+
+		/* dsi format: 5 bytes header + mha_config_size bytes payload */
+		if (!cfg_size) {
+			if (dsi_size != 5) {
+				e = GF_NON_COMPLIANT_BITSTREAM;
+				goto exit;
+			}
+			mpa->cfg_mha->mha_config = NULL;
+		} else {
+			if (dsi_size < 5 + cfg_size) {
+				e = GF_NON_COMPLIANT_BITSTREAM;
+				goto exit;
+			}
+			mpa->cfg_mha->mha_config = gf_malloc(cfg_size);
+			if (!mpa->cfg_mha->mha_config) {
+				e = GF_OUT_OF_MEM;
+				goto exit;
+			}
+			memcpy(mpa->cfg_mha->mha_config, dsi+5, cfg_size);
+		}
 	}
 	return GF_OK;
+
+exit:
+	/* remove the partially-created entry from the stsd to avoid leaving corrupted state */
+	if (mpa_in_list) {
+		gf_list_del_item(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);
+	}
+	gf_isom_box_del((GF_Box *) mpa);	
+	return e;
 }
 
 #endif	/*GPAC_DISABLE_ISOM_WRITE*/