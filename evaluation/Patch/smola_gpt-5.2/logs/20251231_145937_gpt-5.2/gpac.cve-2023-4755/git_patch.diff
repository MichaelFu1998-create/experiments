diff --git a/src/filters/mux_isom.c b/src/filters/mux_isom.c
index 4044ef1..a2bee48 100644
--- a/src/filters/mux_isom.c
+++ b/src/filters/mux_isom.c
@@ -3990,10 +3990,17 @@ static GF_Err mp4_mux_configure_pid(GF_Filter *filter, GF_FilterPid *pid, Bool i
 	if (is_remove) {
 		TrackWriter *tkw = gf_filter_pid_get_udta(pid);
 		if (tkw) {
+			/* the PID is being disconnected, ensure we do not keep stale pointers */
+			if (ctx->ref_tkw == tkw)
+				ctx->ref_tkw = NULL;
+			gf_filter_pid_set_udta(pid, NULL);
 			gf_list_del_item(ctx->tracks, tkw);
-			gf_free(tkw);
+			mp4_mux_track_writer_del(tkw);
 		}
 		//removing last pid
+		/* if reference track was removed, pick the first remaining track if any */
+		if (!ctx->ref_tkw)
+			ctx->ref_tkw = gf_list_get(ctx->tracks, 0);
 		if (ctx->opid && !gf_list_count(ctx->tracks)) {
 			if (ctx->file) {
 				//non-frag file, flush file
@@ -6629,6 +6636,8 @@ static GF_Err mp4_mux_process_fragmented(GF_MP4MuxCtx *ctx)
 		Bool is_eos = (count == nb_eos) ? GF_TRUE : GF_FALSE;
 		u32 ref_timescale;
 		Bool flush_refs = ctx->dash_mode ? GF_FALSE : GF_TRUE;
+		if (!ctx->ref_tkw)
+			goto check_eos;
 		u64 next_ref_ts = ctx->ref_tkw->next_seg_cts;
 		if (is_eos)
 			next_ref_ts = ctx->ref_tkw->cts_next;