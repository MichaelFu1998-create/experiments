diff --git a/src/isomedia/isom_write.c b/src/isomedia/isom_write.c
index 11e3f1c..961c1e3 100644
--- a/src/isomedia/isom_write.c
+++ b/src/isomedia/isom_write.c
@@ -3398,9 +3398,19 @@ GF_Err gf_isom_use_compact_size(GF_ISOFile *movie, u32 trackNumber, Bool Compact
 	if (stsz->sampleSize) {
 		//this is a weird table indeed ;)
 		if (stsz->sizes) gf_free(stsz->sizes);
-		stsz->sizes = (u32*) gf_malloc(sizeof(u32)*stsz->sampleCount);
-		if (!stsz->sizes) return GF_OUT_OF_MEM;
-		memset(stsz->sizes, stsz->sampleSize, sizeof(u32));
+		stsz->sizes = NULL;
+		/* If sampleCount is 0, do not allocate/fill anything. Note that some
+		 * allocators may return a non-NULL pointer for malloc(0), which would make
+		 * any write to that pointer overflow a 0-sized allocation.
+		 */
+		if (stsz->sampleCount) {
+			/* guard against multiplication overflow */
+			if (stsz->sampleCount > (u32)(((size_t)-1) / sizeof(u32))) return GF_OUT_OF_MEM;
+			stsz->sizes = (u32*) gf_malloc(sizeof(u32) * stsz->sampleCount);
+			if (!stsz->sizes) return GF_OUT_OF_MEM;
+			for (i = 0; i < stsz->sampleCount; i++)
+				stsz->sizes[i] = stsz->sampleSize;
+		}
 	}
 	//set the SampleSize to 0 while the file is open
 	stsz->sampleSize = 0;