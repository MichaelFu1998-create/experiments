diff --git a/libarchive/archive_string.c b/libarchive/archive_string.c
index bd39c96..3bfd29d 100644
--- a/libarchive/archive_string.c
+++ b/libarchive/archive_string.c
@@ -779,7 +779,7 @@ archive_string_append_from_wcs(struct archive_string *as,
 	 * it's thread-safe. */
 	int n, ret_val = 0;
 	char *p;
-	char *end;
+	size_t mbmax;
 #if HAVE_WCRTOMB
 	mbstate_t shift_state;
 
@@ -788,26 +788,47 @@ archive_string_append_from_wcs(struct archive_string *as,
 	/* Clear the shift state before starting. */
 	wctomb(NULL, L'\0');
 #endif
+	/*
+	 * Ensure we always have room for the next converted multibyte sequence
+	 * (up to MB_CUR_MAX bytes) plus a trailing NUL.
+	 *
+	 * Some locales can have MB_CUR_MAX > 2, so len*2 growth is unsafe.
+	 */
+	mbmax = (size_t)MB_CUR_MAX;
+	if (mbmax < 1)
+		mbmax = 1;
+
 	/*
 	 * Allocate buffer for MBS.
 	 * We need this allocation here since it is possible that
 	 * as->s is still NULL.
 	 */
-	if (archive_string_ensure(as, as->length + len + 1) == NULL)
+	if (len > (SIZE_MAX - as->length - 1) / mbmax) {
+		errno = ENOMEM;
+		return (-1);
+	}
+	if (archive_string_ensure(as, as->length + len * mbmax + 1) == NULL)
 		return (-1);
 
 	p = as->s + as->length;
-	end = as->s + as->buffer_length - MB_CUR_MAX -1;
 	while (*w != L'\0' && len > 0) {
-		if (p >= end) {
-			as->length = p - as->s;
+		size_t used = (size_t)(p - as->s);
+		size_t avail = (used < as->buffer_length)
+		    ? (as->buffer_length - used)
+		    : 0;
+		/* Need mbmax bytes for next char plus one for NUL. */
+		if (avail <= mbmax) {
+			as->length = used;
 			as->s[as->length] = '\0';
 			/* Re-allocate buffer for MBS. */
+			if (len > (SIZE_MAX - as->length - 1) / mbmax) {
+				errno = ENOMEM;
+				return (-1);
+			}
 			if (archive_string_ensure(as,
-			    as->length + len * 2 + 1) == NULL)
+			    as->length + len * mbmax + 1) == NULL)
 				return (-1);
 			p = as->s + as->length;
-			end = as->s + as->buffer_length - MB_CUR_MAX -1;
 		}
 #if HAVE_WCRTOMB
 		n = wcrtomb(p, *w++, &shift_state);
@@ -827,7 +848,7 @@ archive_string_append_from_wcs(struct archive_string *as,
 			p += n;
 		len--;
 	}
-	as->length = p - as->s;
+	as->length = (size_t)(p - as->s);
 	as->s[as->length] = '\0';
 	return (ret_val);
 }