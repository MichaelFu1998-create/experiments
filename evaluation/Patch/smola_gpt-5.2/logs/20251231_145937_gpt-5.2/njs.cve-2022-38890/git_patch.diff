diff --git a/src/njs_utf8.h b/src/njs_utf8.h
index 26c23db..3f01ffc 100644
--- a/src/njs_utf8.h
+++ b/src/njs_utf8.h
@@ -49,11 +49,27 @@ njs_utf8_next(const u_char *p, const u_char *end)
 {
     u_char  c;
 
+    /*
+     * The function is frequently used to iterate over UTF-8 strings where
+     * the caller provides an end pointer.  Historically it assumed that
+     * the input is a valid UTF-8 string and that p < end.
+     *
+     * In practice, some callers may pass p == end (e.g. when calculating
+     * offsets close to the end) or the data may not be a valid UTF-8 byte
+     * sequence.  In such cases, the old implementation could dereference
+     * end when looking for continuation bytes, leading to OOB reads and
+     * crashes under sanitizers.
+     */
+
+    if (njs_slow_path(p >= end)) {
+        return end;
+    }
+
     c = *p++;
 
     if ((c & 0x80) != 0) {
 
-        do {
+        while (p < end) {
             c = *p;
 
             if ((c & 0xC0) != 0x80) {
@@ -61,8 +77,7 @@ njs_utf8_next(const u_char *p, const u_char *end)
             }
 
             p++;
-
-        } while (p < end);
+        }
     }
 
     return p;