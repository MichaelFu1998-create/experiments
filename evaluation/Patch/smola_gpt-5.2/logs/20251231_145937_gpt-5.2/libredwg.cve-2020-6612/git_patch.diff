diff --git a/src/decode_r2007.c b/src/decode_r2007.c
index 37527b9..963386c 100644
--- a/src/decode_r2007.c
+++ b/src/decode_r2007.c
@@ -20,6 +20,7 @@
 #include <stdio.h>
 #include <stdlib.h>
 #include <stdint.h>
+#include <stddef.h>
 #include <sys/types.h>
 #include <stdbool.h>
 #include <assert.h>
@@ -158,17 +159,20 @@ static r2007_page *read_pages_map (Bit_Chain *dat, int64_t size_comp,
                                    int64_t correction) ATTRIBUTE_MALLOC;
 static int read_file_header (Bit_Chain *restrict dat,
                              r2007_file_header *restrict file_header);
-static void read_instructions (BITCODE_RC *restrict *restrict src,
-                               BITCODE_RC *restrict opcode,
-                               uint32_t *restrict offset,
-                               uint32_t *restrict length);
+static int read_instructions (BITCODE_RC *restrict *restrict src,
+                              BITCODE_RC *restrict src_end,
+                              BITCODE_RC *restrict opcode,
+                              uint32_t *restrict offset,
+                              uint32_t *restrict length);
 static inline BITCODE_RC *copy_bytes_2 (BITCODE_RC *restrict dst,
                                         const BITCODE_RC *restrict src);
 static inline BITCODE_RC *copy_bytes_3 (BITCODE_RC *restrict dst,
                                         const BITCODE_RC *restrict src);
 static void copy_bytes (BITCODE_RC *dst, uint32_t length, uint32_t offset);
-static uint32_t read_literal_length (BITCODE_RC *restrict *restrict src,
-                                     unsigned char opcode);
+static int read_literal_length (BITCODE_RC *restrict *restrict src,
+                                BITCODE_RC *restrict src_end,
+                                unsigned char opcode,
+                                uint32_t *restrict out_length);
 static void copy_compressed_bytes (BITCODE_RC *restrict dst,
                                    BITCODE_RC *restrict src, int length);
 static DWGCHAR *bfr_read_string (BITCODE_RC *restrict *restrict src,
@@ -392,14 +396,21 @@ copy_compressed_bytes (BITCODE_RC *restrict dst, BITCODE_RC *restrict src,
 }
 
 /* See spec version 5.1 page 50 */
-static uint32_t
-read_literal_length (BITCODE_RC *restrict *src, unsigned char opcode)
+static int
+read_literal_length (BITCODE_RC *restrict *src, BITCODE_RC *restrict src_end,
+                     unsigned char opcode, uint32_t *restrict out_length)
 {
   uint32_t length = opcode + 8;
 
   if (length == 0x17)
     {
-      int n = *(*src)++;
+      int n;
+      if (*src >= src_end)
+        {
+          LOG_ERROR ("Decompression error: truncated literal length");
+          return DWG_ERR_INTERNALERROR;
+        }
+      n = *(*src)++;
 
       length += n;
 
@@ -407,6 +418,11 @@ read_literal_length (BITCODE_RC *restrict *src, unsigned char opcode)
         {
           do
             {
+              if ((*src + 1) >= src_end)
+                {
+                  LOG_ERROR ("Decompression error: truncated literal length");
+                  return DWG_ERR_INTERNALERROR;
+                }
               n = *(*src)++;
               n |= (*(*src)++ << 8);
 
@@ -416,18 +432,32 @@ read_literal_length (BITCODE_RC *restrict *src, unsigned char opcode)
         }
     }
 
-  return length;
+  *out_length = length;
+  return 0;
 }
 
 /* See spec version 5.1 page 53 */
-static void
-read_instructions (BITCODE_RC *restrict *src, unsigned char *restrict opcode,
-                   uint32_t *restrict offset, uint32_t *restrict length)
+static int
+read_instructions (BITCODE_RC *restrict *src, BITCODE_RC *restrict src_end,
+                   unsigned char *restrict opcode, uint32_t *restrict offset,
+                   uint32_t *restrict length)
 {
+#define NEED_BYTES(n)                                                          \
+  do                                                                           \
+    {                                                                          \
+      if ((src_end - *src) < (ptrdiff_t)(n))                                   \
+        {                                                                      \
+          LOG_ERROR ("Decompression error: truncated instructions");           \
+          return DWG_ERR_INTERNALERROR;                                        \
+        }                                                                      \
+    }                                                                          \
+  while (0)
+
   switch (*opcode >> 4)
     {
     case 0:
       *length = (*opcode & 0xf) + 0x13;
+      NEED_BYTES (2);
       *offset = *(*src)++;
       *opcode = *(*src)++;
       *length = ((*opcode >> 3) & 0x10) + *length;
@@ -436,24 +466,28 @@ read_instructions (BITCODE_RC *restrict *src, unsigned char *restrict opcode,
 
     case 1:
       *length = (*opcode & 0xf) + 3;
+      NEED_BYTES (2);
       *offset = *(*src)++;
       *opcode = *(*src)++;
       *offset = ((*opcode & 0xf8) << 5) + 1 + *offset;
       break;
 
     case 2:
+      NEED_BYTES (2);
       *offset = *(*src)++;
       *offset = ((*(*src)++ << 8) & 0xff00) | *offset;
       *length = *opcode & 7;
 
       if ((*opcode & 8) == 0)
         {
+          NEED_BYTES (1);
           *opcode = *(*src)++;
           *length = (*opcode & 0xf8) + *length;
         }
       else
         {
           (*offset)++;
+          NEED_BYTES (2);
           *length = (*(*src)++ << 3) + *length;
           *opcode = *(*src)++;
           *length = (((*opcode & 0xf8) << 8) + *length) + 0x100;
@@ -463,6 +497,7 @@ read_instructions (BITCODE_RC *restrict *src, unsigned char *restrict opcode,
     default:
       *length = *opcode >> 4;
       *offset = *opcode & 15;
+      NEED_BYTES (1);
       *opcode = *(*src)++;
       *offset = (((*opcode & 0xf8) << 1) + *offset) + 1;
       break;
@@ -484,16 +519,26 @@ decompress_r2007 (BITCODE_RC *restrict dst, int dst_size,
   BITCODE_RC *src_end = src + src_size;
   unsigned char opcode;
 
-  if (!src)
+  if (!src || src_size <= 0)
     {
       LOG_ERROR ("Empty src argument to %s\n", __FUNCTION__);
       return DWG_ERR_INTERNALERROR;
     }
+  if (src >= src_end)
+    {
+      LOG_ERROR ("Decompression error: empty input");
+      return DWG_ERR_INTERNALERROR;
+    }
   opcode = *src++;
   LOG_INSANE ("decompress_r2007(%p %d %p %d)\n", dst, dst_size, src, src_size);
 
   if ((opcode & 0xf0) == 0x20)
     {
+      if ((src + 3) > src_end)
+        {
+          LOG_ERROR ("Decompression error: truncated header");
+          return DWG_ERR_INTERNALERROR;
+        }
       src += 2;
       length = *src++ & 0x07;
 
@@ -507,13 +552,22 @@ decompress_r2007 (BITCODE_RC *restrict dst, int dst_size,
   while (src < src_end)
     {
       if (length == 0)
-        length = read_literal_length (&src, opcode);
+        {
+          int error = read_literal_length (&src, src_end, opcode, &length);
+          if (error)
+            return error;
+        }
 
       if ((dst + length) > dst_end)
         {
           LOG_ERROR ("Decompression error: length overflow");
           return DWG_ERR_INTERNALERROR;
         }
+      if ((src + length) > src_end)
+        {
+          LOG_ERROR ("Decompression error: input overrun");
+          return DWG_ERR_INTERNALERROR;
+        }
 
       // LOG_INSANE("copy_compressed_bytes(%p %p %u)\n", dst, src, length);
       copy_compressed_bytes (dst, src, length);
@@ -528,7 +582,11 @@ decompress_r2007 (BITCODE_RC *restrict dst, int dst_size,
 
       opcode = *src++;
 
-      read_instructions (&src, &opcode, &offset, &length);
+      {
+        int error = read_instructions (&src, src_end, &opcode, &offset, &length);
+        if (error)
+          return error;
+      }
 
       while (1)
         {
@@ -559,8 +617,11 @@ decompress_r2007 (BITCODE_RC *restrict dst, int dst_size,
           if ((opcode >> 4) == 0x0f)
             opcode &= 0xf;
 
-          read_instructions ((unsigned char **)&src, &opcode, &offset,
-                             &length);
+          {
+            int error = read_instructions ((unsigned char **)&src, src_end, &opcode, &offset, &length);
+            if (error)
+              return error;
+          }
         }
     }