diff --git a/src/njs_string.c b/src/njs_string.c
index d1ae09e..aaa7dbd 100644
--- a/src/njs_string.c
+++ b/src/njs_string.c
@@ -2524,6 +2524,20 @@ njs_string_offset(const u_char *start, const u_char *end, size_t index)
 {
     uint32_t    *map;
     njs_uint_t  skip;
+    size_t      max_index_bytes;
+
+    /*
+     * njs_string_offset() assumes that index is correct.  However, to avoid
+     * potential out-of-bounds access to the offset map we clamp index to the
+     * maximum possible number of characters which is bounded by the number of
+     * bytes in the string.  This is a safe conservative check that prevents
+     * dereferencing beyond the map when index is unexpectedly large.
+     */
+    max_index_bytes = (size_t) (end - start);
+
+    if (index > max_index_bytes) {
+        index = max_index_bytes;
+    }
 
     if (index >= NJS_STRING_MAP_STRIDE) {
         map = njs_string_map_start(end);
@@ -2532,6 +2546,10 @@ njs_string_offset(const u_char *start, const u_char *end, size_t index)
             njs_string_offset_map_init(start, end - start);
         }
 
+        /*
+         * index / NJS_STRING_MAP_STRIDE is at least 1 here, so subtract 1 is
+         * safe after clamping above.
+         */
         start += map[index / NJS_STRING_MAP_STRIDE - 1];
     }