diff --git a/src/hash.c b/src/hash.c
index fc6b6fa..54c278d 100644
--- a/src/hash.c
+++ b/src/hash.c
@@ -167,22 +167,9 @@ DEFINE_GETTER(h, size, uint32_t, size)
 DEFINE_ACCESSOR(h, ht, hash_table*, hsh.ht)
 DEFINE_SWITCHER(ht, HT)
 
-#define ea_each_used(ea, n_used, entry_var, code) do {                        \
-  hash_entry *entry_var = ea, *ea_end__ = entry_var + (n_used);               \
-  for (; entry_var < ea_end__; ++entry_var) {                                 \
-    code;                                                                     \
-  }                                                                           \
-} while (0)
+#define ea_each_used(ea, n_used, entry_var, code) do {                          hash_entry *entry_var = (ea);                                                 hash_entry *ea_end__ = entry_var ? entry_var + (n_used) : entry_var;          for (; entry_var < ea_end__; ++entry_var) {                                     code;                                                                       }                                                                           } while (0)
 
-#define ea_each(ea, size, entry_var, code) do {                               \
-  hash_entry *entry_var = ea;                                                 \
-  uint32_t size__ = size;                                                     \
-  for (; 0 < size__; ++entry_var) {                                           \
-    if (entry_deleted_p(entry_var)) continue;                                 \
-    --size__;                                                                 \
-    code;                                                                     \
-  }                                                                           \
-} while (0)
+#define ea_each(ea, size, entry_var, code) do {                                 hash_entry *entry_var = (ea);                                                 uint32_t size__ = (size);                                                     for (; entry_var && 0 < size__; ++entry_var) {                                   if (entry_deleted_p(entry_var)) continue;                                     --size__;                                                                     code;                                                                       }                                                                           } while (0)
 
 #define ib_cycle_by_key(mrb, h, key, it_var, code) do {                       \
   index_buckets_iter it_var[1];                                               \
@@ -1151,6 +1138,8 @@ static mrb_value mrb_hash_default(mrb_state *mrb, mrb_value hash);
 static void
 hash_modify(mrb_state *mrb, mrb_value hash)
 {
+  /* Ensure the value is actually a Hash before accessing its pointer. */
+  mrb_ensure_hash_type(mrb, hash);
   mrb_check_frozen(mrb, mrb_hash_ptr(hash));
 }