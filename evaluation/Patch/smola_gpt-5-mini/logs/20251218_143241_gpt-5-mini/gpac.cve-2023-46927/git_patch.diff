diff --git a/src/isomedia/isom_write.c b/src/isomedia/isom_write.c
index 11e3f1c..0c2568f 100644
--- a/src/isomedia/isom_write.c
+++ b/src/isomedia/isom_write.c
@@ -3395,13 +3395,18 @@ GF_Err gf_isom_use_compact_size(GF_ISOFile *movie, u32 trackNumber, Bool Compact
 	//fill the table. Although it seems weird , this is needed in case of edition
 	//after the function is called. NOte however than we force regular table
 	//at write time if all samples are of same size
-	if (stsz->sampleSize) {
-		//this is a weird table indeed ;)
+		if (stsz->sampleSize) {
+		// this is a weird table indeed ;)
 		if (stsz->sizes) gf_free(stsz->sizes);
-		stsz->sizes = (u32*) gf_malloc(sizeof(u32)*stsz->sampleCount);
-		if (!stsz->sizes) return GF_OUT_OF_MEM;
-		memset(stsz->sizes, stsz->sampleSize, sizeof(u32));
+		if (stsz->sampleCount == 0) {
+			stsz->sizes = NULL;
+		} else {
+			stsz->sizes = (u32*) gf_malloc(sizeof(u32) * stsz->sampleCount);
+			if (!stsz->sizes) return GF_OUT_OF_MEM;
+			for (i = 0; i < stsz->sampleCount; i++) stsz->sizes[i] = stsz->sampleSize;
+		}
 	}
+
 	//set the SampleSize to 0 while the file is open
 	stsz->sampleSize = 0;
 	stsz->type = GF_ISOM_BOX_TYPE_STZ2;