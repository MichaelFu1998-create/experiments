diff --git a/libyara/exec.c b/libyara/exec.c
index c4eeb7e..e76b8a7 100644
--- a/libyara/exec.c
+++ b/libyara/exec.c
@@ -1061,7 +1061,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_SHR:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_SHR: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       if (r2.i < 0)
@@ -1076,7 +1075,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_SHL:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_SHL: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       if (r2.i < 0)
@@ -1091,7 +1089,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_BITWISE_NOT:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_BITWISE_NOT: // %s()\n", __FUNCTION__);
-      pop(r1);
       ensure_defined(r1);
       r1.i = ~r1.i;
       push(r1);
@@ -1101,7 +1098,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_BITWISE_AND: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i & r2.i;
@@ -1112,7 +1108,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_BITWISE_OR: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i | r2.i;
@@ -1123,7 +1118,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_BITWISE_XOR: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i ^ r2.i;
@@ -1179,7 +1173,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_MATCH_RULE:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_MATCH_RULE: // %s()\n", __FUNCTION__);
-      pop(r1);
 
       r2.i = yr_unaligned_u64(ip);
       ip += sizeof(uint64_t);
@@ -1251,7 +1244,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_OBJ_VALUE:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_OBJ_VALUE: // %s()\n", __FUNCTION__);
-      pop(r1);
       ensure_defined(r1);
 
 #if YR_PARANOID_EXEC
@@ -1288,7 +1280,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INDEX_ARRAY:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_INDEX_ARRAY: // %s()\n", __FUNCTION__);
-      pop(r1);  // index
       pop(r2);  // array
 
       ensure_defined(r1);
@@ -1311,7 +1302,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_LOOKUP_DICT:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_LOOKUP_DICT: // %s()\n", __FUNCTION__);
-      pop(r1);  // key
       pop(r2);  // dictionary
 
       ensure_defined(r1);
@@ -1353,7 +1343,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
       while (i > 0)
       {
-        pop(r1);
 
         if (is_undef(r1))  // count the number of undefined args
           count++;
@@ -1422,7 +1411,21 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       break;
 
     case OP_FOUND:
+      YR_DEBUG_FPRINTF(2, stderr, "- case OP_FOUND: // %s()\n", __FUNCTION__);
       pop(r1);
+      ensure_defined(r1);
+
+#if YR_PARANOID_EXEC
+      ensure_within_rules_arena(r1.s);
+#endif
+
+      if ((size_t) r1.s->idx >= (size_t) context->rules->num_strings)
+      {
+        r2.i = YR_UNDEFINED;
+        push(r2);
+        break;
+      }
+
       r2.i = context->matches[r1.s->idx].tail != NULL ? 1 : 0;
       YR_DEBUG_FPRINTF(
           2,
@@ -1432,7 +1435,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
           __FUNCTION__);
       push(r2);
       break;
-
     case OP_FOUND_AT:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_FOUND_AT: // %s()\n", __FUNCTION__);
@@ -1470,7 +1472,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
           2, stderr, "- case OP_FOUND_IN: // %s()\n", __FUNCTION__);
       pop(r3);
       pop(r2);
-      pop(r1);
 
       ensure_defined(r1);
       ensure_defined(r2);
@@ -1501,7 +1502,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
 
     case OP_COUNT:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_COUNT: // %s()\n", __FUNCTION__);
-      pop(r1);
 
 #if YR_PARANOID_EXEC
       ensure_within_rules_arena(r1.p);
@@ -1548,7 +1548,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_OFFSET:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_OFFSET: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
 
       ensure_defined(r1);
 
@@ -1576,7 +1575,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_LENGTH:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_LENGTH: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
 
       ensure_defined(r1);
 
@@ -1608,7 +1606,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
       assert(r2.i == OF_STRING_SET || r2.i == OF_RULE_SET);
       found = 0;
       count = 0;
-      pop(r1);
 
       while (!is_undef(r1))
       {
@@ -2003,7 +2000,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_STR_TO_BOOL:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_STR_TO_BOOL: // %s()\n", __FUNCTION__);
-      pop(r1);
       ensure_defined(r1);
       r1.i = r1.ss->length > 0;
       push(r1);
@@ -2012,7 +2008,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_EQ:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_EQ: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i == r2.i;
@@ -2022,7 +2017,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_NEQ:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_NEQ: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i != r2.i;
@@ -2032,7 +2026,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_LT:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_LT: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i < r2.i;
@@ -2042,7 +2035,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_GT:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_GT: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i > r2.i;
@@ -2052,7 +2044,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_LE:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_LE: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i <= r2.i;
@@ -2062,7 +2053,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_GE:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_GE: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i >= r2.i;
@@ -2072,7 +2062,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_ADD:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_ADD: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i + r2.i;
@@ -2082,7 +2071,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_SUB:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_SUB: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i - r2.i;
@@ -2092,7 +2080,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_MUL:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_MUL: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.i * r2.i;
@@ -2102,7 +2089,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_DIV:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_INT_DIV: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       // If divisor is zero the result is undefined. It's also undefined
@@ -2117,7 +2103,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_INT_MINUS:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_INT_MINUS: // %s()\n", __FUNCTION__);
-      pop(r1);
       ensure_defined(r1);
       r1.i = -r1.i;
       push(r1);
@@ -2126,7 +2111,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_LT:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_LT: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       if (is_undef(r1) || is_undef(r2))
         r1.i = false;
       else
@@ -2147,7 +2131,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_LE:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_LE: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.d <= r2.d;
@@ -2157,7 +2140,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_GE:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_GE: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = r1.d >= r2.d;
@@ -2167,7 +2149,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_EQ:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_EQ: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = fabs(r1.d - r2.d) < DBL_EPSILON;
@@ -2177,7 +2158,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_NEQ:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_NEQ: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.i = fabs(r1.d - r2.d) >= DBL_EPSILON;
@@ -2187,7 +2167,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_ADD:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_ADD: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.d = r1.d + r2.d;
@@ -2197,7 +2176,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_SUB:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_SUB: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.d = r1.d - r2.d;
@@ -2207,7 +2185,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_MUL:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_MUL: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.d = r1.d * r2.d;
@@ -2217,7 +2194,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_DIV:
       YR_DEBUG_FPRINTF(2, stderr, "- case OP_DBL_DIV: // %s()\n", __FUNCTION__);
       pop(r2);
-      pop(r1);
       ensure_defined(r2);
       ensure_defined(r1);
       r1.d = r1.d / r2.d;
@@ -2227,7 +2203,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_DBL_MINUS:
       YR_DEBUG_FPRINTF(
           2, stderr, "- case OP_DBL_MINUS: // %s()\n", __FUNCTION__);
-      pop(r1);
       ensure_defined(r1);
       r1.d = -r1.d;
       push(r1);
@@ -2240,7 +2215,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_STR_GT:
     case OP_STR_GE:
       pop(r2);
-      pop(r1);
 
       ensure_defined(r2);
       ensure_defined(r1);
@@ -2290,7 +2264,6 @@ int yr_execute_code(YR_SCAN_CONTEXT* context)
     case OP_IENDSWITH:
     case OP_IEQUALS:
       pop(r2);
-      pop(r1);
 
       ensure_defined(r1);
       ensure_defined(r2);