diff --git a/src/vm.c b/src/vm.c
index b04c9d7..12eebc2 100644
--- a/src/vm.c
+++ b/src/vm.c
@@ -1163,9 +1163,26 @@ static mrb_value
 hash_new_from_values(mrb_state *mrb, mrb_int argc, mrb_value *regs)
 {
   mrb_value hash = mrb_hash_new_capa(mrb, argc);
-  while (argc--) {
-    mrb_hash_set(mrb, hash, regs[0], regs[1]);
-    regs += 2;
+  /*
+   * regs points into the VM stack. mrb_hash_set may call into Ruby
+   * which can reallocate the stack, invalidating the regs pointer
+   * (use-after-free). To avoid this, copy the key/value pairs to a
+   * temporary buffer on the heap and iterate over that buffer.
+   */
+  if (argc > 0) {
+    size_t pairs = (size_t)argc * 2;
+    mrb_value *buf = (mrb_value *)mrb_malloc(mrb, sizeof(mrb_value) * pairs);
+    if (buf == NULL) {
+      /* mrb_malloc will raise on OOM; defensively return an empty hash */
+      return hash;
+    }
+    memcpy(buf, regs, sizeof(mrb_value) * pairs);
+    mrb_value *p = buf;
+    while (argc--) {
+      mrb_hash_set(mrb, hash, p[0], p[1]);
+      p += 2;
+    }
+    mrb_free(mrb, buf);
   }
   return hash;
 }