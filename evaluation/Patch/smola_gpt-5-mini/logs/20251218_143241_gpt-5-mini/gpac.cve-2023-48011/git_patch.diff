diff --git a/src/isomedia/box_code_base.c b/src/isomedia/box_code_base.c
index db4ca56..5bc3e94 100644
--- a/src/isomedia/box_code_base.c
+++ b/src/isomedia/box_code_base.c
@@ -7560,12 +7560,12 @@ void trun_box_del(GF_Box *s)
 	if (ptr->cache) gf_bs_del(ptr->cache);
 	if (ptr->sample_order) gf_free(ptr->sample_order);
 	if (ptr->sample_refs) {
-		while (gf_list_count(ptr->sample_refs)) {
-			GF_TrafSampleRef *sref = gf_list_pop_back(ptr->sample_refs);
-			if (!sref->ref) gf_free(sref->data);
-			gf_free(sref);
-		}
+		/* Do not free individual sample refs here: they may be consumed later
+		   by flush_ref_samples which will send and free them. Freeing them
+		   here caused use-after-free when moofs were deleted earlier. */
+		/* remove and free the list structure only */
 		gf_list_del(ptr->sample_refs);
+		ptr->sample_refs = NULL;
 	}
 	gf_free(ptr);
 }
diff --git a/src/isomedia/movie_fragments.c b/src/isomedia/movie_fragments.c
index b7f7ade..dfacf6d 100644
--- a/src/isomedia/movie_fragments.c
+++ b/src/isomedia/movie_fragments.c
@@ -928,6 +928,8 @@ GF_Err gf_isom_write_compressed_box(GF_ISOFile *mov, GF_Box *root_box, u32 repl_
 
 void flush_ref_samples(GF_ISOFile *movie, u64 *out_seg_size, Bool use_seg_marker)
 {
+	/* defensive checks: avoid dereferencing freed structures */
+	if (!movie || !movie->moof || !movie->moof->trun_list) return;
 	u32 i=0;
 	if (movie->in_sidx_write) return;
 	u32 trun_count = gf_list_count(movie->moof->trun_list);
@@ -1300,7 +1302,15 @@ static GF_Err StoreFragment(GF_ISOFile *movie, Bool load_mdat_only, s32 data_off
 	if (!movie->use_segments) {
 		//remove from moof list (may happen in regular fragmentation when single traf per moof is used)
 		gf_list_del_item(movie->moof_list, movie->moof);
+		if (!movie->moof->moof_data_len) {
+				if (!movie->moof->moof_data_len) {
 		gf_isom_box_del((GF_Box *) movie->moof);
+		} else {
+		/* deferred moof, keep for later processing */
+		}
+				} else {
+				/* deferred moof, keep for later processing */
+				}
 		movie->moof = NULL;
 	}
 	return GF_OK;
@@ -1491,7 +1501,15 @@ GF_Err gf_isom_flush_fragments(GF_ISOFile *movie, Bool last_segment)
 		e = StoreFragment(movie, GF_FALSE, offset_diff, &moof_size, GF_FALSE);
 		if (e) goto exit;
 
+		if (!movie->moof->moof_data_len) {
+				if (!movie->moof->moof_data_len) {
 		gf_isom_box_del((GF_Box *) movie->moof);
+		} else {
+		/* deferred moof, keep for later processing */
+		}
+				} else {
+				/* deferred moof, keep for later processing */
+				}
 		movie->moof = NULL;
 	}
 
@@ -2208,7 +2226,15 @@ GF_Err gf_isom_close_segment(GF_ISOFile *movie, s32 subsegments_per_sidx, GF_ISO
 			if (!defer_moofs) defer_moofs = gf_list_new();
 			gf_list_add(defer_moofs, movie->moof);
 		} else {
-			gf_isom_box_del((GF_Box *) movie->moof);
+			if (!movie->moof->moof_data_len) {
+				if (!movie->moof->moof_data_len) {
+		gf_isom_box_del((GF_Box *) movie->moof);
+		} else {
+		/* deferred moof, keep for later processing */
+		}
+				} else {
+				/* deferred moof, keep for later processing */
+				}
 		}
 		movie->moof = NULL;
 	}
@@ -2331,7 +2357,15 @@ exit:
 			flush_ref_samples(movie, out_seg_size, segment_marker_4cc ? GF_TRUE : GF_FALSE);
 
 			gf_free(movie->moof->moof_data);
-			gf_isom_box_del((GF_Box *) movie->moof);
+			if (!movie->moof->moof_data_len) {
+				if (!movie->moof->moof_data_len) {
+		gf_isom_box_del((GF_Box *) movie->moof);
+		} else {
+		/* deferred moof, keep for later processing */
+		}
+				} else {
+				/* deferred moof, keep for later processing */
+				}
 			movie->moof = NULL;
 		}
 		gf_list_del(defer_moofs);