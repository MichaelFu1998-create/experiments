diff --git a/HTMLparser.c b/HTMLparser.c
index ba3eb16d..4a6d7ddf 100644
--- a/HTMLparser.c
+++ b/HTMLparser.c
@@ -444,8 +444,14 @@ htmlCurrentChar(xmlParserCtxtPtr ctxt, int *len) {
         if (guess == NULL) {
             xmlSwitchEncoding(ctxt, XML_CHAR_ENCODING_8859_1);
         } else {
+            /*
+             * Find the handler first.  Do not free the guessed
+             * encoding name until after it may have been used in
+             * error reporting.  Freeing it earlier caused a
+             * use-after-free when htmlParseErr referenced the
+             * freed buffer.
+             */
             handler = xmlFindCharEncodingHandler((const char *) guess);
-            xmlFree(guess);
             if (handler != NULL) {
                 /*
                  * Don't use UTF-8 encoder which isn't required and
@@ -457,6 +463,7 @@ htmlCurrentChar(xmlParserCtxtPtr ctxt, int *len) {
                 htmlParseErr(ctxt, XML_ERR_INVALID_ENCODING,
                              "Unsupported encoding %s", guess, NULL);
             }
+            xmlFree(guess);
         }
         ctxt->input->flags |= XML_INPUT_HAS_ENCODING;
     }