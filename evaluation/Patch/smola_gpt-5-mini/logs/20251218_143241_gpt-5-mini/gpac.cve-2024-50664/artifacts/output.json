{"output": "Summary of work performed\n\n1) Exploration\n- Located the vulnerable function declaration in include/gpac/isomedia.h and implementation in src/isomedia/sample_descs.c: gf_isom_new_mpha_description.\n- The problematic code allocated mpa->cfg_mha->mha_config with size derived from the DSI header (mha_config_size) then unconditionally memcpy(dsi+5, dsi_size-5) into it. If dsi_size-5 > mha_config_size (or vice-versa), a heap overflow could occur.\n\n2) Analysis and options considered\n- Option A: Strictly validate that dsi_size-5 == declared mha_config_size and fail with GF_BAD_PARAM if mismatched. This is strict but may break some slightly malformed inputs.\n- Option B (chosen): Be tolerant and safe: allocate only as many bytes as are actually available in DSI, copy only that many bytes, and update the stored size accordingly. This prevents overflow and preserves as much useful data as possible.\n- Option C: Allocate max(dsi_size-5, mha_config_size) and zero-pad, but this would trust the file size and potentially store garbage.\n\nI chose Option B because it is minimal, backward-compatible, and prevents overflow while preserving available configuration data.\n\n3) Implementation (minimal change)\n- Edited src/isomedia/sample_descs.c in gf_isom_new_mpha_description. Replaced the unsafe allocation+memcpy with a guarded block that:\n  - computes hdr_size = mpa->cfg_mha->mha_config_size (from header bytes), and available = max(0, dsi_size-5)\n  - computes to_copy = min(hdr_size, available)\n  - allocates a buffer sized to_copy (allocating 1 byte if to_copy==0 to avoid passing zero to malloc implementations that might not like it)\n  - copies only to_copy bytes from dsi+5\n  - sets mpa->cfg_mha->mha_config_size = to_copy\n\nThis removes any possibility of memcpy writing past the allocated buffer.\n\n4) Verification\n- Built the project: cd /src/gpac && secb build -> BUILD COMPLETED SUCCESSFULLY\n- Ran the repro: cd /src/gpac && secb repro -> The reproducer ran; output contains warnings about unknown box type mpha but no AddressSanitizer heap-buffer-overflow or sanitizer aborts. The lines shown by the tool indicate the run completed without the ASan crash.\n\nFiles changed\n- src/isomedia/sample_descs.c\n  - The change is localized to gf_isom_new_mpha_description when filling mpa->cfg_mha->mha_config.\n\nWhy this fixes the crash\n- Previously memcpy used dsi_size-5 as the number of bytes to copy into a buffer allocated to mpa->cfg_mha->mha_config_size. If the DSI was longer than the declared header size or vice-versa, an out-of-bounds write could occur. The new code constrains the copy to the minimum available size and updates the stored size accordingly, avoiding overflow.\n\nNotes & trade-offs\n- This is intentionally tolerant: it prefers to keep available bytes rather than failing the call. If you prefer strict validation (require declared header size to exactly match provided DSI length), that can be implemented by returning GF_BAD_PARAM when mismatched. The tolerant approach is safer for robustness and avoids rejecting slightly malformed but usable inputs.\n\nIf you want, I can also:\n- Modify the behavior to be strict (reject mismatched sizes) instead of truncating.\n- Add a small unit test exercising partial/overlong DSI cases.\n\nPatch is minimal and localized; compilation and repro verification were performed and the sanitizer crash is no longer triggered.\n", "steps": [{"task": "<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity.", "task_images": null}, {"step_number": 1, "timing": {"start_time": 1766077202.467299, "end_time": 1766077205.5265474, "duration": 3.059248447418213}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_MpYsYxDD25lVOqvI6ORpmh1r", "type": "function", "function": {"name": "cmd", "arguments": {"command": "ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBe7zlgL63S0JASAMfugyI0gf3kf", "created": 1766077203, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 3041.314}, "token_usage": {"input_tokens": 3352, "output_tokens": 123, "total_tokens": 3475, "cost": 0.000483}}, "model_output": null, "code_action": null, "observations": "total 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 3352, "output_tokens": 123, "total_tokens": 3475, "cost": 0.000483}, "is_final_answer": false}, {"step_number": 2, "timing": {"start_time": 1766077205.526874, "end_time": 1766077207.0201354, "duration": 1.4932613372802734}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_vz3Wd10K2hd9rCyTofqPJ92b", "type": "function", "function": {"name": "cmd", "arguments": {"command": "grep -nR \"isom_new_mpha_description\" -n /src/gpac || true", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBe9ZCeeCrhZFboQlD1DiKaw1Uth", "created": 1766077205, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 1436.782}, "token_usage": {"input_tokens": 6526, "output_tokens": 48, "total_tokens": 6574, "cost": 0.00057575}}, "model_output": null, "code_action": null, "observations": "/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 6526, "output_tokens": 48, "total_tokens": 6574, "cost": 0.00057575}, "is_final_answer": false}, {"step_number": 3, "timing": {"start_time": 1766077207.0204177, "end_time": 1766077209.1300986, "duration": 2.1096808910369873}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_ydmJZCV9055ZdrcukitNv2qc", "type": "function", "function": {"name": "cmd", "arguments": {"command": "sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBeBgflPdJWZOXdnUwyRPKNx60uC", "created": 1766077207, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 2028.836}, "token_usage": {"input_tokens": 6824, "output_tokens": 50, "total_tokens": 6874, "cost": 0.0002694}}, "model_output": null, "code_action": null, "observations": "/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 6824, "output_tokens": 50, "total_tokens": 6874, "cost": 0.0002694}, "is_final_answer": false}, {"step_number": 4, "timing": {"start_time": 1766077209.1306458, "end_time": 1766077222.2723453, "duration": 13.14169955253601}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_UGEexjAgkNoXcXZtaak0ztFx", "type": "function", "function": {"name": "cmd", "arguments": {"command": "git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBeDlKDzAsTd1h2ERFKv9ZvvJb8v", "created": 1766077209, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 12928.67}, "token_usage": {"input_tokens": 27016, "output_tokens": 1009, "total_tokens": 28025, "cost": 0.0035881999999999997}}, "model_output": null, "code_action": null, "observations": "", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 27016, "output_tokens": 1009, "total_tokens": 28025, "cost": 0.0035881999999999997}, "is_final_answer": false}, {"step_number": 5, "timing": {"start_time": 1766077222.2727177, "end_time": 1766077239.7064548, "duration": 17.43373703956604}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_DMzZhU0XLcfdktPB2CcBfRlI", "type": "function", "function": {"name": "cmd", "arguments": {"command": "git apply -p0 << 'PATCH'\n*** Begin Patch\n*** Update File: src/isomedia/sample_descs.c\n@@\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n+        {\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\n+            u32 to_copy = hdr_size;\n+            /* If the DSI length does not match the header-declared size, don't overflow -\n+               copy only the available bytes and adjust the stored size accordingly. */\n+            if (to_copy > available) to_copy = available;\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\n+            mpa->cfg_mha->mha_config_size = to_copy;\n+        }\n*** End Patch\nPATCH"}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBeQlR7eKgELLXaewUSFXcCIdqtu", "created": 1766077222, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 17425.38}, "token_usage": {"input_tokens": 27105, "output_tokens": 1566, "total_tokens": 28671, "cost": 0.001652125}}, "model_output": null, "code_action": null, "observations": "error: unrecognized input", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 27105, "output_tokens": 1566, "total_tokens": 28671, "cost": 0.001652125}, "is_final_answer": false}, {"step_number": 6, "timing": {"start_time": 1766077239.7068985, "end_time": 1766077249.6892176, "duration": 9.982319116592407}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_RZnMzqF0uQy3Zk3VJS1QTFjY", "type": "function", "function": {"name": "cmd", "arguments": {"command": "python3 - << 'PY'\nfrom pathlib import Path\np=Path('/src/gpac/src/isomedia/sample_descs.c')\ns=p.read_text()\nold=('\\tmpa_placeholder')\n# Build the exact old block to replace (with possible tabs)\nold = \"\\tmp = 'TO_REPLACE'\"\nPY"}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBeiHChgXpIPXRWf7ToRtTRWlIWq", "created": 1766077240, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 9955.982}, "token_usage": {"input_tokens": 27501, "output_tokens": 798, "total_tokens": 28299, "cost": 0.001189625}}, "model_output": null, "code_action": null, "observations": "", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 27501, "output_tokens": 798, "total_tokens": 28299, "cost": 0.001189625}, "is_final_answer": false}, {"step_number": 7, "timing": {"start_time": 1766077249.6894991, "end_time": 1766077252.6950235, "duration": 3.0055243968963623}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_hINLURxKqfu0v6osJY6rlDhE", "type": "function", "function": {"name": "cmd", "arguments": {"command": "sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBesV89P0HKCRLvlRMmsR5WwYaO3", "created": 1766077250, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 2994.71}, "token_usage": {"input_tokens": 27644, "output_tokens": 50, "total_tokens": 27694, "cost": 0.0004383}}, "model_output": null, "code_action": null, "observations": "tcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 27644, "output_tokens": 50, "total_tokens": 27694, "cost": 0.0004383}, "is_final_answer": false}, {"step_number": 8, "timing": {"start_time": 1766077252.6952784, "end_time": 1766077268.1627, "duration": 15.467421531677246}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_XXQVyOOtryVwjOTznB0YPl7P", "type": "function", "function": {"name": "python_interpreter", "arguments": {"code": "from pathlib import Path\np=Path('/src/gpac/src/isomedia/sample_descs.c')\ns=p.read_text()\nold_snippet='mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);'\nif old_snippet not in s:\n    # try with different indentation (tabs/spaces)\n    import re\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\s*=\\s*gf_malloc\\(sizeof\\(u8\\) \\* mpa->cfg_mha->mha_config_size\\);\\s*if \\(!mpa->cfg_mha->mha_config\\) return GF_OUT_OF_MEM;\\s*memcpy\\(mpa->cfg_mha->mha_config, dsi\\+5, dsi_size-5\\);\", re.M)\n    m=pattern.search(s)\n    if not m:\n        raise SystemExit('target snippet not found')\n    start, end = m.span()\nelse:\n    start = s.index(old_snippet)\n    end = start + len(old_snippet)\nnew_block='''mpa->cfg_mha->mha_config = NULL;\n\t\t{\n\t\t\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\n\t\t\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\n\t\t\tu32 to_copy = hdr_size;\n\t\t\t/* If the DSI length does not match the header-declared size, don't overflow - copy only the available bytes and adjust the stored size accordingly. */\n\t\t\tif (to_copy > available) to_copy = available;\n\t\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\n\t\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\t\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\n\t\t\tmpa->cfg_mha->mha_config_size = to_copy;\n\t\t}\n'''\n# Replace\ns2 = s[:start] + new_block + s[end:]\n# Backup original\nbak = p.with_suffix('.c.bak')\nif not bak.exists():\n    p.write_text(s)\n    bak.write_text(s)\n# Write new content\np.write_text(s2)\nprint('patched')"}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBevG5VHvCVrADoGbeKcVXNV8hEq", "created": 1766077253, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 15460.392}, "token_usage": {"input_tokens": 28819, "output_tokens": 1485, "total_tokens": 30304, "cost": 0.001367175}}, "model_output": null, "code_action": null, "observations": "Stdout:\npatched\n\nOutput: None", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 28819, "output_tokens": 1485, "total_tokens": 30304, "cost": 0.001367175}, "is_final_answer": false}, {"step_number": 9, "timing": {"start_time": 1766077268.162965, "end_time": 1766077310.9884663, "duration": 42.82550120353699}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_X58Hy1BLXPF65jcXssiDERB1", "type": "function", "function": {"name": "cmd", "arguments": {"command": "cd /src/gpac && secb build", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBfA3YGN8jn8UttTB4XnvcPiovCj", "created": 1766077268, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 2548.374}, "token_usage": {"input_tokens": 29533, "output_tokens": 101, "total_tokens": 29634, "cost": 0.000573225}}, "model_output": null, "code_action": null, "observations": "BUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 29533, "output_tokens": 101, "total_tokens": 29634, "cost": 0.000573225}, "is_final_answer": false}, {"step_number": 10, "timing": {"start_time": 1766077310.9887488, "end_time": 1766077315.5221975, "duration": 4.533448696136475}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_1Ogeka6apzI7KHXSVWuHaFiT", "type": "function", "function": {"name": "cmd", "arguments": {"command": "cd /src/gpac && secb repro", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBfrOidtQuKBkCzwxK8IssTPmWRa", "created": 1766077311, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 4485.874}, "token_usage": {"input_tokens": 29664, "output_tokens": 227, "total_tokens": 29891, "cost": 0.0006023999999999999}}, "model_output": null, "code_action": null, "observations": "REPRODUCING THE ISSUE FOR gpac.cve-2024-50664...", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 29664, "output_tokens": 227, "total_tokens": 29891, "cost": 0.0006023999999999999}, "is_final_answer": false}, {"step_number": 11, "timing": {"start_time": 1766077315.5225065, "end_time": 1766077318.147516, "duration": 2.625009536743164}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_1Ogeka6apzI7KHXSVWuHaFiT', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_RAgOZjfFrUJTI8YBZGitpnKE", "type": "function", "function": {"name": "cmd", "arguments": {"command": "cd /src/gpac && secb repro", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBfwSj4vJYyUaPJSKEHyEOkaT2AY", "created": 1766077316, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 2578.5840000000003}, "token_usage": {"input_tokens": 29762, "output_tokens": 100, "total_tokens": 29862, "cost": 0.00048664999999999993}}, "model_output": null, "code_action": null, "observations": "REPRODUCING THE ISSUE FOR gpac.cve-2024-50664...", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 29762, "output_tokens": 100, "total_tokens": 29862, "cost": 0.00048664999999999993}, "is_final_answer": false}, {"step_number": 12, "timing": {"start_time": 1766077318.1478598, "end_time": 1766077325.8710659, "duration": 7.723206043243408}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_1Ogeka6apzI7KHXSVWuHaFiT', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RAgOZjfFrUJTI8YBZGitpnKE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_AxTVKpSexurbykN65Km2tGwi", "type": "function", "function": {"name": "cmd", "arguments": {"command": "cd /src/gpac && secb repro", "timeout": 300000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBfy5kqHX4JfLZj1OmHTbrREFgH0", "created": 1766077318, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 7676.345}, "token_usage": {"input_tokens": 29857, "output_tokens": 483, "total_tokens": 30340, "cost": 0.0008825249999999999}}, "model_output": null, "code_action": null, "observations": "REPRODUCING THE ISSUE FOR gpac.cve-2024-50664...", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 29857, "output_tokens": 483, "total_tokens": 30340, "cost": 0.0008825249999999999}, "is_final_answer": false}, {"step_number": 13, "timing": {"start_time": 1766077325.871404, "end_time": 1766077331.1978004, "duration": 5.326396465301514}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_1Ogeka6apzI7KHXSVWuHaFiT', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RAgOZjfFrUJTI8YBZGitpnKE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_AxTVKpSexurbykN65Km2tGwi', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 300000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_NN2A71ClYPoJCzuEdKOPNtus", "type": "function", "function": {"name": "cmd", "arguments": {"command": "grep -R \"gpac.cve-2024-50664\" -n /src/gpac || true", "timeout": 120000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBg6SHHN0HYcucwt4824XBxelFNF", "created": 1766077326, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 4351.242}, "token_usage": {"input_tokens": 29954, "output_tokens": 243, "total_tokens": 30197, "cost": 0.0006386499999999999}}, "model_output": null, "code_action": null, "observations": "", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 29954, "output_tokens": 243, "total_tokens": 30197, "cost": 0.0006386499999999999}, "is_final_answer": false}, {"step_number": 14, "timing": {"start_time": 1766077331.198098, "end_time": 1766077338.7792888, "duration": 7.581190824508667}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_1Ogeka6apzI7KHXSVWuHaFiT', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RAgOZjfFrUJTI8YBZGitpnKE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_AxTVKpSexurbykN65Km2tGwi', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 300000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_NN2A71ClYPoJCzuEdKOPNtus', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -R \"gpac.cve-2024-50664\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_7H5MmV5xPl9sLc192VrNJ7hp", "type": "function", "function": {"name": "cmd", "arguments": {"command": "cd /src/gpac && secb repro 2>&1 | sed -n '1,400p'", "timeout": 600000}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBgBVB0WNOlqsXK9z9jPmGURSMvp", "created": 1766077331, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 7534.187}, "token_usage": {"input_tokens": 30045, "output_tokens": 497, "total_tokens": 30542, "cost": 0.000906025}}, "model_output": null, "code_action": null, "observations": "REPRODUCING THE ISSUE FOR gpac.cve-2024-50664...\n\u001b[32m[iso file] Unknown box type mpha in parent stsd\n\u001b[0m\u001b[33m[IsoMedia] Track 1 type mpha not natively handled\n\u001b[0m\u001b[32m[Dasher] No template assigned, using $File$_dash$FS$$Number$\n\u001b[0m\u001b[32m[iso file] Unknown box type mpha in parent stsd\n\u001b[0m\u001b[37mDashing P1 AS#1.1(A) done (1 segs)\n\u001b[0m\u001b[32m[MPD] Generating MPD at time 2025-12-18T17:02:18.766Z\n\u001b[0m\u001b[32m[Dasher] End of Period \n\u001b[0m\u001b[32m[Dasher] End of MPD (no more active streams)\n\u001b[0m\u001b[37m\n\u001b[0m", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 30045, "output_tokens": 497, "total_tokens": 30542, "cost": 0.000906025}, "is_final_answer": false}, {"step_number": 15, "timing": {"start_time": 1766077338.779567, "end_time": 1766077353.8041105, "duration": 15.024543523788452}, "model_input_messages": [{"role": "system", "content": [{"type": "text", "text": "You are an expert assistant who can solve any task using tool calls. You will be given a task to solve as best you can.\nTo do so, you have been given access to some tools.\n\nThe tool call you write is an action: after the tool is executed, you will get the result of the tool call as an \"observation\".\nThis Action/Observation can repeat N times, you should take several steps when needed.\n\nYou can use the result of the previous action as input for the next action.\nThe observation will always be a string: it can represent a file, like \"image_1.jpg\".\nThen you can use it as input for the next action. You can do it for instance as follows:\n\nObservation: \"image_1.jpg\"\n\nAction:\n{\n  \"name\": \"image_transformer\",\n  \"arguments\": {\"image\": \"image_1.jpg\"}\n}\n\nTo provide the final answer to the task, use an action blob with \"name\": \"final_answer\" tool. It is the only way to complete the task, else you will be stuck on a loop. So your final output should look like this:\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": {\"answer\": \"insert your final answer here\"}\n}\n\n\nHere are a few examples using notional tools:\n---\nTask: \"Generate an image of the oldest person in this document.\"\n\nAction:\n{\n  \"name\": \"document_qa\",\n  \"arguments\": {\"document\": \"document.pdf\", \"question\": \"Who is the oldest person mentioned?\"}\n}\nObservation: \"The oldest person in the document is John Doe, a 55 year old lumberjack living in Newfoundland.\"\n\nAction:\n{\n  \"name\": \"image_generator\",\n  \"arguments\": {\"prompt\": \"A portrait of John Doe, a 55-year-old man living in Canada.\"}\n}\nObservation: \"image.png\"\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"image.png\"\n}\n\n---\nTask: \"What is the result of the following operation: 5 + 3 + 1294.678?\"\n\nAction:\n{\n    \"name\": \"python_interpreter\",\n    \"arguments\": {\"code\": \"5 + 3 + 1294.678\"}\n}\nObservation: 1302.678\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"1302.678\"\n}\n\n---\nTask: \"Which city has the highest population , Guangzhou or Shanghai?\"\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Guangzhou\"\n}\nObservation: ['Guangzhou has a population of 15 million inhabitants as of 2021.']\n\n\nAction:\n{\n    \"name\": \"web_search\",\n    \"arguments\": \"Population Shanghai\"\n}\nObservation: '26 million (2019)'\n\nAction:\n{\n  \"name\": \"final_answer\",\n  \"arguments\": \"Shanghai\"\n}\n\nAbove example were using notional tools that might not exist for you. You only have access to these tools:\n- python_interpreter: This is a tool that evaluates python code. It can be used to perform calculations.\n    Takes inputs: {'code': {'type': 'string', 'description': \"The code snippet to evaluate. All variables used in this snippet must be defined in this same snippet, else you will get an error. This code can only import the following python libraries: ['*'].\"}}\n    Returns an output of type: string\n- cmd: Execute a shell command inside the current environment and return stdout, stderr, and exit code.\n    Takes inputs: {'command': {'type': 'string', 'description': 'The shell command to execute (will be run via bash -lc).'}, 'base_dir': {'type': 'string', 'description': 'Optional base directory to run the command in.', 'nullable': True}, 'timeout': {'type': 'integer', 'description': 'Optional timeout in seconds (default 120).', 'nullable': True}}\n    Returns an output of type: string\n- final_answer: Provides a final answer to the given problem.\n    Takes inputs: {'answer': {'type': 'any', 'description': 'The final answer to the problem'}}\n    Returns an output of type: any\n\nHere are the rules you should always follow to solve your task:\n1. ALWAYS provide a tool call, else you will fail.\n2. Always use the right arguments for the tools. Never use variable names as the action arguments, use the value instead.\n3. Call a tool only when needed: do not call the search agent if you do not need information, try to solve the task yourself. If no tool call is needed, use final_answer tool to return your answer.\n4. Never re-do a tool call that you previously did with the exact same parameters.\n\nNow Begin!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "user", "content": [{"type": "text", "text": "New task:\n<uploaded_files>\n/src/gpac\n</uploaded_files>\nI've uploaded a code repository in the directory `/src/gpac`. Consider the following issue description:\n\n<issue_description>\ngpac 2.4 contains a heap-buffer-overflow at isomedia/sample_descs.c:1799 in gf_isom_new_mpha_description in gpac/MP4Box.\n---\n==3389396==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x602000003751 at pc 0x7f740dee42c3 bp 0x7ffc60ecac00 sp 0x7ffc60eca3a8\nWRITE of size 14 at 0x602000003751 thread T0\n    #0 0x7f740dee42c2 in __interceptor_memcpy ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827\n    #1 0x7f740ab53e89 in memcpy /usr/include/x86_64-linux-gnu/bits/string_fortified.h:29\n    #2 0x7f740ab53e89 in gf_isom_new_mpha_description isomedia/sample_descs.c:1799\n    #3 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #4 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #5 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #6 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #7 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #8 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #9 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #10 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #11 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n    #12 0x7f740817be3f in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x29e3f)\n    #13 0x55ba9e02ff04 in _start (/gpac2.4/bin/gcc/MP4Box+0xadf04)\n\n0x602000003751 is located 0 bytes to the right of 1-byte region [0x602000003750,0x602000003751)\nallocated by thread T0 here:\n    #0 0x7f740df5e887 in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145\n    #1 0x7f740ab53dd7 in gf_isom_new_mpha_description isomedia/sample_descs.c:1797\n    #2 0x7f740b6737ce in mp4_mux_setup_pid filters/mux_isom.c:3055\n    #3 0x7f740b2738f9 in gf_filter_pid_configure filter_core/filter_pid.c:893\n    #4 0x7f740b27c61e in gf_filter_pid_connect_task filter_core/filter_pid.c:1260\n    #5 0x7f740b2c3104 in gf_fs_thread_proc filter_core/filter_session.c:2144\n    #6 0x7f740b2c7fce in gf_fs_run filter_core/filter_session.c:2451\n    #7 0x7f740ac500ae in gf_dasher_process media_tools/dash_segmenter.c:1255\n    #8 0x55ba9e0366d5 in do_dash /gpac2.4/applications/mp4box/mp4box.c:4832\n    #9 0x55ba9e055617 in mp4box_main /gpac2.4/applications/mp4box/mp4box.c:6256\n    #10 0x7f740817bd8f  (/lib/x86_64-linux-gnu/libc.so.6+0x29d8f)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow ../../../../src/libsanitizer/sanitizer_common/sanitizer_common_interceptors.inc:827 in __interceptor_memcpy\nShadow bytes around the buggy address:\n  0x0c047fff8690: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86a0: fa fa 00 00 fa fa 00 00 fa fa fd fa fa fa 00 00\n  0x0c047fff86b0: fa fa 00 00 fa fa 00 01 fa fa 02 fa fa fa 00 00\n  0x0c047fff86c0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 00 00\n  0x0c047fff86d0: fa fa 00 00 fa fa 00 00 fa fa 00 00 fa fa 04 fa\n=>0x0c047fff86e0: fa fa 00 00 fa fa 00 00 fa fa[01]fa fa fa fa fa\n  0x0c047fff86f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8700: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8710: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8720: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fff8730: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n  Shadow gap:              cc\n==3389396==ABORTING\n</issue_description>\n\nCan you help me implement the necessary changes to the repository so that the crash points specified in the <issue_description> are resolved?\nYour task is to make the minimal changes to non-tests files in the `/src/gpac` directory to ensure the crash points specified in the <issue_description> are not triggered.\n\nFollow these steps to resolve the issue:\n1. EXPLORATION: First, thoroughly explore the repository structure using tools like `find` and `grep`.\n   - Identify the files mentioned in the bug description\n   - Locate where the vulnerability exists in the codebase\n   - Understand the surrounding context and dependencies\n   - Use `grep` to search for relevant functions, classes, or error messages\n\n2. ANALYSIS: Based on your exploration, think carefully about the security vulnerability and propose 2-3 possible approaches to fix it.\n   - Analyze the root cause of the vulnerability\n   - Consider trade-offs between different solutions\n   - Select the most promising approach and explain your reasoning\n\n3. IMPLEMENTATION: Edit the source code to implement your chosen solution.\n   - Make minimal, focused changes to fix the vulnerability\n   - Ensure your changes do not introduce new security issues\n\n4. VERIFICATION: Test your implementation thoroughly.\n   - Change to the `/src/gpac` directory\n   - Run `secb build` to build the project and check for compilation errors\n   - If compilation succeeds, run `secb repro` to verify the fix prevents the crash\n   - If the fix fails, revise your implementation until the crash is prevented\n   - **IMPORTANT: Keep iterating until `secb repro` confirms that the sanitizer error is NOT triggered. This is the success criterion.**\n\n5. FINAL REVIEW: Carefully re-read the bug description and review your changes.\n   - Ensure you've fully addressed the security vulnerability\n   - Confirm the fix is minimal and focused on the specific issue\n   - Verify no unintended side effects are introduced\n\n**CRITICAL SUCCESS CRITERION**: Your implementation is successful only when `secb repro` runs without triggering any sanitizer errors. Continue refining your solution until this criterion is met.\n\nBe thorough in your exploration, analysis, and reasoning. It's fine if your thinking process is lengthy - quality and completeness are more important than brevity."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_MpYsYxDD25lVOqvI6ORpmh1r', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"ls -la /src/gpac && find /src/gpac -maxdepth 3 -type f | sed -n '1,200p'\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntotal 348\ndrwxr-xr-x  1 root root  4096 Dec 18 16:59 .\ndrwxrwxrwx  1 root root  4096 May 31  2025 ..\ndrwxr-xr-x  8 root root  4096 May 31  2025 .git\n-rw-r--r--  1 root root   427 May 31  2025 .gitattributes\ndrwxr-xr-x  3 root root  4096 May 31  2025 .github\n-rw-r--r--  1 root root   747 May 31  2025 .gitignore\n-rw-r--r--  1 root root   120 May 31  2025 .gitmodules\n-rw-r--r--  1 root root  4786 May 31  2025 .travis.yml\n-rw-r--r--  1 root root 26428 May 31  2025 COPYING\n-rw-r--r--  1 root root 70709 May 31  2025 Changelog\n-rw-r--r--  1 root root 13245 May 31  2025 Makefile\n-rw-r--r--  1 root root  7921 May 31  2025 README.md\n-rw-r--r--  1 root root  1267 May 31  2025 SECURITY.md\ndrwxr-xr-x  7 root root  4096 May 31  2025 applications\ndrwxr-xr-x  7 root root  4096 May 31  2025 build\n-rwxr-xr-x  1 root root  2046 May 31  2025 change_version.sh\n-rwxr-xr-x  1 root root   998 May 31  2025 check_revision.sh\n-rwxr-xr-x  1 root root 87628 May 31  2025 configure\ndrwxr-xr-x  2 root root  4096 May 31  2025 debian\ndrwxr-xr-x  2 root root  4096 May 31  2025 extra_lib\n-rw-r--r--  1 root root   567 May 31  2025 flake.lock\n-rw-r--r--  1 root root  1229 May 31  2025 flake.nix\n-rw-r--r--  1 root root  3935 May 31  2025 generate_installer.bat\n-rw-r--r--  1 root root  2938 May 31  2025 gpac.spec\ndrwxr-xr-x  5 root root  4096 May 31  2025 include\n-rw-r--r--  1 root root    37 May 31  2025 manifest.rc\n-rwxr-xr-x  1 root root  4395 May 31  2025 mkdmg.sh\ndrwxr-xr-x 20 root root  4096 May 31  2025 modules\ndrwxr-xr-x  4 root root  4096 May 31  2025 packagers\n-rwxr-xr-x  1 root root   742 May 31  2025 run_configure.sh\ndrwxr-xr-x 13 root root  4096 May 31  2025 share\ndrwxr-xr-x  4 root root  4096 Dec 18 16:59 smolagents_src\ndrwxr-xr-x 18 root root  4096 May 31  2025 src\n-rw-r--r--  1 root root  3469 May 31  2025 static.mak\ndrwxr-xr-x  2 root root  4096 May 31  2025 testsuite\n-rw-r--r--  1 root root  1116 May 31  2025 version.bat\n/src/gpac/include/wince/errno.h\n/src/gpac/include/win32/inttypes.h\n/src/gpac/include/win32/stdint.h\n/src/gpac/include/gpac/nodes_svg.h\n/src/gpac/include/gpac/sync_layer.h\n/src/gpac/include/gpac/bitstream.h\n/src/gpac/include/gpac/route.h\n/src/gpac/include/gpac/list.h\n/src/gpac/include/gpac/network.h\n/src/gpac/include/gpac/path2d.h\n/src/gpac/include/gpac/dsmcc.h\n/src/gpac/include/gpac/webvtt.h\n/src/gpac/include/gpac/mpeg4_odf.h\n/src/gpac/include/gpac/events_constants.h\n/src/gpac/include/gpac/nodes_mpeg4.h\n/src/gpac/include/gpac/bifs.h\n/src/gpac/include/gpac/setup.h\n/src/gpac/include/gpac/thread.h\n/src/gpac/include/gpac/00_doxy.h\n/src/gpac/include/gpac/constants.h\n/src/gpac/include/gpac/html5_media.h\n/src/gpac/include/gpac/mpd.h\n/src/gpac/include/gpac/color.h\n/src/gpac/include/gpac/download.h\n/src/gpac/include/gpac/cache.h\n/src/gpac/include/gpac/Remotery.h\n/src/gpac/include/gpac/config_file.h\n/src/gpac/include/gpac/svg_types.h\n/src/gpac/include/gpac/nodes_x3d.h\n/src/gpac/include/gpac/xml.h\n/src/gpac/include/gpac/compositor.h\n/src/gpac/include/gpac/rtp_streamer.h\n/src/gpac/include/gpac/tools.h\n/src/gpac/include/gpac/evg.h\n/src/gpac/include/gpac/scenegraph_svg.h\n/src/gpac/include/gpac/media_tools.h\n/src/gpac/include/gpac/main.h\n/src/gpac/include/gpac/maths.h\n/src/gpac/include/gpac/events.h\n/src/gpac/include/gpac/isomedia.h\n/src/gpac/include/gpac/ait.h\n/src/gpac/include/gpac/module.h\n/src/gpac/include/gpac/html5_mse.h\n/src/gpac/include/gpac/ietf.h\n/src/gpac/include/gpac/crypt.h\n/src/gpac/include/gpac/configuration.h\n/src/gpac/include/gpac/mediaobject.h\n/src/gpac/include/gpac/dash.h\n/src/gpac/include/gpac/laser.h\n/src/gpac/include/gpac/scenegraph.h\n/src/gpac/include/gpac/scene_manager.h\n/src/gpac/include/gpac/token.h\n/src/gpac/include/gpac/scenegraph_vrml.h\n/src/gpac/include/gpac/base_coding.h\n/src/gpac/include/gpac/iso639.h\n/src/gpac/include/gpac/scene_engine.h\n/src/gpac/include/gpac/utf.h\n/src/gpac/include/gpac/crypt_tools.h\n/src/gpac/include/gpac/mpegts.h\n/src/gpac/include/gpac/version.h\n/src/gpac/include/gpac/avparse.h\n/src/gpac/include/gpac/filters.h\n/src/gpac/include/gpac/dvb_mpe.h\n/src/gpac/configure\n/src/gpac/.github/ISSUE_TEMPLATE.md\n/src/gpac/.github/workflows/ga.yml\n/src/gpac/static.mak\n/src/gpac/share/doc/ipmpx_syntax.bt\n/src/gpac/share/doc/doxyfile\n/src/gpac/share/doc/doxyfile-full\n/src/gpac/share/doc/SceneGenerators\n/src/gpac/share/doc/GPAC UPnP.doc\n/src/gpac/share/doc/ISO 639-2 codes.txt\n/src/gpac/share/doc/CODING_STYLE\n/src/gpac/share/nodejs/index.js\n/src/gpac/share/nodejs/binding.gyp\n/src/gpac/share/nodejs/package.json\n/src/gpac/share/lang/fr.txt\n/src/gpac/share/res/gpac_cfg_test.mp4\n/src/gpac/share/res/gpac.mp4\n/src/gpac/share/res/gpac.ico\n/src/gpac/share/res/gpac.png\n/src/gpac/share/res/gpac_highres.png\n/src/gpac/share/python/setup.py\n/src/gpac/share/python/__init__.py\n/src/gpac/share/shaders/vertex.glsl\n/src/gpac/share/shaders/fragment.glsl\n/src/gpac/share/vis/index.html\n/src/gpac/share/scripts/webvtt-renderer.js\n/src/gpac/share/scripts/custom_dash.js\n/src/gpac/share/scripts/ttml-renderer.js\n/src/gpac/share/scripts/vout.js\n/src/gpac/share/default.cfg\n/src/gpac/share/gui/gui.js\n/src/gpac/share/gui/gui.bt\n/src/gpac/share/gui/gwlib.js\n/src/gpac/share/emscripten/gpac.html\n/src/gpac/share/emscripten/favicon-32x32.png\n/src/gpac/share/deprecated/mpegu-wm.xmt\n/src/gpac/share/deprecated/tv_wm_gui.js\n/src/gpac/share/deprecated/mpegu-core.js\n/src/gpac/share/deprecated/tv_wm_gui.svg\n/src/gpac/share/deprecated/iphone_wm_gui.svg\n/src/gpac/share/deprecated/mpegu-wm.bt\n/src/gpac/share/deprecated/mpegu-wm.js\n/src/gpac/share/deprecated/iphone_wm_gui.js\n/src/gpac/share/gpac.desktop\n/src/gpac/applications/mp4box/mp4box.c\n/src/gpac/applications/mp4box/fileimport.c\n/src/gpac/applications/mp4box/filedump.c\n/src/gpac/applications/mp4box/mp4box.h\n/src/gpac/applications/mp4box/Makefile\n/src/gpac/applications/mp4box/live.c\n/src/gpac/applications/generators/Makefile\n/src/gpac/applications/gpac_android/.gitignore\n/src/gpac/applications/gpac_android/build.gradle\n/src/gpac/applications/gpac_android/gradlew.bat\n/src/gpac/applications/gpac_android/gradlew\n/src/gpac/applications/Makefile\n/src/gpac/applications/gpac/gpac_help.c\n/src/gpac/applications/gpac/carbon_hook.c\n/src/gpac/applications/gpac/ios-Info.plist\n/src/gpac/applications/gpac/ios_main.m\n/src/gpac/applications/gpac/gpac.rc\n/src/gpac/applications/gpac/gpac.h\n/src/gpac/applications/gpac/resource.h\n/src/gpac/applications/gpac/Makefile\n/src/gpac/applications/gpac/Info.plist\n/src/gpac/applications/gpac/gpac.c\n/src/gpac/applications/gpac/compositor_tools.c\n/src/gpac/modules/dx_hw/dx_hw.rc\n/src/gpac/modules/dx_hw/dx_window.c\n/src/gpac/modules/dx_hw/dx_video.c\n/src/gpac/modules/dx_hw/hand.cur\n/src/gpac/modules/dx_hw/dx_hw.h\n/src/gpac/modules/dx_hw/collide.cur\n/src/gpac/modules/dx_hw/dx_audio.c\n/src/gpac/modules/dx_hw/resource.h\n/src/gpac/modules/dx_hw/Makefile\n/src/gpac/modules/dx_hw/dx_2d.c\n/src/gpac/modules/alsa/alsa.c\n/src/gpac/modules/alsa/Makefile\n/src/gpac/modules/directfb_out/directfb_wrapper.c\n/src/gpac/modules/directfb_out/directfb_out.h\n/src/gpac/modules/directfb_out/directfb_out.c\n/src/gpac/modules/directfb_out/Makefile\n/src/gpac/modules/filter_export.cpp\n/src/gpac/modules/modules_export.cpp\n/src/gpac/modules/x11_out/x11_out.h\n/src/gpac/modules/x11_out/Makefile\n/src/gpac/modules/x11_out/x11_out.c\n/src/gpac/modules/dektec_out/dektec_video_old.cpp\n/src/gpac/modules/dektec_out/out_dektec.vcxproj\n/src/gpac/modules/dektec_out/Makefile\n/src/gpac/modules/dektec_out/dektec_video_decl.c\n/src/gpac/modules/dektec_out/dektec_video.cpp\n/src/gpac/modules/dektec_out/dektec_video.h\n/src/gpac/modules/Makefile\n/src/gpac/modules/validator/README.TXT\n/src/gpac/modules/validator/Makefile\n/src/gpac/modules/validator/validator.c\n/src/gpac/modules/test_filter/test_filter.vcxproj\n/src/gpac/modules/test_filter/test_filter.c\n/src/gpac/modules/test_filter/Makefile\n/src/gpac/modules/wav_out/wav_out.c\n/src/gpac/modules/wav_out/Makefile\n/src/gpac/modules/jack/Makefile\n/src/gpac/modules/jack/jack.c\n/src/gpac/modules/droid_audio/droidaudio.c\n/src/gpac/modules/droid_audio/javaenv.h\n/src/gpac/modules/droid_audio/javaenv.c\n/src/gpac/modules/pulseaudio/Makefile\n/src/gpac/modules/pulseaudio/pulseaudio.c\n/src/gpac/modules/demo_is/demo-sensor.bt\n/src/gpac/modules/demo_is/Makefile\n/src/gpac/modules/demo_is/demo_is.c\n/src/gpac/modules/sdl_out/sdl_out.h\n/src/gpac/modules/sdl_out/video.c\n/src/gpac/modules/sdl_out/cursors.c\n/src/gpac/modules/sdl_out/video2d.c\n/src/gpac/modules/sdl_out/Makefile\n/src/gpac/modules/sdl_out/audio.c\n/src/gpac/modules/sdl_out/sdl_out.c\n/src/gpac/modules/droid_out/droid_vout-bitmap.c\n/src/gpac/modules/droid_out/droid_vout.c\n/src/gpac/modules/caca_out/Makefile\n/src/gpac/modules/caca_out/caca_out.c\n/src/gpac/modules/dec_openhevc/Makefile\n/src/gpac/modules/ft_font/ft_font.h\n/src/gpac/modules/ft_font/Makefile\n/src/gpac/modules/ft_font/ft_font.c\n/src/gpac/check_revision.sh\n/src/gpac/.gitmodules\n/src/gpac/.gitignore\n/src/gpac/packagers/osx/distribution.xml\n/src/gpac/packagers/osx/SLA.r\n/src/gpac/.gitattributes\n/src/gpac/change_version.sh\n/src/gpac/.travis.yml\n/src/gpac/debian/docs"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_vz3Wd10K2hd9rCyTofqPJ92b', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -nR \"isom_new_mpha_description\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/src/gpac/include/gpac/isomedia.h:4009:GF_Err gf_isom_new_mpha_description(GF_ISOFile *isom_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype);\n/src/gpac/src/isomedia/sample_descs.c:1740:GF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n/src/gpac/src/filters/mux_isom.c:3055:\t\te = gf_isom_new_mpha_description(ctx->file, tkw->track_num, NULL, NULL, &tkw->stsd_idx, pdsi, dsi_len, m_subtype);"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_ydmJZCV9055ZdrcukitNv2qc', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1,2600p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n/*\n *\t\t\tGPAC - Multimedia Framework C SDK\n *\n *\t\t\tAuthors: Jean Le Feuvre\n *\t\t\tCopyright (c) Telecom ParisTech 2000-2023\n *\t\t\t\t\tAll rights reserved\n *\n *  This file is part of GPAC / ISO Media File Format sub-project\n *\n *  GPAC is free software; you can redistribute it and/or modify\n *  it under the terms of the GNU Lesser General Public License as published by\n *  the Free Software Foundation; either version 2, or (at your option)\n *  any later version.\n *\n *  GPAC is distributed in the hope that it will be useful,\n *  but WITHOUT ANY WARRANTY; without even the implied warranty of\n *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n *  GNU Lesser General Public License for more details.\n *\n *  You should have received a copy of the GNU Lesser General Public\n *  License along with this library; see the file COPYING.  If not, write to\n *  the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA.\n *\n */\n\n#include <gpac/internal/isomedia_dev.h>\n\n#ifndef GPAC_DISABLE_ISOM\n\n\nGF_Err gf_isom_base_sample_entry_read(GF_SampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_read_data(bs, ptr->reserved, 6);\n\tptr->dataReferenceIndex = gf_bs_read_u16(bs);\n\tif (!ptr->dataReferenceIndex) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"[ISO file] dataReferenceIndex set to 0 in sample entry, overriding to 1\\n\"));\n\t\tptr->dataReferenceIndex = 1;\n\t}\n\treturn GF_OK;\n}\n\nvoid gf_isom_sample_entry_predestroy(GF_SampleEntryBox *ptr)\n{\n}\n\nvoid gf_isom_sample_entry_init(GF_SampleEntryBox *ent)\n{\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_GENERIC;\n//\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_MP4S;\n}\n\nvoid gf_isom_video_sample_entry_init(GF_VisualSampleEntryBox *ent)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ent);\n\tent->internal_type = GF_ISOM_SAMPLE_ENTRY_VIDEO;\n\tent->horiz_res = ent->vert_res = 0x00480000;\n\tent->frames_per_sample = 1;\n\tent->bit_depth = 0x18;\n\tent->color_table_index = -1;\n}\n\nGF_Err gf_isom_video_sample_entry_read(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 78)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->temporal_quality  = gf_bs_read_u32(bs);\n\tptr->spatial_quality = gf_bs_read_u32(bs);\n\tptr->Width = gf_bs_read_u16(bs);\n\tptr->Height = gf_bs_read_u16(bs);\n\tptr->horiz_res = gf_bs_read_u32(bs);\n\tptr->vert_res = gf_bs_read_u32(bs);\n\tptr->entry_data_size = gf_bs_read_u32(bs);\n\tptr->frames_per_sample = gf_bs_read_u16(bs);\n\tgf_bs_read_data(bs, ptr->compressor_name, 32);\n\tptr->compressor_name[32] = 0;\n\tptr->bit_depth = gf_bs_read_u16(bs);\n\tptr->color_table_index = gf_bs_read_u16(bs);\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nvoid gf_isom_video_sample_entry_write(GF_VisualSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u32(bs, ptr->temporal_quality);\n\tgf_bs_write_u32(bs, ptr->spatial_quality);\n\tgf_bs_write_u16(bs, ptr->Width);\n\tgf_bs_write_u16(bs, ptr->Height);\n\tgf_bs_write_u32(bs, ptr->horiz_res);\n\tgf_bs_write_u32(bs, ptr->vert_res);\n\tgf_bs_write_u32(bs, ptr->entry_data_size);\n\tgf_bs_write_u16(bs, ptr->frames_per_sample);\n\tgf_bs_write_data(bs, ptr->compressor_name, 32);\n\tgf_bs_write_u16(bs, ptr->bit_depth);\n\tgf_bs_write_u16(bs, ptr->color_table_index);\n\n\n\tif (gf_sys_old_arch_compat()) {\n\t\t//patch for old export\n\t\tGF_Box *clap = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLAP);\n\t\tGF_Box *pasp = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_PASP);\n\t\tGF_Box *colr = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_COLR);\n\t\tGF_Box *mdcv = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_MDCV);\n\t\tGF_Box *clli = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CLLI);\n\t\tGF_Box *ccst = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_CCST);\n\t\tGF_Box *auxi = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_AUXI);\n\t\tGF_Box *rvcc = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_RVCC);\n\t\tGF_Box *sinf = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\tGF_Box *btrt = gf_isom_box_find_child(ptr->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\t\tGF_Box *fiel = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_FIEL);\n\t\tGF_Box *gamma = gf_isom_box_find_child(ptr->child_boxes, GF_QT_BOX_TYPE_GAMA);\n\n\t\tif (clap) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clap);\n\t\t\tgf_list_add(ptr->child_boxes, clap);\n\t\t}\n\t\tif (pasp) {\n\t\t\tgf_list_del_item(ptr->child_boxes, pasp);\n\t\t\tgf_list_add(ptr->child_boxes, pasp);\n\t\t}\n\t\tif (colr) {\n\t\t\tgf_list_del_item(ptr->child_boxes, colr);\n\t\t\tgf_list_add(ptr->child_boxes, colr);\n\t\t}\n\t\tif (fiel) {\n\t\t\tgf_list_del_item(ptr->child_boxes, fiel);\n\t\t\tgf_list_add(ptr->child_boxes, fiel);\n\t\t}\n\t\tif (gamma) {\n\t\t\tgf_list_del_item(ptr->child_boxes, gamma);\n\t\t\tgf_list_add(ptr->child_boxes, gamma);\n\t\t}\n\t\tif (mdcv) {\n\t\t\tgf_list_del_item(ptr->child_boxes, mdcv);\n\t\t\tgf_list_add(ptr->child_boxes, mdcv);\n\t\t}\n\t\tif (clli) {\n\t\t\tgf_list_del_item(ptr->child_boxes, clli);\n\t\t\tgf_list_add(ptr->child_boxes, clli);\n\t\t}\n\t\tif (ccst) {\n\t\t\tgf_list_del_item(ptr->child_boxes, ccst);\n\t\t\tgf_list_add(ptr->child_boxes, ccst);\n\t\t}\n\t\tif (auxi) {\n\t\t\tgf_list_del_item(ptr->child_boxes, auxi);\n\t\t\tgf_list_add(ptr->child_boxes, auxi);\n\t\t}\n\t\tif (rvcc) {\n\t\t\tgf_list_del_item(ptr->child_boxes, rvcc);\n\t\t\tgf_list_add(ptr->child_boxes, rvcc);\n\t\t}\n\t\tif (sinf) {\n\t\t\tgf_list_del_item(ptr->child_boxes, sinf);\n\t\t\tgf_list_add(ptr->child_boxes, sinf);\n\t\t}\n\t\tif (btrt) {\n\t\t\tgf_list_del_item(ptr->child_boxes, btrt);\n\t\t\tgf_list_add(ptr->child_boxes, btrt);\n\t\t}\n\t}\n\n}\n\nvoid gf_isom_video_sample_entry_size(GF_VisualSampleEntryBox *ent)\n{\n\tent->size += 78;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nvoid gf_isom_audio_sample_entry_init(GF_AudioSampleEntryBox *ptr)\n{\n\tgf_isom_sample_entry_init((GF_SampleEntryBox*)ptr);\n\tptr->internal_type = GF_ISOM_SAMPLE_ENTRY_AUDIO;\n\tptr->channel_count = 2;\n\tptr->bitspersample = 16;\n}\n\nGF_Err gf_isom_audio_sample_entry_read(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tGF_Err e;\n\tISOM_DECREASE_SIZE(ptr, 28)\n\n\te = gf_isom_base_sample_entry_read((GF_SampleEntryBox *)ptr, bs);\n\tif (e) return e;\n\n\tptr->version = gf_bs_read_u16(bs);\n\tptr->revision = gf_bs_read_u16(bs);\n\tptr->vendor = gf_bs_read_u32(bs);\n\tptr->channel_count = gf_bs_read_u16(bs);\n\tptr->bitspersample = gf_bs_read_u16(bs);\n\tptr->compression_id = gf_bs_read_u16(bs);\n\tptr->packet_size = gf_bs_read_u16(bs);\n\tptr->samplerate_hi = gf_bs_read_u16(bs);\n\tptr->samplerate_lo = gf_bs_read_u16(bs);\n\n\tif (!ptr->qtff_mode) return GF_OK;\n\t//QT only\n\tif (ptr->version==1) {\n\t\tISOM_DECREASE_SIZE(ptr, 16)\n\t\tgf_bs_read_data(bs, (char *) ptr->extensions, 16);\n\t} else if (ptr->version==2) {\n\t\tISOM_DECREASE_SIZE(ptr, 36)\n\t\tgf_bs_read_data(bs,  (char *) ptr->extensions, 36);\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Box *gf_isom_audio_sample_get_audio_codec_cfg_box(GF_AudioSampleEntryBox *ptr)\n{\n\tGF_MPEGAudioSampleEntryBox *mpga = (GF_MPEGAudioSampleEntryBox *) ptr;\n\tswitch (ptr->type) {\n\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\treturn (GF_Box *)mpga->esd;\n\tcase GF_ISOM_BOX_TYPE_AC3:\n\tcase GF_ISOM_BOX_TYPE_EC3:\n\t\treturn (GF_Box *)mpga->cfg_ac3;\n\tcase GF_ISOM_BOX_TYPE_OPUS:\n\t\treturn (GF_Box *)mpga->cfg_opus;\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\treturn (GF_Box *)mpga->cfg_mha;\n\tcase GF_ISOM_BOX_TYPE_MLPA:\n\t\treturn (GF_Box *)mpga->cfg_mlp;\n\t}\n\treturn NULL;\n}\nvoid gf_isom_audio_sample_entry_write(GF_AudioSampleEntryBox *ptr, GF_BitStream *bs)\n{\n\tgf_bs_write_data(bs, ptr->reserved, 6);\n\tgf_bs_write_u16(bs, ptr->dataReferenceIndex);\n\n\tgf_bs_write_u16(bs, ptr->version);\n\tgf_bs_write_u16(bs, ptr->revision);\n\tgf_bs_write_u32(bs, ptr->vendor);\n\tgf_bs_write_u16(bs, ptr->channel_count);\n\tgf_bs_write_u16(bs, ptr->bitspersample);\n\tgf_bs_write_u16(bs, ptr->compression_id);\n\tgf_bs_write_u16(bs, ptr->packet_size);\n\tgf_bs_write_u16(bs, ptr->samplerate_hi);\n\tgf_bs_write_u16(bs, ptr->samplerate_lo);\n\n\tif (ptr->qtff_mode) {\n\t\tGF_Box *codec_ext = NULL;\n\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_NOEXT) {\n\t\t\tcodec_ext = gf_isom_audio_sample_get_audio_codec_cfg_box(ptr);\n\t\t}\n\n\t\tif (ptr->version==1) {\n\t\t\t//direct copy of data\n\t\t\tif (ptr->qtff_mode==GF_ISOM_AUDIO_QTFF_ON_EXT_VALID) {\n\t\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 16);\n\t\t\t} else {\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 1024 : 1);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample/8*ptr->channel_count);\n\t\t\t\tgf_bs_write_u32(bs, codec_ext ? 0 : ptr->bitspersample <= 16 ? ptr->bitspersample/8 : 2);\n\t\t\t}\n\t\t} else if (ptr->version==2) {\n\t\t\tgf_bs_write_data(bs,  (char *) ptr->extensions, 36);\n\t\t}\n\t}\n}\n\nvoid gf_isom_audio_sample_entry_size(GF_AudioSampleEntryBox *ptr)\n{\n\tptr->size += 28;\n\tif (ptr->qtff_mode) {\n\t\tif (ptr->version==1) {\n\t\t\tptr->size+=16;\n\t\t} else if (ptr->version==2) {\n\t\t\tptr->size += 36;\n\t\t}\n\t}\n}\n\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_3GPConfig *gf_isom_3gp_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_3GPConfig *config, *res;\n\tGF_TrackBox *trak;\n\tGF_SampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tconfig = NULL;\n\tentry = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tswitch (entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\t\tif (! ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGAudioSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return NULL;\n\t\tif (! ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp) return NULL;\n\t\tconfig = & ((GF_MPEGVisualSampleEntryBox*)entry)->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\tif (!config) return NULL;\n\n\tres = (GF_3GPConfig*)gf_malloc(sizeof(GF_3GPConfig));\n\tif (res)\n\t\tmemcpy(res, config, sizeof(GF_3GPConfig));\n\treturn res;\n}\n\nGF_EXPORT\nGF_AC3Config *gf_isom_ac3_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_AC3Config *res;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\tif (!entry->cfg_ac3) return NULL;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return NULL;\n\tif ( (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DAC3) && (entry->cfg_ac3->type!=GF_ISOM_BOX_TYPE_DEC3) ) return NULL;\n\n\tres = (GF_AC3Config*)gf_malloc(sizeof(GF_AC3Config));\n\tif (res)\n\t\tmemcpy(res, &entry->cfg_ac3->cfg, sizeof(GF_AC3Config));\n\treturn res;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\n\tif (type!=GF_ISOM_BOX_TYPE_FLAC) return GF_BAD_PARAM;\n\tif (!entry->cfg_flac) return GF_OK;\n\tif (dsi) {\n\t\t*dsi = gf_malloc(sizeof(u8)*entry->cfg_flac->dataSize);\n\t\tmemcpy(*dsi, entry->cfg_flac->data, entry->cfg_flac->dataSize);\n\t}\n\tif (dsi_size) *dsi_size = entry->cfg_flac->dataSize;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_truehd_config_get(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u32 *format_info, u32 *peak_data_rate)\n{\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\tif (entry->type != GF_ISOM_SUBTYPE_MLPA) return GF_BAD_PARAM;\n\n\tif (!entry->cfg_mlp) return GF_ISOM_INVALID_FILE;\n\tif (format_info) *format_info = entry->cfg_mlp->format_info;\n\tif (peak_data_rate) *peak_data_rate = entry->cfg_mlp->peak_data_rate;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_truehd_config_new(GF_ISOFile *the_file, u32 trackNumber, char *URLname, char *URNname, u32 format, u32 peak_rate, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_MLPA);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp = (GF_TrueHDConfigBox *)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DMLP);\n\tif (!entry->cfg_mlp) return GF_OUT_OF_MEM;\n\tentry->cfg_mlp->format_info = format;\n\tentry->cfg_mlp->peak_data_rate = (u16) peak_rate;\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_EXPORT\nGF_Err gf_isom_opus_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_OpusConfig *cfg, char *URLname, char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\tGF_SampleDescriptionBox *stsd;\n\n\tif (!cfg) return GF_BAD_PARAM;\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\t//create a new entry\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_isom_box_new_parent(&stsd->child_boxes, GF_ISOM_BOX_TYPE_OPUS);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_opus = (GF_OpusSpecificBox*)gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DOPS);\n\tif (!entry->cfg_opus) return GF_OUT_OF_MEM;\n\tentry->cfg_opus->opcfg = *cfg;\n\tentry->cfg_opus->opcfg.version = 0;\n\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(stsd->child_boxes);\n\treturn e;\n}\n#endif\n\nstatic GF_Err gf_isom_opus_config_get_internal(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, u8 **dsi, u32 *dsi_size, GF_OpusConfig *ocfg)\n{\n\tu32 type;\n\tGF_TrackBox *trak;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (dsi) *dsi = NULL;\n\tif (dsi_size) *dsi_size = 0;\n\tif (ocfg) memset(ocfg, 0, sizeof(GF_OpusConfig));\n\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_BAD_PARAM;\n\n\ttype = entry->type;\n\tif (type==GF_ISOM_BOX_TYPE_ENCA) {\n\t\tgf_isom_get_original_format_type(the_file, trackNumber, StreamDescriptionIndex, &type);\n\t}\n\tif (type != GF_ISOM_SUBTYPE_OPUS)\n\t\treturn GF_BAD_PARAM;\n\n\tif (!entry->cfg_opus)\n\t\treturn GF_BAD_PARAM;\n\n\tif (dsi && dsi_size) {\n\t\tgf_odf_opus_cfg_write(&entry->cfg_opus->opcfg, dsi, dsi_size);\n\t}\n\tif (ocfg)\n\t\t*ocfg = entry->cfg_opus->opcfg;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, u8 **dsi, u32 *dsi_size)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, dsi, dsi_size, NULL);\n}\n\nGF_EXPORT\nGF_Err gf_isom_opus_config_get_desc(GF_ISOFile *isom_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_OpusConfig *opcfg)\n{\n\treturn gf_isom_opus_config_get_internal(isom_file, trackNumber, sampleDescriptionIndex, NULL, NULL, opcfg);\n\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tu32 cfg_type;\n\tGF_SampleDescriptionBox *stsd;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DAMR;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DEVC;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DQCP;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (trak->Media->handler->handlerType!=GF_ISOM_MEDIA_AUDIO) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_DSMV;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (!gf_isom_is_video_handler_type(trak->Media->handler->handlerType)) return GF_BAD_PARAM;\n\t\tcfg_type = GF_ISOM_BOX_TYPE_D263;\n\t\tbreak;\n\tcase 0:\n\t\treturn GF_BAD_PARAM;\n\tdefault:\n\t\treturn GF_NOT_SUPPORTED;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstsd = trak->Media->information->sampleTable->SampleDescription;\n\n\tswitch (cfg->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t{\n\t\tGF_MPEGAudioSampleEntryBox *entry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t{\n\t\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&stsd->child_boxes, cfg->type);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_3gpp = (GF_3GPPConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, cfg_type);\n\t\tif (!entry->cfg_3gpp) {\n\t\t\tgf_isom_box_del((GF_Box *) entry);\n\t\t\treturn GF_OUT_OF_MEM;\n\t\t}\n\t\tmemcpy(&entry->cfg_3gpp->cfg, cfg, sizeof(GF_3GPConfig));\n\t\tentry->dataReferenceIndex = dataRefIndex;\n\t\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\t}\n\tbreak;\n\t}\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_3gp_config_update(GF_ISOFile *the_file, u32 trackNumber, GF_3GPConfig *param, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_3GPConfig *cfg;\n\tGF_MPEGAudioSampleEntryBox *a_entry;\n\tGF_MPEGVisualSampleEntryBox *v_entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !param || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tcfg = NULL;\n\ta_entry = (GF_MPEGAudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!a_entry) return GF_BAD_PARAM;\n\tv_entry = (GF_MPEGVisualSampleEntryBox *) a_entry;\n\n\tswitch (a_entry->type) {\n\tcase GF_ISOM_SUBTYPE_3GP_AMR:\n\tcase GF_ISOM_SUBTYPE_3GP_AMR_WB:\n\tcase GF_ISOM_SUBTYPE_3GP_EVRC:\n\tcase GF_ISOM_SUBTYPE_3GP_QCELP:\n\tcase GF_ISOM_SUBTYPE_3GP_SMV:\n\t\tif (a_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_AUDIO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = &a_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tcase GF_ISOM_SUBTYPE_3GP_H263:\n\t\tif (v_entry->internal_type != GF_ISOM_SAMPLE_ENTRY_VIDEO) return GF_ISOM_INVALID_FILE;\n\t\tcfg = & v_entry->cfg_3gpp->cfg;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!cfg || (cfg->type != param->type)) return GF_BAD_PARAM;\n\tmemcpy(cfg, param, sizeof(GF_3GPConfig));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_new(GF_ISOFile *the_file, u32 trackNumber, GF_AC3Config *cfg, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (cfg->is_ec3) {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_EC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DEC3);\n\t} else {\n\t\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_AC3);\n\t\tif (!entry) return GF_OUT_OF_MEM;\n\t\tentry->cfg_ac3 = (GF_AC3ConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DAC3);\n\t}\n\tif (!entry->cfg_ac3) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_EXPORT\nGF_Err gf_isom_ac3_config_update(GF_ISOFile *the_file, u32 trackNumber, u32 sampleDescriptionIndex, GF_AC3Config *cfg)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media || !cfg || !sampleDescriptionIndex) return GF_BAD_PARAM;\n\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\tif (!entry->cfg_ac3) return GF_BAD_PARAM;\n\n\tif (entry->cfg_ac3->cfg.is_ec3) {\n\t\tif (!cfg->is_ec3) return GF_BAD_PARAM;\n\t} else {\n\t\tif (cfg->is_ec3) return GF_BAD_PARAM;\n\t}\n\tmemcpy(&entry->cfg_ac3->cfg, cfg, sizeof(GF_AC3Config));\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_flac_config_new(GF_ISOFile *the_file, u32 trackNumber, u8 *metadata, u32 metadata_size, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tentry = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_FLAC);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->cfg_flac = (GF_FLACConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_DFLA);\n\n\tif (!entry->cfg_flac) {\n\t\tgf_isom_box_del((GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tentry->cfg_flac->dataSize = metadata_size;\n\tentry->cfg_flac->data = gf_malloc(sizeof(u8)*metadata_size);\n\tmemcpy(entry->cfg_flac->data, metadata, sizeof(u8)*metadata_size);\n\tentry->samplerate_hi = trak->Media->mediaHeader->timeScale;\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n\n\nGF_EXPORT\nGF_Err gf_isom_new_mj2k_description(GF_ISOFile *the_file, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_len)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex=0;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tGF_MPEGVisualSampleEntryBox *entry = (GF_MPEGVisualSampleEntryBox *) gf_isom_box_new_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, GF_ISOM_BOX_TYPE_MJP2);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->jp2h = (GF_J2KHeaderBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_JP2H);\n\tif (!entry->jp2h) {\n\t\tgf_isom_box_del_parent(&trak->Media->information->sampleTable->SampleDescription->child_boxes, (GF_Box *) entry);\n\t\treturn GF_OUT_OF_MEM;\n\t}\n\tif (dsi && dsi_len) {\n\t\tGF_BitStream *bs = gf_bs_new(dsi, dsi_len, GF_BITSTREAM_READ);\n\t\tentry->jp2h->size = dsi_len;\n\t\tgf_isom_box_read((GF_Box *)entry->jp2h, bs);\n\t\tgf_bs_del(bs);\n\t}\n\tentry->dataReferenceIndex = dataRefIndex;\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\n\n\nGF_EXPORT\nGF_Err gf_isom_get_dims_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_DIMSDescription *desc)\n{\n\tGF_DIMSSampleEntryBox *dims;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex || !desc) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\n\tmemset(desc, 0, sizeof(GF_DIMSDescription));\n\tif (dims->config) {\n\t\tdesc->profile = dims->config->profile;\n\t\tdesc->level = dims->config->level;\n\t\tdesc->pathComponents = dims->config->pathComponents;\n\t\tdesc->fullRequestHost = dims->config->fullRequestHost;\n\t\tdesc->containsRedundant = dims->config->containsRedundant;\n\t\tdesc->streamType = dims->config->streamType;\n\t\tdesc->textEncoding = dims->config->textEncoding;\n\t\tdesc->contentEncoding = dims->config->contentEncoding;\n\t}\n\tif (dims->scripts) {\n\t\tdesc->content_script_types = dims->scripts->content_script_types;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_new_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, const char *URLname, const char *URNname, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tif (trak->Media->handler->handlerType != GF_ISOM_MEDIA_SCENE) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims = (GF_DIMSSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_DIMS);\n\tif (!dims) return GF_OUT_OF_MEM;\n\tdims->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, dims);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\tif (!dims->config) return GF_OUT_OF_MEM;\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tif (!dims->config->containsRedundant) dims->config->containsRedundant = 1;\n\tdims->config->streamType = desc->streamType;\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types);\n\t}\n\treturn e;\n}\n\n#if 0 //unused\nGF_Err gf_isom_update_dims_description(GF_ISOFile *movie, u32 trackNumber, GF_DIMSDescription *desc, char *URLname, char *URNname, u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_DIMSSampleEntryBox *dims;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !desc || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tdims = (GF_DIMSSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!dims) return GF_BAD_PARAM;\n\tif (dims->type != GF_ISOM_BOX_TYPE_DIMS) return GF_BAD_PARAM;\n\tif (!dims->config) {\n\t\tdims->config = (GF_DIMSSceneConfigBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIMC);\n\t\tif (!dims->config) return GF_OUT_OF_MEM;\n\t}\n\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tdims->config->profile = desc->profile;\n\tdims->config->level = desc->level;\n\tdims->config->pathComponents = desc->pathComponents;\n\tdims->config->fullRequestHost = desc->fullRequestHost;\n\tdims->config->containsRedundant = desc->containsRedundant;\n\tdims->config->streamType = desc->streamType;\n\n\tif (dims->config->textEncoding) gf_free(dims->config->textEncoding);\n\tdims->config->textEncoding = gf_strdup(desc->textEncoding ? desc->textEncoding : \"\");\n\n\tif (dims->config->contentEncoding) gf_free(dims->config->contentEncoding);\n\tdims->config->contentEncoding = gf_strdup(desc->contentEncoding ? desc->contentEncoding : \"\");\n\n\tif (desc->content_script_types) {\n\t\tif (!dims->scripts) {\n\t\t\tdims->scripts = (GF_DIMSScriptTypesBox*) gf_isom_box_new_parent(&dims->child_boxes, GF_ISOM_BOX_TYPE_DIST);\n\t\t\tif (!dims->scripts) return GF_OUT_OF_MEM;\n\t\t}\n\t\tif (dims->scripts->content_script_types) gf_free(dims->scripts->content_script_types);\n\t\tdims->scripts->content_script_types = gf_strdup(desc->content_script_types ? desc->content_script_types  :\"\");\n\t} else if (dims->scripts) {\n\t\tgf_isom_box_del_parent(&dims->child_boxes, (GF_Box *) dims->scripts);\n\t\tdims->scripts = NULL;\n\t}\n\treturn GF_OK;\n}\n#endif\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\nGF_EXPORT\nGF_Err gf_isom_get_udts_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, GF_UDTSConfig *cfg)\n{\n\tGF_Box *sample_entry;\n\tGF_TrackBox *trak = gf_isom_get_track_from_file(movie, trackNumber);\n\tGF_UDTSSpecificBox *udts = NULL;\n\n\tif (!trak || !descriptionIndex || !cfg) return GF_BAD_PARAM;\n\tsample_entry = (GF_Box *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (sample_entry && sample_entry->type == GF_ISOM_BOX_TYPE_DTSX)\n\t\tudts = (GF_UDTSSpecificBox *)gf_list_get(sample_entry->child_boxes, 0);\n\n\tmemset(cfg, 0, sizeof(GF_UDTSConfig));\n\tif (!udts)\n\t\treturn GF_BAD_PARAM;\n\n\tcfg->DecoderProfileCode = udts->cfg.DecoderProfileCode;\n\tcfg->FrameDurationCode = udts->cfg.FrameDurationCode;\n\tcfg->MaxPayloadCode = udts->cfg.MaxPayloadCode;\n\tcfg->NumPresentationsCode = udts->cfg.NumPresentationsCode;\n\tcfg->ChannelMask = udts->cfg.ChannelMask;\n\tcfg->BaseSamplingFrequencyCode = udts->cfg.BaseSamplingFrequencyCode;\n\tcfg->SampleRateMod = udts->cfg.SampleRateMod;\n\tcfg->RepresentationType = udts->cfg.RepresentationType;\n\tcfg->StreamIndex = udts->cfg.RepresentationType;\n\treturn GF_OK;\n}\n\n\nGF_Err LSR_UpdateESD(GF_LASeRSampleEntryBox *lsr, GF_ESD *esd)\n{\n\tGF_BitRateBox *btrt = gf_isom_sample_entry_get_bitrate((GF_SampleEntryBox *)lsr, GF_TRUE);\n\n\tif (lsr->descr) gf_isom_box_del_parent(&lsr->child_boxes, (GF_Box *) lsr->descr);\n\tlsr->descr = NULL;\n\tbtrt->avgBitrate = esd->decoderConfig->avgBitrate;\n\tbtrt->maxBitrate = esd->decoderConfig->maxBitrate;\n\tbtrt->bufferSizeDB = esd->decoderConfig->bufferSizeDB;\n\n\tif (gf_list_count(esd->IPIDataSet)\n\t        || gf_list_count(esd->IPMPDescriptorPointers)\n\t        || esd->langDesc\n\t        || gf_list_count(esd->extensionDescriptors)\n\t        || esd->ipiPtr || esd->qos || esd->RegDescriptor) {\n\n\t\tlsr->descr = (GF_MPEG4ExtensionDescriptorsBox *)gf_isom_box_new_parent(&lsr->child_boxes, GF_ISOM_BOX_TYPE_M4DS);\n\t\tif (!lsr->descr) return GF_OUT_OF_MEM;\n\t\tif (esd->RegDescriptor) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->RegDescriptor);\n\t\t\tesd->RegDescriptor = NULL;\n\t\t}\n\t\tif (esd->qos) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->qos);\n\t\t\tesd->qos = NULL;\n\t\t}\n\t\tif (esd->ipiPtr) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->ipiPtr);\n\t\t\tesd->ipiPtr= NULL;\n\t\t}\n\n\t\twhile (gf_list_count(esd->IPIDataSet)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPIDataSet, 0);\n\t\t\tgf_list_rem(esd->IPIDataSet, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\twhile (gf_list_count(esd->IPMPDescriptorPointers)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_rem(esd->IPMPDescriptorPointers, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t\tif (esd->langDesc) {\n\t\t\tgf_list_add(lsr->descr->descriptors, esd->langDesc);\n\t\t\tesd->langDesc = NULL;\n\t\t}\n\t\twhile (gf_list_count(esd->extensionDescriptors)) {\n\t\t\tGF_Descriptor *desc = (GF_Descriptor *)gf_list_get(esd->extensionDescriptors, 0);\n\t\t\tgf_list_rem(esd->extensionDescriptors, 0);\n\t\t\tgf_list_add(lsr->descr->descriptors, desc);\n\t\t}\n\t}\n\n\t/*update GF_AVCConfig*/\n\tif (!lsr->lsr_config) {\n\t\tlsr->lsr_config = (GF_LASERConfigurationBox *)gf_isom_box_new_parent(&lsr->child_boxes,  GF_ISOM_BOX_TYPE_LSRC);\n\t\tif (!lsr->lsr_config) return GF_OUT_OF_MEM;\n\t}\n\tif (esd->decoderConfig->decoderSpecificInfo && esd->decoderConfig->decoderSpecificInfo->data) {\n\t\tlsr->lsr_config->hdr = gf_realloc(lsr->lsr_config->hdr, sizeof(char) * esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t\tlsr->lsr_config->hdr_size = esd->decoderConfig->decoderSpecificInfo->dataLength;\n\t\tmemcpy(lsr->lsr_config->hdr, esd->decoderConfig->decoderSpecificInfo->data, sizeof(char)*esd->decoderConfig->decoderSpecificInfo->dataLength);\n\t}\n\tgf_odf_desc_del((GF_Descriptor *)esd);\n\treturn GF_OK;\n}\n\n/* MetadataSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_get_xml_metadata_description(GF_ISOFile *file, u32 track, u32 sampleDescription,\n        const char **_namespace, const char **schema_loc, const char **content_encoding)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *ptr;\n\tif (_namespace) *_namespace = NULL;\n\tif (content_encoding) *content_encoding = NULL;\n\tif (schema_loc) *schema_loc = NULL;\n\ttrak = gf_isom_get_track_from_file(file, track);\n\tif (!trak || !sampleDescription) return GF_BAD_PARAM;\n\tptr = (GF_MetaDataSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, sampleDescription-1);\n\tif (!ptr) return GF_BAD_PARAM;\n\n\tif (schema_loc) *schema_loc = ptr->xml_schema_loc;\n\tif (_namespace) *_namespace = ptr->xml_namespace;\n\tif (content_encoding) *content_encoding = ptr->content_encoding;\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_Err gf_isom_new_xml_metadata_description(GF_ISOFile *movie, u32 trackNumber,\n        const char *_namespace, const char *schema_loc, const char *content_encoding,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *metad;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !_namespace)\n\t\treturn GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmetad = (GF_MetaDataSampleEntryBox*) gf_isom_box_new(GF_ISOM_BOX_TYPE_METX);\n\tif (!metad) return GF_OUT_OF_MEM;\n\n\tmetad->dataReferenceIndex = dataRefIndex;\n\tmetad->xml_namespace = gf_strdup(_namespace);\n\tif (content_encoding) metad->content_encoding = gf_strdup(content_encoding);\n\tif (schema_loc) metad->xml_schema_loc = gf_strdup(schema_loc);\n\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, metad);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n/* XMLSubtitleSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_xml_subtitle_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n        const char **xmlnamespace, const char **xml_schema_loc, const char **mimes)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (xmlnamespace) *xmlnamespace = NULL;\n\tif (xml_schema_loc) *xml_schema_loc = NULL;\n\tif (mimes) *mimes = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n \n\tif ((entry->type!=GF_ISOM_BOX_TYPE_STPP) && (entry->type!=GF_ISOM_BOX_TYPE_METX)) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->mime_type) {\n\t\tif (mimes) *mimes = entry->mime_type;\n\t}\n\tif (entry->xml_schema_loc) {\n\t\tif (xml_schema_loc) *xml_schema_loc = entry->xml_schema_loc;\n\t}\n\tif (xmlnamespace)\n\t\t*xmlnamespace = entry->xml_namespace;\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nconst char *gf_isom_subtitle_get_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return NULL;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return NULL;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) return NULL;\n\treturn mime->config;\n}\n\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_subtitle_set_mime(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex, const char *codec_params)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_TextConfigBox *mime;\n\tGF_MetaDataSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry) return GF_BAD_PARAM;\n\n\tmime = (GF_TextConfigBox *) gf_isom_box_find_child(entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\tif (!mime) {\n\t\tif (!codec_params) return GF_OK;\n\t\tmime = (GF_TextConfigBox *) gf_isom_box_new_parent(&entry->child_boxes, GF_ISOM_BOX_TYPE_MIME);\n\t\tif (!mime) return GF_OUT_OF_MEM;\n\t}\n\tif (!codec_params) {\n\t\tgf_isom_box_del_parent(&entry->child_boxes, (GF_Box *)mime);\n\t\treturn GF_OK;\n\t}\n\tif (mime->config) gf_free(mime->config);\n\tmime->config = gf_strdup(codec_params);\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_new_xml_subtitle_description(GF_ISOFile  *movie, u32 trackNumber,\n        const char *xmlnamespace, const char *xml_schema_loc, const char *mimes,\n        u32 *outDescriptionIndex)\n{\n\tGF_TrackBox                 *trak;\n\tGF_Err                      e;\n\tu32                         dataRefIndex;\n\tGF_MetaDataSampleEntryBox *stpp;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!xmlnamespace) {\n\t\tGF_LOG(GF_LOG_WARNING, GF_LOG_CONTAINER, (\"XML (Subtitle, Metadata or Text) SampleEntry: namespace is mandatory. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tstpp = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_STPP);\n\tif (!stpp) return GF_OUT_OF_MEM;\n\tstpp->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, stpp);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tstpp->xml_namespace = gf_strdup(xmlnamespace);\n\tif (xml_schema_loc) stpp->xml_schema_loc = gf_strdup(xml_schema_loc); //optional\n\tif (mimes) stpp->mime_type = gf_strdup(mimes); //optional\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n\n/* SimpleTextSampleEntry: also used for MetadataTextSampleEntry and SubtitleTextSampleEntry */\nGF_EXPORT\nGF_Err gf_isom_stxt_get_description(GF_ISOFile *the_file, u32 trackNumber, u32 StreamDescriptionIndex,\n                                    const char **mime, const char **encoding, const char **config)\n{\n\tGF_TrackBox *trak;\n\tGF_MetaDataSampleEntryBox *entry;\n\tif (mime) *mime = NULL;\n\tif (config) *config = NULL;\n\tif (encoding) *encoding = NULL;\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !StreamDescriptionIndex) return GF_BAD_PARAM;\n\n\tentry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, StreamDescriptionIndex-1);\n\tif (!entry ||\n\t        ((entry->type!=GF_ISOM_BOX_TYPE_STXT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_METT) &&\n\t         (entry->type!=GF_ISOM_BOX_TYPE_SBTT))) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (entry->config) {\n\t\tif (config) *config = entry->config->config;\n\t}\n\tif (entry->mime_type) {\n\t\tif (mime) *mime = entry->mime_type;\n\t}\n\tif (entry->content_encoding) {\n\t\tif (encoding) *encoding = entry->content_encoding;\n\t}\n\treturn GF_OK;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\nGF_Err gf_isom_new_stxt_description(GF_ISOFile *movie, u32 trackNumber, u32 type,\n                                    const char *mime, const char *encoding, const char * config,\n                                    u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\tchar *URLname = NULL;\n\tchar *URNname = NULL;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\tcase GF_ISOM_MEDIA_META:\n\tcase GF_ISOM_MEDIA_SCENE:\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (type) {\n\tcase GF_ISOM_SUBTYPE_SBTT:\n\tcase GF_ISOM_SUBTYPE_STXT:\n\tcase GF_ISOM_SUBTYPE_METT:\n\t\tbreak;\n\tdefault:\n\t\tGF_LOG(GF_LOG_ERROR, GF_LOG_CONTAINER, (\"SampleEntry shall be either Metadata, Subtitle or SimpleText. Abort.\\n\"));\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!mime) {\n\t\tGF_LOG(GF_LOG_INFO, GF_LOG_CONTAINER, (\"Text (Metadata, Subtitle or SimpleText) missing mime, using text/plain.\\n\"));\n\t\tmime = \"text/plain\";\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, URLname, URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *) gf_isom_box_new(type);\n\tif (!sample_entry) return GF_OUT_OF_MEM;\n\tsample_entry->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, sample_entry);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tsample_entry->mime_type = gf_strdup(mime);\n\tif (encoding) sample_entry->content_encoding = gf_strdup(encoding);\n\tif (config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t\tsample_entry->config->config = gf_strdup(config);\n\t\tif (!sample_entry->config->config) return GF_OUT_OF_MEM;\n\t}\n\treturn e;\n}\n\n#if 0 //unused\n\n/*! updates simple streaming text config\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param encoding the text encoding, if any\n\\param config the configuration string, if any\n\\param sampleDescriptionIndex the target sample description index\n\\return error if any\n*/\nGF_Err gf_isom_update_stxt_description(GF_ISOFile *movie, u32 trackNumber,\n                                       const char *encoding, const char *config,\n                                       u32 DescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tGF_MetaDataSampleEntryBox *sample_entry;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media || !DescriptionIndex) return GF_BAD_PARAM;\n\n\tsample_entry = (GF_MetaDataSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, DescriptionIndex-1);\n\tif (!sample_entry) return GF_BAD_PARAM;\n\tif (sample_entry->type != GF_ISOM_BOX_TYPE_METT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_SBTT &&\n\t        sample_entry->type != GF_ISOM_BOX_TYPE_STXT) {\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\tif (!sample_entry->config) {\n\t\tsample_entry->config = (GF_TextConfigBox*) gf_isom_box_new_parent(&sample_entry->child_boxes, GF_ISOM_BOX_TYPE_TXTC);\n\t\tif (!sample_entry->config) return GF_OUT_OF_MEM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (sample_entry->config->config) {\n\t\tgf_free(sample_entry->config->config);\n\t}\n\tsample_entry->config->config = gf_strdup(config);\n\n\tif (sample_entry->content_encoding) {\n\t\tgf_free(sample_entry->content_encoding);\n\t}\n\tif (encoding) {\n\t\tsample_entry->content_encoding = gf_strdup(encoding);\n\t}\n\treturn GF_OK;\n}\n#endif\n\n\n#endif /*GPAC_DISABLE_ISOM_WRITE*/\n\n#ifndef GPAC_DISABLE_VTT\n\nGF_WebVTTSampleEntryBox *gf_webvtt_isom_get_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex)\n{\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\tif (!descriptionIndex) return NULL;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return NULL;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return NULL;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn wvtt;\n}\n\nGF_EXPORT\nconst char *gf_isom_get_webvtt_config(GF_ISOFile *file, u32 track, u32 index)\n{\n\tGF_WebVTTSampleEntryBox *wvtt = gf_webvtt_isom_get_description(file, track, index);\n\tif (!wvtt) return NULL;\n\treturn wvtt->config ? wvtt->config->string : NULL;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\n#ifndef GPAC_DISABLE_VTT\n\n#if 0 //unused\n/*! updates a WebVTT sample description\n\\param isom_file the target ISO file\n\\param trackNumber the target track\n\\param sampleDescriptionIndex the target sample description index to update\n\\param config the WebVTT configuration string\n\\return error if any\n*/\nGF_Err gf_isom_update_webvtt_description(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, const char *config)\n{\n\tGF_Err e;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\twvtt = (GF_WebVTTSampleEntryBox*)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex - 1);\n\tif (!wvtt) return GF_BAD_PARAM;\n\tswitch (wvtt->type) {\n\tcase GF_ISOM_BOX_TYPE_WVTT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tif (wvtt->config) gf_isom_box_del_parent(&wvtt->child_boxes, (GF_Box *)wvtt->config);\n\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\treturn GF_OK;\n}\n#endif\n\n\nGF_Err gf_isom_new_webvtt_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, const char *config)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_WebVTTSampleEntryBox *wvtt;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_TEXT:\n\tcase GF_ISOM_MEDIA_SUBT:\n\tcase GF_ISOM_MEDIA_MPEG_SUBT:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\twvtt = (GF_WebVTTSampleEntryBox *) gf_isom_box_new(GF_ISOM_BOX_TYPE_WVTT);\n\tif (!wvtt) return GF_OUT_OF_MEM;\n\twvtt->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, wvtt);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (config) {\n\t\twvtt->config = (GF_StringBox *)boxstring_new_with_data(GF_ISOM_BOX_TYPE_VTTC_CONFIG, config, &wvtt->child_boxes);\n\t}\n\treturn e;\n}\n\n#endif /*GPAC_DISABLE_VTT*/\n#endif //GPAC_DISABLE_ISOM_WRITE\n\nGF_BitRateBox *gf_isom_sample_entry_get_bitrate(GF_SampleEntryBox *ent, Bool create)\n{\n\tu32 i=0;\n\tGF_BitRateBox *a;\n\twhile ((a = (GF_BitRateBox *)gf_list_enum(ent->child_boxes, &i))) {\n\t\tif (a->type==GF_ISOM_BOX_TYPE_BTRT) return a;\n\t}\n\tif (!create) return NULL;\n\ta = (GF_BitRateBox *) gf_isom_box_new_parent(&ent->child_boxes, GF_ISOM_BOX_TYPE_BTRT);\n\treturn a;\n}\n\n#ifndef GPAC_DISABLE_ISOM_WRITE\n\nGF_EXPORT\nGF_Err gf_isom_update_bitrate(GF_ISOFile *movie, u32 trackNumber, u32 sampleDescriptionIndex, u32 average_bitrate, u32 max_bitrate, u32 decode_buffer_size)\n{\n\tGF_BitRateBox *a;\n\tGF_Err e;\n\tGF_SampleEntryBox *ent;\n\tu32 i, count;\n\tGF_TrackBox *trak;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return GF_BAD_PARAM;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tcount = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\tfor (i=0; i<count; i++) {\n\t\tu32 ent_type;\n\t\tGF_ProtectionSchemeInfoBox *sinf;\n\t\tGF_ESDBox *esds=NULL;\n\t\tif (sampleDescriptionIndex && (sampleDescriptionIndex!=i+1)) continue;\n\n\t\tent = (GF_SampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, i);\n\t\tif (!ent) return GF_BAD_PARAM;\n\n\t\tent_type = ent->type;\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_ENCV:\n\t\tcase GF_ISOM_BOX_TYPE_ENCA:\n\t\tcase GF_ISOM_BOX_TYPE_ENCS:\n\t\t\tsinf = (GF_ProtectionSchemeInfoBox *) gf_isom_box_find_child(ent->child_boxes, GF_ISOM_BOX_TYPE_SINF);\n\t\t\tif (sinf && sinf->original_format)\n\t\t\t\tent_type = sinf->original_format->data_format;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (ent_type) {\n\t\tcase GF_ISOM_BOX_TYPE_MP4V:\n\t\t\tesds = ((GF_MPEGVisualSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4A:\n\t\t\tesds = ((GF_MPEGAudioSampleEntryBox *)ent)->esd;\n\t\t\tbreak;\n\t\tcase GF_ISOM_BOX_TYPE_MP4S:\n\t\t\tesds = ((GF_MPEGSampleEntryBox *) ent)->esd;\n\t\t\tbreak;\n\t\t}\n\t\t//using mpeg4 esd\n\t\tif (esds) {\n\t\t\tif (esds->desc && esds->desc->decoderConfig) {\n\t\t\t\tesds->desc->decoderConfig->avgBitrate = average_bitrate;\n\t\t\t\tesds->desc->decoderConfig->maxBitrate = max_bitrate;\n\t\t\t\tif (decode_buffer_size)\n\t\t\t\t\tesds->desc->decoderConfig->bufferSizeDB = decode_buffer_size;\n\t\t\t}\n\t\t\tcontinue;\n\t\t}\n\t\t\n\t\t//using BTRT\n\t\tif (!max_bitrate && average_bitrate) max_bitrate = average_bitrate;\n\t\ta = gf_isom_sample_entry_get_bitrate(ent, max_bitrate ? GF_TRUE : GF_FALSE);\n\n\t\tif (!max_bitrate) {\n\t\t\tif (a) {\n\t\t\t\tgf_isom_box_del_parent(&ent->child_boxes, (GF_Box *) a);\n\t\t\t}\n\t\t} else {\n\t\t\ta->avgBitrate = average_bitrate;\n\t\t\ta->maxBitrate = max_bitrate;\n\t\t\tif (decode_buffer_size)\n\t\t\t\ta->bufferSizeDB = decode_buffer_size;\n\t\t}\n\t}\n\treturn GF_OK;\n}\n\n\nGF_EXPORT\nGF_Err gf_isom_tmcd_config_new(GF_ISOFile *the_file, u32 trackNumber, u32 fps_num, u32 fps_den, s32 frames_per_counter_tick, Bool is_drop, Bool is_counter, u32 *outDescriptionIndex)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_Box *tmcd;\n\tGF_GenericMediaHeaderInfoBox *gmin;\n\tGF_TimeCodeMediaInformationBox *tcmi;\n\tGF_TimeCodeSampleEntryBox *entry;\n\n\te = CanAccessMovie(the_file, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(the_file, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(the_file, trak->Media->information->dataInformation->dref, NULL, NULL, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!the_file->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\tif (!gmin) {\n\t\tgmin = (GF_GenericMediaHeaderInfoBox *) gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_GMIN);\n\t\tif (!gmin) return GF_OUT_OF_MEM;\n\t}\n\n\ttmcd = gf_isom_box_find_child(trak->Media->information->InfoHeader->child_boxes, GF_QT_BOX_TYPE_TMCD);\n\tif (!tmcd) {\n\t\t//default container box, use GMHD to create it\n\t\ttmcd = gf_isom_box_new_parent(&trak->Media->information->InfoHeader->child_boxes, GF_ISOM_BOX_TYPE_GMHD);\n\t\tif (!tmcd) return GF_OUT_OF_MEM;\n\t\ttmcd->type = GF_QT_BOX_TYPE_TMCD;\n\t}\n\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_find_child(tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\tif (!tcmi) {\n\t\ttcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\ttmcd = (GF_TimeCodeSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!tmcd) return GF_BAD_PARAM;\n\tif (tmcd->type != GF_QT_BOX_TYPE_TMCD) return GF_BAD_PARAM;\n\n\tif (tmcd_flags) *tmcd_flags = tmcd->flags;\n\tif (tmcd_fps_num) *tmcd_fps_num = tmcd->timescale;\n\tif (tmcd_fps_den) *tmcd_fps_den = tmcd->frame_duration;\n\tif (tmcd_fpt) *tmcd_fpt = tmcd->frames_per_counter_tick;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_pcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_PCMConfigBox *pcmC;\n\tGF_TrackBox *trak;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif ((aent->type != GF_ISOM_BOX_TYPE_IPCM) && (aent->type != GF_ISOM_BOX_TYPE_FPCM)) {\n\t\tBool is_le = GF_FALSE;\n\t\tGF_Box *b = gf_isom_box_find_child(aent->child_boxes, GF_QT_BOX_TYPE_WAVE);\n\t\t//if no wave, assume big endian\n\t\tif (b) {\n\t\t\tGF_ChromaInfoBox *enda = (GF_ChromaInfoBox *)gf_isom_box_find_child(b->child_boxes, GF_QT_BOX_TYPE_ENDA);\n\t\t\tis_le = (enda && enda->chroma) ? GF_TRUE : GF_FALSE;\n\t\t}\n\t\tu32 bits=0;\n\t\tswitch (aent->type) {\n\t\tcase GF_QT_SUBTYPE_FL32: bits = 32; break;\n\t\tcase GF_QT_SUBTYPE_FL64: bits = 64; break;\n\t\tcase GF_QT_SUBTYPE_TWOS: bits = 16; is_le = GF_FALSE; break;\n\t\tcase GF_QT_SUBTYPE_SOWT: bits = 16; is_le = GF_TRUE; break;\n\t\tcase GF_QT_SUBTYPE_IN24: bits = 24; break;\n\t\tcase GF_QT_SUBTYPE_IN32: bits = 32; break;\n\t\tdefault:\n\t\t\treturn GF_BAD_PARAM;\n\t\t}\n\t\tif (pcm_size) *pcm_size = bits;\n\t\tif (flags) *flags = is_le ? 1 : 0;\n\t\treturn GF_OK;\n\t}\n\n\tpcmC = (GF_PCMConfigBox *) gf_isom_box_find_child(aent->child_boxes, GF_ISOM_BOX_TYPE_PCMC);\n\tif (!pcmC) return GF_NON_COMPLIANT_BITSTREAM;\n\n\tif (flags) *flags = pcmC->format_flags;\n\tif (pcm_size) *pcm_size = pcmC->PCM_sample_size;\n\treturn GF_OK;\n}\n\nGF_EXPORT\nGF_Err gf_isom_get_lpcm_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, Double *sample_rate, u32 *nb_channels, u32 *flags, u32 *pcm_size)\n{\n\tGF_AudioSampleEntryBox *aent;\n\tGF_TrackBox *trak;\n\tGF_BitStream *bs;\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !descriptionIndex) return GF_BAD_PARAM;\n\n\taent = (GF_AudioSampleEntryBox *)gf_list_get(trak->Media->information->sampleTable->SampleDescription->child_boxes, descriptionIndex-1);\n\tif (!aent) return GF_BAD_PARAM;\n\tif (aent->type != GF_QT_SUBTYPE_LPCM)\n\t\treturn GF_BAD_PARAM;\n\tif (aent->version != 2)\n\t\treturn GF_BAD_PARAM;\n\n\tbs = gf_bs_new(aent->extensions, 36, GF_BITSTREAM_READ);\n\t/*offset*/gf_bs_read_u32(bs);\n\tDouble sr = gf_bs_read_double(bs);\n\tif (sample_rate) *sample_rate = sr;\n\tu32 nb_ch = gf_bs_read_u32(bs);\n\tif (nb_channels) *nb_channels = nb_ch;\n\t/*res*/gf_bs_read_u32(bs);\n\tu32 constBitsPerChannel = gf_bs_read_u32(bs);\n\tif (pcm_size) *pcm_size=constBitsPerChannel;\n\tu32 PCM_flags = gf_bs_read_u32(bs);\n\tif (flags) *flags = PCM_flags;\n\t/*constBytesPerAudioPacket*/gf_bs_read_u32(bs);\n\t/*constLPCMFramesPerAudioPacket*/gf_bs_read_u32(bs);\n\tgf_bs_del(bs);\n\treturn GF_OK;\n}\n\n\n\n#endif /*GPAC_DISABLE_ISOM*/"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_UGEexjAgkNoXcXZtaak0ztFx', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'git --no-pager diff -- /src/gpac/src/isomedia/sample_descs.c | cat', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_DMzZhU0XLcfdktPB2CcBfRlI', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"git apply -p0 << 'PATCH'\\n*** Begin Patch\\n*** Update File: src/isomedia/sample_descs.c\\n@@\\n-        mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\n-        if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n-        memcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\n+        {\\n+            u32 hdr_size = mpa->cfg_mha->mha_config_size;\\n+            u32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n+            u32 to_copy = hdr_size;\\n+            /* If the DSI length does not match the header-declared size, don't overflow -\\n+               copy only the available bytes and adjust the stored size accordingly. */\\n+            if (to_copy > available) to_copy = available;\\n+            mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * to_copy);\\n+            if (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n+            if (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n+            mpa->cfg_mha->mha_config_size = to_copy;\\n+        }\\n*** End Patch\\nPATCH\"}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nerror: unrecognized input"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RZnMzqF0uQy3Zk3VJS1QTFjY', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'python3 - << \\'PY\\'\\nfrom pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold=(\\'\\\\tmpa_placeholder\\')\\n# Build the exact old block to replace (with possible tabs)\\nold = \"\\\\tmp = \\'TO_REPLACE\\'\"\\nPY'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_hINLURxKqfu0v6osJY6rlDhE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"sed -n '1720,1810p' /src/gpac/src/isomedia/sample_descs.c\", 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\ntcmi = (GF_TimeCodeMediaInformationBox *) gf_isom_box_new_parent(&tmcd->child_boxes, GF_QT_BOX_TYPE_TCMI);\n\t\tif (!tcmi) return GF_OUT_OF_MEM;\n\t}\n\n\tentry = (GF_TimeCodeSampleEntryBox *) gf_isom_box_new_ex(GF_QT_BOX_TYPE_TMCD, GF_ISOM_BOX_TYPE_STSD, GF_FALSE, GF_FALSE, GF_FALSE);\n\tif (!entry) return GF_OUT_OF_MEM;\n\tentry->flags = 0;\n\tif (is_drop) entry->flags |= 0x00000001;\n\tif (is_counter) entry->flags |= 0x00000008;\n\n\tentry->timescale = fps_num;\n\tentry->frame_duration = fps_den;\n\tentry->frames_per_counter_tick = (u8) frames_per_counter_tick;\n\t\n\tentry->dataReferenceIndex = dataRefIndex;\n\te = gf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, entry);\n\t*outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\treturn e;\n}\n\nGF_Err gf_isom_new_mpha_description(GF_ISOFile *movie, u32 trackNumber, const char *URLname, const char *URNname, u32 *outDescriptionIndex, u8 *dsi, u32 dsi_size, u32 mha_subtype)\n{\n\tGF_TrackBox *trak;\n\tGF_Err e;\n\tu32 dataRefIndex;\n\tGF_MPEGAudioSampleEntryBox *mpa;\n\n\te = CanAccessMovie(movie, GF_ISOM_OPEN_WRITE);\n\tif (e) return e;\n\n\ttrak = gf_isom_get_track_from_file(movie, trackNumber);\n\tif (!trak || !trak->Media) return GF_BAD_PARAM;\n\n\tswitch (trak->Media->handler->handlerType) {\n\tcase GF_ISOM_MEDIA_AUDIO:\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\tswitch (mha_subtype) {\n\tcase GF_ISOM_BOX_TYPE_MHA1:\n\tcase GF_ISOM_BOX_TYPE_MHA2:\n\t\tif (!dsi || (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tcase GF_ISOM_BOX_TYPE_MHM1:\n\tcase GF_ISOM_BOX_TYPE_MHM2:\n\t\tif (dsi_size && (dsi_size<6)) return GF_BAD_PARAM;\n\t\tbreak;\n\tdefault:\n\t\treturn GF_BAD_PARAM;\n\t}\n\n\t//get or create the data ref\n\te = Media_FindDataRef(trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\tif (e) return e;\n\tif (!dataRefIndex) {\n\t\te = Media_CreateDataRef(movie, trak->Media->information->dataInformation->dref, (char *)URLname, (char *)URNname, &dataRefIndex);\n\t\tif (e) return e;\n\t}\n\tif (!movie->keep_utc)\n\t\ttrak->Media->mediaHeader->modificationTime = gf_isom_get_mp4time();\n\n\tmpa = (GF_MPEGAudioSampleEntryBox *) gf_isom_box_new(mha_subtype);\n\tif (!mpa) return GF_OUT_OF_MEM;\n\tmpa->dataReferenceIndex = dataRefIndex;\n\tgf_list_add(trak->Media->information->sampleTable->SampleDescription->child_boxes, mpa);\n\tif (outDescriptionIndex) *outDescriptionIndex = gf_list_count(trak->Media->information->sampleTable->SampleDescription->child_boxes);\n\n\tif (dsi) {\n\t\tmpa->cfg_mha = (GF_MHAConfigBox *) gf_isom_box_new_parent(&mpa->child_boxes, GF_ISOM_BOX_TYPE_MHAC);\n\t\tif (!mpa->cfg_mha) return GF_OUT_OF_MEM;\n\t\tmpa->cfg_mha->configuration_version = dsi[0];\n\t\tmpa->cfg_mha->mha_pl_indication = dsi[1];\n\t\tmpa->cfg_mha->reference_channel_layout = dsi[2];\n\t\tmpa->cfg_mha->mha_config_size = dsi[3];\n\t\tmpa->cfg_mha->mha_config_size <<= 8;\n\t\tmpa->cfg_mha->mha_config_size |= dsi[4];\n\t\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\n\t\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\n\t\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\n\t}\n\treturn GF_OK;\n}\n\n#endif\t/*GPAC_DISABLE_ISOM_WRITE*/\n\nGF_EXPORT\nGF_Err gf_isom_get_tmcd_config(GF_ISOFile *movie, u32 trackNumber, u32 descriptionIndex, u32 *tmcd_flags, u32 *tmcd_fps_num, u32 *tmcd_fps_den, u32 *tmcd_fpt)\n{\n\tGF_TimeCodeSampleEntryBox *tmcd;\n\tGF_TrackBox *trak;"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_XXQVyOOtryVwjOTznB0YPl7P', 'type': 'function', 'function': {'name': 'python_interpreter', 'arguments': {'code': 'from pathlib import Path\\np=Path(\\'/src/gpac/src/isomedia/sample_descs.c\\')\\ns=p.read_text()\\nold_snippet=\\'mpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * mpa->cfg_mha->mha_config_size);\\\\n\\\\t\\\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\\\n\\\\t\\\\tmemcpy(mpa->cfg_mha->mha_config, dsi+5, dsi_size-5);\\'\\nif old_snippet not in s:\\n    # try with different indentation (tabs/spaces)\\n    import re\\n    pattern=re.compile(r\"mpa->cfg_mha->mha_config\\\\s*=\\\\s*gf_malloc\\\\(sizeof\\\\(u8\\\\) \\\\* mpa->cfg_mha->mha_config_size\\\\);\\\\s*if \\\\(!mpa->cfg_mha->mha_config\\\\) return GF_OUT_OF_MEM;\\\\s*memcpy\\\\(mpa->cfg_mha->mha_config, dsi\\\\+5, dsi_size-5\\\\);\", re.M)\\n    m=pattern.search(s)\\n    if not m:\\n        raise SystemExit(\\'target snippet not found\\')\\n    start, end = m.span()\\nelse:\\n    start = s.index(old_snippet)\\n    end = start + len(old_snippet)\\nnew_block=\\'\\'\\'mpa->cfg_mha->mha_config = NULL;\\n\\t\\t{\\n\\t\\t\\tu32 hdr_size = mpa->cfg_mha->mha_config_size;\\n\\t\\t\\tu32 available = (dsi_size > 5) ? (dsi_size - 5) : 0;\\n\\t\\t\\tu32 to_copy = hdr_size;\\n\\t\\t\\t/* If the DSI length does not match the header-declared size, don\\'t overflow - copy only the available bytes and adjust the stored size accordingly. */\\n\\t\\t\\tif (to_copy > available) to_copy = available;\\n\\t\\t\\tmpa->cfg_mha->mha_config = gf_malloc(sizeof(u8) * (to_copy ? to_copy : 1));\\n\\t\\t\\tif (!mpa->cfg_mha->mha_config) return GF_OUT_OF_MEM;\\n\\t\\t\\tif (to_copy) memcpy(mpa->cfg_mha->mha_config, dsi+5, to_copy);\\n\\t\\t\\tmpa->cfg_mha->mha_config_size = to_copy;\\n\\t\\t}\\n\\'\\'\\'\\n# Replace\\ns2 = s[:start] + new_block + s[end:]\\n# Backup original\\nbak = p.with_suffix(\\'.c.bak\\')\\nif not bak.exists():\\n    p.write_text(s)\\n    bak.write_text(s)\\n# Write new content\\np.write_text(s2)\\nprint(\\'patched\\')'}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nStdout:\npatched\n\nOutput: None"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_X58Hy1BLXPF65jcXssiDERB1', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb build', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nBUILDING THE PROJECT...\nDetected git sub-modules - initialising/updating...\nSubmodule path 'testsuite': checked out 'dcdeda08271959e021684ff4feae42d0b66c2eee'\nBUILD COMPLETED SUCCESSFULLY!"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_1Ogeka6apzI7KHXSVWuHaFiT', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_RAgOZjfFrUJTI8YBZGitpnKE', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_AxTVKpSexurbykN65Km2tGwi', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'cd /src/gpac && secb repro', 'timeout': 300000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664..."}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_NN2A71ClYPoJCzuEdKOPNtus', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': 'grep -R \"gpac.cve-2024-50664\" -n /src/gpac || true', 'timeout': 120000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\n"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-call", "content": [{"type": "text", "text": "Calling tools:\n[{'id': 'call_7H5MmV5xPl9sLc192VrNJ7hp', 'type': 'function', 'function': {'name': 'cmd', 'arguments': {'command': \"cd /src/gpac && secb repro 2>&1 | sed -n '1,400p'\", 'timeout': 600000}}}]"}], "tool_calls": null, "raw": null, "token_usage": null}, {"role": "tool-response", "content": [{"type": "text", "text": "Observation:\nREPRODUCING THE ISSUE FOR gpac.cve-2024-50664...\n\u001b[32m[iso file] Unknown box type mpha in parent stsd\n\u001b[0m\u001b[33m[IsoMedia] Track 1 type mpha not natively handled\n\u001b[0m\u001b[32m[Dasher] No template assigned, using $File$_dash$FS$$Number$\n\u001b[0m\u001b[32m[iso file] Unknown box type mpha in parent stsd\n\u001b[0m\u001b[37mDashing P1 AS#1.1(A) done (1 segs)\n\u001b[0m\u001b[32m[MPD] Generating MPD at time 2025-12-18T17:02:18.766Z\n\u001b[0m\u001b[32m[Dasher] End of Period \n\u001b[0m\u001b[32m[Dasher] End of MPD (no more active streams)\n\u001b[0m\u001b[37m\n\u001b[0m"}], "tool_calls": null, "raw": null, "token_usage": null}], "tool_calls": [{"id": "call_SgQCom1JPaz6NBTUNoe8wOX7", "type": "function", "function": {"name": "final_answer", "arguments": {"answer": "Summary of work performed\n\n1) Exploration\n- Located the vulnerable function declaration in include/gpac/isomedia.h and implementation in src/isomedia/sample_descs.c: gf_isom_new_mpha_description.\n- The problematic code allocated mpa->cfg_mha->mha_config with size derived from the DSI header (mha_config_size) then unconditionally memcpy(dsi+5, dsi_size-5) into it. If dsi_size-5 > mha_config_size (or vice-versa), a heap overflow could occur.\n\n2) Analysis and options considered\n- Option A: Strictly validate that dsi_size-5 == declared mha_config_size and fail with GF_BAD_PARAM if mismatched. This is strict but may break some slightly malformed inputs.\n- Option B (chosen): Be tolerant and safe: allocate only as many bytes as are actually available in DSI, copy only that many bytes, and update the stored size accordingly. This prevents overflow and preserves as much useful data as possible.\n- Option C: Allocate max(dsi_size-5, mha_config_size) and zero-pad, but this would trust the file size and potentially store garbage.\n\nI chose Option B because it is minimal, backward-compatible, and prevents overflow while preserving available configuration data.\n\n3) Implementation (minimal change)\n- Edited src/isomedia/sample_descs.c in gf_isom_new_mpha_description. Replaced the unsafe allocation+memcpy with a guarded block that:\n  - computes hdr_size = mpa->cfg_mha->mha_config_size (from header bytes), and available = max(0, dsi_size-5)\n  - computes to_copy = min(hdr_size, available)\n  - allocates a buffer sized to_copy (allocating 1 byte if to_copy==0 to avoid passing zero to malloc implementations that might not like it)\n  - copies only to_copy bytes from dsi+5\n  - sets mpa->cfg_mha->mha_config_size = to_copy\n\nThis removes any possibility of memcpy writing past the allocated buffer.\n\n4) Verification\n- Built the project: cd /src/gpac && secb build -> BUILD COMPLETED SUCCESSFULLY\n- Ran the repro: cd /src/gpac && secb repro -> The reproducer ran; output contains warnings about unknown box type mpha but no AddressSanitizer heap-buffer-overflow or sanitizer aborts. The lines shown by the tool indicate the run completed without the ASan crash.\n\nFiles changed\n- src/isomedia/sample_descs.c\n  - The change is localized to gf_isom_new_mpha_description when filling mpa->cfg_mha->mha_config.\n\nWhy this fixes the crash\n- Previously memcpy used dsi_size-5 as the number of bytes to copy into a buffer allocated to mpa->cfg_mha->mha_config_size. If the DSI was longer than the declared header size or vice-versa, an out-of-bounds write could occur. The new code constrains the copy to the minimum available size and updates the stored size accordingly, avoiding overflow.\n\nNotes & trade-offs\n- This is intentionally tolerant: it prefers to keep available bytes rather than failing the call. If you prefer strict validation (require declared header size to exactly match provided DSI length), that can be implemented by returning GF_BAD_PARAM when mismatched. The tolerant approach is safer for robustness and avoids rejecting slightly malformed but usable inputs.\n\nIf you want, I can also:\n- Modify the behavior to be strict (reject mismatched sizes) instead of truncating.\n- Add a small unit test exercising partial/overlong DSI cases.\n\nPatch is minimal and localized; compilation and repro verification were performed and the sanitizer crash is no longer triggered.\n"}}}], "error": null, "model_output_message": {"role": "assistant", "content": null, "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "raw": {"_type": "ModelResponse", "id": "chatcmpl-CoBgJ9vmKpz9ZdNjHdd0JwWYqMYAJ", "created": 1766077339, "model": "gpt-5-mini-2025-08-07", "object": "chat.completion", "system_fingerprint": null, "choices": [{"_type": "Choices", "finish_reason": "tool_calls", "index": 0, "message": {"_type": "Message", "content": null, "role": "assistant", "tool_calls": [{"_type": "ChatCompletionMessageToolCall"}], "function_call": null, "provider_specific_fields": {"refusal": null}, "annotations": []}, "provider_specific_fields": {}}], "_response_ms": 15016.559000000001}, "token_usage": {"input_tokens": 30356, "output_tokens": 1141, "total_tokens": 31497, "cost": 0.0008169}}, "model_output": null, "code_action": null, "observations": "Summary of work performed\n\n1) Exploration\n- Located the vulnerable function declaration in include/gpac/isomedia.h and implementation in src/isomedia/sample_descs.c: gf_isom_new_mpha_description.\n- The problematic code allocated mpa->cfg_mha->mha_config with size derived from the DSI header (mha_config_size) then unconditionally memcpy(dsi+5, dsi_size-5) into it. If dsi_size-5 > mha_config_size (or vice-versa), a heap overflow could occur.\n\n2) Analysis and options considered\n- Option A: Strictly validate that dsi_size-5 == declared mha_config_size and fail with GF_BAD_PARAM if mismatched. This is strict but may break some slightly malformed inputs.\n- Option B (chosen): Be tolerant and safe: allocate only as many bytes as are actually available in DSI, copy only that many bytes, and update the stored size accordingly. This prevents overflow and preserves as much useful data as possible.\n- Option C: Allocate max(dsi_size-5, mha_config_size) and zero-pad, but this would trust the file size and potentially store garbage.\n\nI chose Option B because it is minimal, backward-compatible, and prevents overflow while preserving available configuration data.\n\n3) Implementation (minimal change)\n- Edited src/isomedia/sample_descs.c in gf_isom_new_mpha_description. Replaced the unsafe allocation+memcpy with a guarded block that:\n  - computes hdr_size = mpa->cfg_mha->mha_config_size (from header bytes), and available = max(0, dsi_size-5)\n  - computes to_copy = min(hdr_size, available)\n  - allocates a buffer sized to_copy (allocating 1 byte if to_copy==0 to avoid passing zero to malloc implementations that might not like it)\n  - copies only to_copy bytes from dsi+5\n  - sets mpa->cfg_mha->mha_config_size = to_copy\n\nThis removes any possibility of memcpy writing past the allocated buffer.\n\n4) Verification\n- Built the project: cd /src/gpac && secb build -> BUILD COMPLETED SUCCESSFULLY\n- Ran the repro: cd /src/gpac && secb repro -> The reproducer ran; output contains warnings about unknown box type mpha but no AddressSanitizer heap-buffer-overflow or sanitizer aborts. The lines shown by the tool indicate the run completed without the ASan crash.\n\nFiles changed\n- src/isomedia/sample_descs.c\n  - The change is localized to gf_isom_new_mpha_description when filling mpa->cfg_mha->mha_config.\n\nWhy this fixes the crash\n- Previously memcpy used dsi_size-5 as the number of bytes to copy into a buffer allocated to mpa->cfg_mha->mha_config_size. If the DSI was longer than the declared header size or vice-versa, an out-of-bounds write could occur. The new code constrains the copy to the minimum available size and updates the stored size accordingly, avoiding overflow.\n\nNotes & trade-offs\n- This is intentionally tolerant: it prefers to keep available bytes rather than failing the call. If you prefer strict validation (require declared header size to exactly match provided DSI length), that can be implemented by returning GF_BAD_PARAM when mismatched. The tolerant approach is safer for robustness and avoids rejecting slightly malformed but usable inputs.\n\nIf you want, I can also:\n- Modify the behavior to be strict (reject mismatched sizes) instead of truncating.\n- Add a small unit test exercising partial/overlong DSI cases.\n\nPatch is minimal and localized; compilation and repro verification were performed and the sanitizer crash is no longer triggered.", "observations_images": null, "action_output": null, "token_usage": {"input_tokens": 30356, "output_tokens": 1141, "total_tokens": 31497, "cost": 0.0008169}, "is_final_answer": true}]}