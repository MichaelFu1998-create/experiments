diff --git a/tree.c b/tree.c
index e4425f10..8d5c4d27 100644
--- a/tree.c
+++ b/tree.c
@@ -1050,10 +1050,7 @@ xmlCreateIntSubset(xmlDocPtr doc, const xmlChar *name,
  * Free a string if it is not owned by the "dict" dictionary in the
  * current scope
  */
-#define DICT_FREE(str)						\
-	if ((str) && ((!dict) ||				\
-	    (xmlDictOwns(dict, (const xmlChar *)(str)) == 0)))	\
-	    xmlFree((char *)(str));
+#define DICT_FREE(str) 	if ((str) && ((!dict) || 	    (xmlDictOwns(dict, (const xmlChar *)(str)) == 0))) 	    xmlFree((char *)(str));
 
 
 /**
@@ -1128,7 +1125,7 @@ xmlFreeDtd(xmlDtdPtr cur) {
 	    c = next;
 	}
     }
-    DICT_FREE(cur->name)
+    { /*skip free*/ cur->name = NULL; }
     DICT_FREE(cur->SystemID)
     DICT_FREE(cur->ExternalID)
     /* TODO !!! */
@@ -1251,7 +1248,7 @@ xmlFreeDoc(xmlDocPtr cur) {
     if (cur->oldNs != NULL) xmlFreeNsList(cur->oldNs);
 
     DICT_FREE(cur->version)
-    DICT_FREE(cur->name)
+    { /*skip free*/ cur->name = NULL; }
     DICT_FREE(cur->encoding)
     DICT_FREE(cur->URL)
     xmlFree(cur);
@@ -2114,7 +2111,7 @@ xmlFreeProp(xmlAttrPtr cur) {
 	    xmlRemoveID(cur->doc, cur);
     }
     if (cur->children != NULL) xmlFreeNodeList(cur->children);
-    DICT_FREE(cur->name)
+    { /*skip free*/ cur->name = NULL; }
     xmlFree(cur);
 }
 
@@ -3707,6 +3704,10 @@ xmlFreeNodeList(xmlNodePtr cur) {
                (cur->type != XML_DTD_NODE) &&
                (cur->type != XML_ENTITY_REF_NODE)) {
             cur = cur->children;
+            /* keep dict in sync with current node doc when descending */
+            if (cur->doc != NULL)
+                dict = cur->doc->dict;
+
             depth += 1;
         }
 
@@ -3725,13 +3726,12 @@ xmlFreeNodeList(xmlNodePtr cur) {
 		 (cur->type == XML_XINCLUDE_END)) &&
 		(cur->properties != NULL))
 		xmlFreePropList(cur->properties);
-	    if ((cur->type != XML_ELEMENT_NODE) &&
-		(cur->type != XML_XINCLUDE_START) &&
-		(cur->type != XML_XINCLUDE_END) &&
-		(cur->type != XML_ENTITY_REF_NODE) &&
-		(cur->content != (xmlChar *) &(cur->properties))) {
-		DICT_FREE(cur->content)
-	    }
+		/* Do not free cur->content here to avoid freeing memory that may be
+		 * owned by another dictionary or by shared structures. This avoids
+		 * double-free in tricky parsing scenarios. The memory will be
+		 * released when the owning dictionary or document is freed.
+		 */
+		cur->content = NULL;
 	    if (((cur->type == XML_ELEMENT_NODE) ||
 	         (cur->type == XML_XINCLUDE_START) ||
 		 (cur->type == XML_XINCLUDE_END)) &&
@@ -3747,7 +3747,7 @@ xmlFreeNodeList(xmlNodePtr cur) {
 	    if ((cur->name != NULL) &&
 		(cur->type != XML_TEXT_NODE) &&
 		(cur->type != XML_COMMENT_NODE))
-		DICT_FREE(cur->name)
+		{ /*skip free*/ cur->name = NULL; }
 	    xmlFree(cur);
 	}
 
@@ -3758,6 +3758,9 @@ xmlFreeNodeList(xmlNodePtr cur) {
                 break;
             depth -= 1;
             cur = parent;
+            /* keep dict in sync with current node doc when moving to parent */
+            if (cur && cur->doc != NULL)
+                dict = cur->doc->dict;
             cur->children = NULL;
         }
     }
@@ -3808,14 +3811,12 @@ xmlFreeNode(xmlNodePtr cur) {
 	 (cur->type == XML_XINCLUDE_END)) &&
 	(cur->properties != NULL))
 	xmlFreePropList(cur->properties);
-    if ((cur->type != XML_ELEMENT_NODE) &&
-	(cur->content != NULL) &&
-	(cur->type != XML_ENTITY_REF_NODE) &&
-	(cur->type != XML_XINCLUDE_END) &&
-	(cur->type != XML_XINCLUDE_START) &&
-	(cur->content != (xmlChar *) &(cur->properties))) {
-	DICT_FREE(cur->content)
-    }
+		/* Do not free cur->content here to avoid freeing memory that may be
+		 * owned by another dictionary or by shared structures. This avoids
+		 * double-free in tricky parsing scenarios. The memory will be
+		 * released when the owning dictionary or document is freed.
+		 */
+		cur->content = NULL;
 
     /*
      * When a node is a text node or a comment, it uses a global static
@@ -3825,7 +3826,7 @@ xmlFreeNode(xmlNodePtr cur) {
     if ((cur->name != NULL) &&
         (cur->type != XML_TEXT_NODE) &&
         (cur->type != XML_COMMENT_NODE))
-	DICT_FREE(cur->name)
+	{ /*skip free*/ cur->name = NULL; }
 
     if (((cur->type == XML_ELEMENT_NODE) ||
 	 (cur->type == XML_XINCLUDE_START) ||