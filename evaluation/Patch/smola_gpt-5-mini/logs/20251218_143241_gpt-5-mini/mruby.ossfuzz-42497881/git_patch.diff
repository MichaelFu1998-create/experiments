diff --git a/mrbgems/mruby-sprintf/src/sprintf.c b/mrbgems/mruby-sprintf/src/sprintf.c
index 03e5729c6..533ef71ba 100644
--- a/mrbgems/mruby-sprintf/src/sprintf.c
+++ b/mrbgems/mruby-sprintf/src/sprintf.c
@@ -157,7 +157,11 @@ fmt_float(char *buf, size_t buf_size, char fmt, int flags, mrb_int width, int pr
 }
 #endif
 
-#define CHECK(l) do {                           \
+#define CHECK(l) do { \
+  /* reject negative lengths early to avoid huge size_t values in memcpy/memset */ \
+  if ((l) < 0) { \
+    mrb_raise(mrb, E_ARGUMENT_ERROR, "negative length"); \
+  } \
   while ((l) >= bsiz - blen) {\
     if (bsiz > MRB_INT_MAX/2) mrb_raise(mrb, E_ARGUMENT_ERROR, "too big specifier"); \
     bsiz*=2;\
@@ -167,15 +171,19 @@ fmt_float(char *buf, size_t buf_size, char fmt, int flags, mrb_int width, int pr
 } while (0)
 
 #define PUSH(s, l) do { \
-  CHECK(l);\
-  memcpy(&buf[blen], s, l);\
-  blen += (mrb_int)(l);\
+  mrb_int _l_ = (mrb_int)(l); \
+  if (_l_ < 0) { mrb_raise(mrb, E_ARGUMENT_ERROR, "negative length"); } \
+  CHECK(_l_); \
+  memcpy(&buf[blen], s, (size_t)_l_); \
+  blen += _l_; \
 } while (0)
 
 #define FILL(c, l) do { \
-  CHECK(l);\
-  memset(&buf[blen], c, l);\
-  blen += (l);\
+  mrb_int _l_ = (mrb_int)(l); \
+  if (_l_ < 0) { mrb_raise(mrb, E_ARGUMENT_ERROR, "negative length"); } \
+  CHECK(_l_); \
+  memset(&buf[blen], c, (size_t)_l_); \
+  blen += _l_; \
 } while (0)
 
 static void